<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í—Ö–æ–¥ | –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #042F28 0%, #0A5C4A 100%);
            --accent: #D0E41E;
            --text: white;
            --card-bg: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.9);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { 
            background: var(--primary-bg); 
            color: var(--text); 
            min-height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 20px; 
        }
        .login-box { 
            background: var(--card-bg); 
            border-radius: 15px; 
            padding: 40px; 
            width: 100%; 
            max-width: 400px; 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(10px); 
            text-align: center; 
        }
        .logo { font-size: 28px; font-weight: bold; color: var(--accent); margin-bottom: 10px; }
        .input-group { margin: 20px 0; text-align: left; position: relative; }
        label { display: block; margin-bottom: 8px; color: var(--accent); font-weight: bold; }
        input { 
            width: 100%; 
            padding: 12px 15px; 
            padding-right: 45px;
            background: var(--input-bg); 
            border: 2px solid #34495e; 
            border-radius: 8px; 
            color: #2c3e50; 
            font-size: 16px; 
            transition: border 0.3s;
        }
        input:focus { 
            outline: none; 
            border-color: var(--accent); 
            background: white; 
        }
        .password-toggle {
            position: absolute;
            right: 15px;
            top: 40px;
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .password-toggle:hover { color: #34495e; }
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 15px 0 25px;
            gap: 10px;
        }
        .checkbox-group input[type="checkbox"] { width: auto; transform: scale(1.2); }
        .checkbox-group label { margin: 0; font-weight: normal; color: var(--text); cursor: pointer; }
        button { 
            width: 100%; 
            padding: 15px; 
            background: var(--accent); 
            color: #2c3e50; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: all 0.3s; 
        }
        button:hover { background: #b8cc1a; transform: translateY(-2px); }
        button:disabled { background: #7f8c8d; cursor: not-allowed; transform: none; }
        .error { 
            background: rgba(231, 76, 60, 0.15); 
            border: 1px solid #e74c3c; 
            border-radius: 8px; 
            padding: 12px; 
            margin: 15px 0; 
            color: #e74c3c; 
            display: none; 
            text-align: left;
        }
        .error.show { display: block; }
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 480px) { .login-box { padding: 30px 20px; } }
    </style>
</head>
<body>
    <div class="login-box">
        <div class="logo">üîê –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
        <p>–ü–ª–∞—Ç—ë–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</p>
        
        <div class="error" id="errorMsg"></div>
        
        <div class="input-group">
            <label for="username">–õ–æ–≥–∏–Ω</label>
            <input type="text" id="username" placeholder="superadmin" autocomplete="username">
        </div>
        
        <div class="input-group">
            <label for="password">–ü–∞—Ä–æ–ª—å</label>
            <input type="password" id="password" placeholder="admin123" autocomplete="current-password">
            <button type="button" class="password-toggle" id="togglePassword">üëÅÔ∏è</button>
        </div>
        
        <div class="checkbox-group">
            <input type="checkbox" id="rememberMe">
            <label for="rememberMe">–ó–∞–ø–æ–º–Ω–∏—Ç—å –º–µ–Ω—è</label>
        </div>
        
        <button onclick="login()" id="loginBtn">–í–æ–π—Ç–∏</button>
    </div>

    <script>
        // –ü–†–û–ö–°–ò –î–õ–Ø –û–ë–•–û–î–ê CORS (–ø—Ä–æ—Å—Ç–æ–π –º–µ—Ç–æ–¥)
        const API_URL = 'https://script.google.com/macros/s/AKfycbxDaBdYMx44M2W3FsJp5tOECFTRD6rWrhPAC96MuUexROt5Qjgj4U0er4So6Ehsh8xQ5g/exec';
        
        document.addEventListener('DOMContentLoaded', function() {
            const savedData = localStorage.getItem('saved_login');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    document.getElementById('username').value = data.username || '';
                    document.getElementById('password').value = data.password || '';
                    document.getElementById('rememberMe').checked = true;
                } catch (e) {
                    localStorage.removeItem('saved_login');
                }
            }
            
            const toggleBtn = document.getElementById('togglePassword');
            const passwordInput = document.getElementById('password');
            
            toggleBtn.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                toggleBtn.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üëÅÔ∏è‚Äçüó®Ô∏è';
            });
            
            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
        });
        
        // –ù–û–í–´–ô –ú–ï–¢–û–î: –ò—Å–ø–æ–ª—å–∑—É–µ–º JSONP –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const rememberMe = document.getElementById('rememberMe').checked;
            const btn = document.getElementById('loginBtn');
            const error = document.getElementById('errorMsg');
            
            if (!username || !password) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> –í—Ö–æ–¥...';
            error.classList.remove('show');
            
            // –ú–µ—Ç–æ–¥ 1: –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ XMLHttpRequest —Å —Ä–µ–∂–∏–º–æ–º no-cors
            loginWithXMLHttpRequest(username, password, rememberMe, btn, error);
        }
        
        function loginWithXMLHttpRequest(username, password, rememberMe, btn, error) {
            const url = `${API_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
            
            console.log('–ü—Ä–æ–±—É–µ–º XMLHttpRequest –∫:', url);
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            
            // –í–∞–∂–Ω–æ: –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
            xhr.timeout = 10000; // 10 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç
            
            xhr.onload = function() {
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', xhr.status);
                
                if (xhr.status >= 200 && xhr.status < 300) {
                    try {
                        const responseText = xhr.responseText;
                        console.log('–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:', responseText);
                        
                        // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –º–µ—Ç–æ–¥—ã –ø–∞—Ä—Å–∏–Ω–≥–∞
                        let result;
                        try {
                            result = JSON.parse(responseText);
                        } catch (e) {
                            // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ JSON, –º–æ–∂–µ—Ç –±—ã—Ç—å HTML –∏–ª–∏ —Ç–µ–∫—Å—Ç
                            if (responseText.includes('token') || responseText.includes('success')) {
                                // –ü—Ä–æ–±—É–µ–º –∏–∑–≤–ª–µ—á—å JSON –∏–∑ —Ç–µ–∫—Å—Ç–∞
                                const jsonMatch = responseText.match(/\{.*\}/);
                                if (jsonMatch) {
                                    result = JSON.parse(jsonMatch[0]);
                                } else {
                                    result = { success: false, error: '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞' };
                                }
                            } else {
                                result = { success: false, error: '–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –Ω–µ JSON' };
                            }
                        }
                        
                        handleLoginResult(result, username, password, rememberMe, btn, error);
                        
                    } catch (parseError) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', parseError);
                        showError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                        btn.disabled = false;
                        btn.textContent = '–í–æ–π—Ç–∏';
                    }
                } else {
                    console.error('HTTP –æ—à–∏–±–∫–∞:', xhr.status);
                    
                    // –ú–µ—Ç–æ–¥ 2: –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ iframe (JSONP-–ø–æ–¥—Ö–æ–¥)
                    loginWithIframe(username, password, rememberMe, btn, error);
                }
            };
            
            xhr.onerror = function() {
                console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ XMLHttpRequest');
                // –ú–µ—Ç–æ–¥ 2: –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ iframe (JSONP-–ø–æ–¥—Ö–æ–¥)
                loginWithIframe(username, password, rememberMe, btn, error);
            };
            
            xhr.ontimeout = function() {
                console.error('–¢–∞–π–º–∞—É—Ç XMLHttpRequest');
                loginWithIframe(username, password, rememberMe, btn, error);
            };
            
            xhr.send();
        }
        
        function loginWithIframe(username, password, rememberMe, btn, error) {
            console.log('–ü—Ä–æ–±—É–µ–º –º–µ—Ç–æ–¥ iframe...');
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π iframe –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.name = 'loginFrame';
            
            // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
            const form = document.createElement('form');
            form.target = 'loginFrame';
            form.method = 'GET';
            form.action = API_URL;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è
            const actionInput = document.createElement('input');
            actionInput.type = 'hidden';
            actionInput.name = 'action';
            actionInput.value = 'login';
            form.appendChild(actionInput);
            
            const userInput = document.createElement('input');
            userInput.type = 'hidden';
            userInput.name = 'username';
            userInput.value = username;
            form.appendChild(userInput);
            
            const passInput = document.createElement('input');
            passInput.type = 'hidden';
            passInput.name = 'password';
            passInput.value = password;
            form.appendChild(passInput);
            
            // –î–æ–±–∞–≤–ª—è–µ–º callback –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
            window.handleLoginCallback = function(result) {
                console.log('Callback —Ä–µ–∑—É–ª—å—Ç–∞—Ç:', result);
                handleLoginResult(result, username, password, rememberMe, btn, error);
                
                // –û—á–∏—Å—Ç–∫–∞
                document.body.removeChild(iframe);
                document.body.removeChild(form);
                delete window.handleLoginCallback;
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º callback –ø–∞—Ä–∞–º–µ—Ç—Ä
            const callbackInput = document.createElement('input');
            callbackInput.type = 'hidden';
            callbackInput.name = 'callback';
            callbackInput.value = 'handleLoginCallback';
            form.appendChild(callbackInput);
            
            document.body.appendChild(iframe);
            document.body.appendChild(form);
            form.submit();
            
            // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ callback –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
            setTimeout(function() {
                if (btn.disabled) {
                    showError('–¢–∞–π–º–∞—É—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                    btn.disabled = false;
                    btn.textContent = '–í–æ–π—Ç–∏';
                    
                    // –ú–µ—Ç–æ–¥ 3: –ü—Ä—è–º–æ–π –ø–µ—Ä–µ—Ö–æ–¥ (–ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞)
                    setTimeout(function() {
                        window.location.href = `${API_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;
                    }, 1000);
                }
            }, 5000);
        }
        
        function handleLoginResult(result, username, password, rememberMe, btn, error) {
            console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ö–æ–¥–∞:', result);
            
            if (result && result.success && result.token) {
                if (rememberMe) {
                    localStorage.setItem('saved_login', JSON.stringify({ username, password }));
                } else {
                    localStorage.removeItem('saved_login');
                }
                
                localStorage.setItem('admin_token', result.token);
                localStorage.setItem('admin_user', JSON.stringify(result.user || {}));
                localStorage.setItem('admin_permissions', JSON.stringify(result.permissions || {}));
                
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ dashboard
                window.location.href = 'dashboard.html';
            } else {
                showError(result?.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
                btn.disabled = false;
                btn.textContent = '–í–æ–π—Ç–∏';
            }
        }
        
        function showError(message) {
            const error = document.getElementById('errorMsg');
            error.textContent = message;
            error.classList.add('show');
        }
        
        // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function testConnection() {
            const testUrl = `${API_URL}?action=test&callback=testCallback`;
            
            window.testCallback = function(result) {
                console.log('–¢–µ—Å—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', result);
                delete window.testCallback;
            };
            
            const script = document.createElement('script');
            script.src = testUrl;
            document.head.appendChild(script);
            setTimeout(() => {
                if (script.parentNode) {
                    document.head.removeChild(script);
                }
            }, 5000);
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', testConnection);
    </script>
</body>
</html>
