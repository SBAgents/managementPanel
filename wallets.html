<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Кошельки | Панель управления</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    <link rel="preconnect" href="https://script.google.com">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #042F28 0%, #0A5C4A 100%);
            --accent: #D0E41E;
            --accent-hover: #b8cc1a;
            --text: white;
            --card-bg: rgba(255, 255, 255, 0.1);
            --sidebar-bg: rgba(0, 0, 0, 0.3);
            --danger: #e74c3c;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #3498db;
            /*--tutorial-overlay: rgba(4, 47, 40, 0.85);*/
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: var(--primary-bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            position: relative;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            z-index: 800;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-content {
            flex: 1;
        }
        
        .logo h1 {
            font-size: 24px;
            color: var(--accent);
        }
        
        .logo p {
            font-size: 14px;
            opacity: 0.8;
        }
        
        .burger-menu {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        
        .nav-links {
            flex: 1;
            overflow-y: auto;
        }
        
        .nav-links a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: var(--text);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
            position: relative;
            z-inex: 2001;
        }
        
        .nav-links a:hover {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--accent);
        }
        
        .nav-links a.active {
            background: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--accent);
        }
        
        .nav-links a i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }
        
        /* User Info */
        .user-info {
            padding: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            margin-top: auto;
        }
        
        .user-details {
            margin-bottom: 10px;
        }
        
        .user-details h3 {
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-details .username {
            font-weight: bold;
        }
        
        .user-details .role {
            font-size: 12px;
            opacity: 0.7;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .user-controls {
            display: flex;
            gap: 10px;
        }
        
        .user-control-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .language-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .language-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .logout-btn {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #ff6b6b;
        }
        
        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.3);
        }
        
        .logout-btn.loading, .language-btn.loading {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        /* Language Selector */
        .language-selector {
            position: relative;
        }
        
        .language-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.95);
            border-radius: 8px;
            margin-bottom: 5px;
            display: none;
            overflow: hidden;
            z-index: 100;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 12px;
            text-align: center;
        }
        
        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            position: relative;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .header h2 {
            font-size: 28px;
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
        }
        
        .btn-primary {
            background: var(--accent);
            color: #2c3e50;
        }
        
        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        btn-secondaryTest {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .btn:disabled, .btn.loading {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Filter Section */
        .filter-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            z-index: 2;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .filter-select, .filter-input {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #34495e;
            border-radius: 8px;
            color: #2c3e50;
            font-size: 14px;
            position: relative;
            z-index: 3;
        }
        
        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
        }
        
        /* Wallets Table Container */
        .table-section-container {
            position: relative;
            min-height: 400px;
        }
        
        /* Wallets Table */
        .section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            min-height: 400px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
            z-index: 2;
        }
        
        .section-header h3 {
            font-size: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            position: relative;
            min-height: 200px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(255, 255, 255, 0.05);
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.active {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .status.inactive {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }
        
        .action-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
            margin-right: 5px;
            position: relative;
        }
        
        .action-btn.edit {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .action-btn.edit:hover {
            background: rgba(52, 152, 219, 0.3);
        }
        
        .action-btn.toggle {
            background: rgba(243, 156, 18, 0.2);
            color: #f39c12;
            border: 1px solid rgba(243, 156, 18, 0.3);
        }
        
        .action-btn.toggle:hover {
            background: rgba(243, 156, 18, 0.3);
        }
        
        .action-btn.delete {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }
        
        .action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.3);
        }
        
        /* Loader */
        .loader {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid var(--accent);
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Table Loader */
        .table-loader {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(4, 47, 40, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 12px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .table-loader.show {
            opacity: 1;
            visibility: visible;
            z-index: 3;
        }
        
        .table-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-overlay.show .modal {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            font-size: 20px;
            color: var(--accent);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            opacity: 0.9;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #34495e;
            border-radius: 8px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.9);
            border-left: 4px solid var(--accent);
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast i {
            font-size: 20px;
        }
        
        .toast.success i { color: #2ecc71; }
        .toast.error i { color: #e74c3c; }
        .toast.warning i { color: #f39c12; }
        .toast.info i { color: #3498db; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        /* Mobile Header */
        .mobile-header {
            display: none;
            background: var(--sidebar-bg);
            padding: 15px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 4;
        }
        
        .mobile-logo h2 {
            font-size: 20px;
            color: var(--accent);
            z-index: 2;
        }
        
        /* Tutorial Overlay - ОБНОВЛЁННЫЙ СТИЛЬ */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1; /* Ниже подсветки и попапа */
            display: none;
            pointer-events: none;
            /*background: rgba(4, 47, 40, 0.6); /* Только лёгкая затемнённая подложка */
        }
        
        .tutorial-overlay.active {
            display: block;
        }
        
        /* Убираем блюр с самого оверлея */
        .tutorial-overlay::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            backdrop-filter: blur(2px); /* Только лёгкий блюр */
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
        }
        
        /* Подсветка элемента - ВЫШЕ всего */
        .tutorial-highlight {
            position: absolute;
            border: 3px solid var(--accent);
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(208, 228, 30, 0.8),
                        0 0 60px rgba(208, 228, 30, 0.4),
                        inset 0 0 20px rgba(208, 228, 30, 0.3);
            z-index: 2003; /* Выше попапа и оверлея */
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: pulse 2s infinite ease-in-out;
            background: rgba(4, 47, 40, 0.1); /* Полупрозрачный фон */
            mix-blend-mode: normal;
        }
        
        /* Убираем тёмный фон вокруг подсветки */
        .tutorial-highlight::before {
            content: '';
            position: absolute;
            top: -15px;
            left: -15px;
            right: -15px;
            bottom: -15px;
            background: transparent;
            z-index: -1;
            border-radius: 20px;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 20px rgba(208, 228, 30, 0.6),
                            0 0 40px rgba(208, 228, 30, 0.4),
                            inset 0 0 20px rgba(208, 228, 30, 0.3);
                border-color: var(--accent);
                transform: scale(1);
            }
            50% {
                box-shadow: 0 0 30px rgba(208, 228, 30, 0.9),
                            0 0 60px rgba(208, 228, 30, 0.6),
                            inset 0 0 30px rgba(208, 228, 30, 0.4);
                border-color: #e8f542;
                transform: scale(1.01);
            }
            100% {
                box-shadow: 0 0 20px rgba(208, 228, 30, 0.6),
                            0 0 40px rgba(208, 228, 30, 0.4),
                            inset 0 0 20px rgba(208, 228, 30, 0.3);
                border-color: var(--accent);
                transform: scale(1);
            }
        }
        
        .tutorial-popup {
            position: absolute;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.98), rgba(250, 250, 250, 0.98));
            color: #2c3e50;
            border-radius: 16px;
            padding: 25px;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.9);
            z-index: 2002; /* Выше оверлея, но ниже подсветки */
            animation: slideIn 0.4s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            pointer-events: none;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .tutorial-popup h3 {
            color: var(--accent);
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .tutorial-popup p {
            margin-bottom: 20px;
            line-height: 1.6;
            color: #4a5568;
            font-size: 15px;
        }
        
        .tutorial-popup .tutorial-progress {
            font-size: 12px;
            color: #718096;
            margin-bottom: 15px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }
        
        .tutorial-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        
        .tutorial-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            min-width: 80px;
            text-align: center;
            pointer-events: auto;
        }
        
        .tutorial-btn-primary {
            background: linear-gradient(145deg, var(--accent), var(--accent-hover));
            color: #2c3e50;
            box-shadow: 0 4px 12px rgba(208, 228, 30, 0.3);
        }
        
        .tutorial-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(208, 228, 30, 0.4);
        }
        
        .tutorial-btn-secondary {
            background: linear-gradient(145deg, #f7fafc, #edf2f7);
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }
        
        .tutorial-btn-secondary:hover {
            background: linear-gradient(145deg, #edf2f7, #e2e8f0);
            transform: translateY(-2px);
        }
        
        .tutorial-close-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            color: #718096;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            pointer-events: auto;
        }
        
        .tutorial-close-btn:hover {
            background: white;
            color: #2d3748;
            transform: rotate(90deg);
        }
        
        /* Help Button */
        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--accent);
            color: #2c3e50;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed;
                left: -250px;
                top: 0;
                bottom: 0;
                z-index: 4;
                transition: left 0.3s ease;
            }
            
            .sidebar.mobile-open {
                left: 0;
                z-index: 4;
            }
            
            .burger-menu {
                display: block;
                z-index: 2;
            }
            
            .mobile-header {
                display: flex;
            }
            
            .main-content {
                margin-top: 70px;
                padding: 20px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
                z-index: 2;
            }
            
            .header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .btn {
                padding: 12px;
                flex: 1;
            }
            
            .section {
                padding: 20px;
            }
            
            .table-loader {
                border-radius: 12px;
            }
            
            .tutorial-popup {
                max-width: 90%;
                margin: 0 20px;
            }
        }
        
        @media (max-width: 768px) {
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 5px;
            }
            
            .action-btn {
                padding: 4px 8px;
                font-size: 10px;
                margin-right: 3px;
            }
            
            .modal {
                padding: 20px;
                width: 95%;
            }
            
            .form-control {
                padding: 10px;
            }
            
            .tutorial-popup {
                padding: 20px;
            }
        }
        
        @media (max-width: 480px) {
            .header-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .user-controls {
                flex-direction: column;
            }
            
            .section {
                min-height: 350px;
                padding: 15px;
            }
            
            .table-loader {
                border-radius: 12px;
            }
            
            .tutorial-actions {
                flex-direction: column;
            }
            
            .tutorial-btn {
                width: 100%;
            }
        }
        
        /* RTL Support */
        body[dir="rtl"] .nav-links a i {
            margin-right: 0;
            margin-left: 12px;
        }
        
        body[dir="rtl"] .sidebar {
            border-right: none;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        body[dir="rtl"] .language-dropdown {
            right: 0;
            left: auto;
        }
        
        body[dir="rtl"] td, body[dir="rtl"] th {
            text-align: right;
        }
        
        /* Performance optimizations */
        .table-container {
            will-change: transform;
        }
        
        .table-loader {
            will-change: opacity;
        }
        
        /* Временный стиль для элементов под подсветкой */
        .tutorial-highlighted-element {
            position: relative;
            z-index: 2004 !important;
            transform: translateZ(0);
        }
    </style>
</head>
<body>
    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-logo">
            <h2 data-i18n="wallets.title">Кошельки</h2>
        </div>
        <button class="burger-menu" id="burgerMenu">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-content">
                <h1 data-i18n="wallets.title">Кошельки</h1>
                <p data-i18n="wallets.subtitle">Управление кошельками</p>
            </div>
            <button class="burger-menu" onclick="toggleSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="nav-links" id="navLinks">
            <!-- Links will be populated based on user role -->
        </div>
        
        <div class="user-info">
            <div class="user-details">
                <h3>
                    <span class="username" id="userName">Загрузка...</span>
                    <span class="role" id="userRole">Загрузка...</span>
                </h3>
            </div>
            <div class="user-controls">
                <div class="language-selector">
                    <button class="user-control-btn language-btn" id="languageBtn">
                        <i class="fas fa-globe"></i>
                        <span id="currentLanguage">RU</span>
                    </button>
                    <div class="language-dropdown" id="languageDropdown">
                        <div class="language-option" data-lang="ru">Русский</div>
                        <div class="language-option" data-lang="en">English</div>
                        <div class="language-option" data-lang="fr">Français</div>
                        <div class="language-option" data-lang="ar">العربية</div>
                    </div>
                </div>
                <button class="user-control-btn logout-btn" onclick="logout()" id="logoutBtn" data-i18n="nav.logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Выход</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <h2 data-i18n="wallets.welcome">Управление кошельками</h2>
            <div class="header-actions">
                <button class="btn btn-primary" onclick="refreshWallets()" id="refreshBtn" data-i18n="wallets.refresh">
                    <i class="fas fa-sync-alt"></i>
                    <span>Обновить</span>
                </button>
                <button class="btn btn-primary" onclick="openAddModal()" id="addWalletBtn" data-i18n="wallets.add_wallet">
                    <i class="fas fa-plus"></i>
                    <span>Добавить кошелёк</span>
                </button>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filter-section">
            <div class="filter-grid">
                <div class="filter-group">
                    <label data-i18n="wallets.filter_form">Форма</label>
                    <select class="filter-select" id="formFilter" onchange="filterWallets()">
                        <option value="all" data-i18n="wallets.all_forms">Все формы</option>
                        <!-- Forms will be loaded here -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label data-i18n="wallets.filter_type">Тип кошелька</label>
                    <select class="filter-select" id="typeFilter" onchange="filterWallets()">
                        <option value="all" data-i18n="wallets.all_types">Все типы</option>
                        <option value="vodafone">Vodafone Cash</option>
                        <option value="instapay">InstaPay</option>
                        <option value="other">Другие</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label data-i18n="wallets.filter_status">Статус</label>
                    <select class="filter-select" id="statusFilter" onchange="filterWallets()">
                        <option value="all" data-i18n="wallets.all_status">Все статусы</option>
                        <option value="active" data-i18n="wallets.active">Активные</option>
                        <option value="inactive" data-i18n="wallets.inactive">Неактивные</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label data-i18n="wallets.search">Поиск</label>
                    <input type="text" class="filter-input" id="searchInput" 
                           placeholder="По номеру или названию..." 
                           data-i18n-placeholder="wallets.search_placeholder"
                           oninput="filterWallets()">
                </div>
            </div>
        </div>
        
        <!-- Wallets Table Container -->
        <div class="table-section-container">
            <!-- Table Loader -->
            <div class="table-loader show" id="tableLoader">
                <div class="table-spinner"></div>
                <p data-i18n="wallets.loading">Загрузка кошельков...</p>
            </div>
            
            <!-- Wallets Table -->
            <div class="section">
                <div class="section-header">
                    <h3 data-i18n="wallets.list">Список кошельков</h3>
                    <div class="table-info">
                        <span id="walletsCount">0</span> <span data-i18n="wallets.wallets_found">кошельков найдено</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="walletsTable">
                        <thead>
                            <tr>
                                <th data-i18n="wallets.table_form">Форма</th>
                                <th data-i18n="wallets.table_type">Тип</th>
                                <th data-i18n="wallets.table_name">Название</th>
                                <th data-i18n="wallets.table_number">Номер</th>
                                <th data-i18n="wallets.table_status">Статус</th>
                                <th data-i18n="wallets.table_actions">Действия</th>
                            </tr>
                        </thead>
                        <tbody id="walletsTableBody">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
                <div id="noWallets" class="empty-state" style="display: none;">
                    <i class="fas fa-wallet"></i>
                    <h4 data-i18n="wallets.no_wallets">Кошельки не найдены</h4>
                    <p data-i18n="wallets.no_wallets_desc">Нет доступных кошельков для отображения</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal">
            <div class="modal-header">
                <h3 data-i18n="wallets.edit_wallet">Редактировать кошелёк</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            
            <form id="editForm" onsubmit="saveWalletChanges(event)">
                <input type="hidden" id="editWalletId">
                <input type="hidden" id="editWalletFormApi">
                
                <div class="form-group">
                    <label for="editFormName" data-i18n="wallets.form_name">Форма</label>
                    <input type="text" class="form-control" id="editFormName" readonly>
                </div>
                
                <div class="form-group">
                    <label for="editWalletType" data-i18n="wallets.wallet_type">Тип кошелька</label>
                    <select class="form-control" id="editWalletType" required>
                        <option value="vodafone">Vodafone Cash</option>
                        <option value="instapay">InstaPay</option>
                        <option value="other">Другой</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="editWalletName" data-i18n="wallets.wallet_name">Название кошелька</label>
                    <input type="text" class="form-control" id="editWalletName" required 
                           data-i18n-placeholder="wallets.wallet_name_placeholder" 
                           placeholder="Введите название кошелька">
                </div>
                
                <div class="form-group">
                    <label for="editWalletNumber" data-i18n="wallets.wallet_number">Номер кошелька</label>
                    <input type="text" class="form-control" id="editWalletNumber" required 
                           data-i18n-placeholder="wallets.wallet_number_placeholder" 
                           placeholder="Введите номер кошелька">
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="editWalletEnabled">
                        <label for="editWalletEnabled" data-i18n="wallets.wallet_enabled">Активен</label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" data-i18n="wallets.cancel">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveBtn" data-i18n="wallets.save">
                        Сохранить
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Wallet Modal -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <div class="modal-header">
                <h3 data-i18n="wallets.add_wallet">Добавить кошелёк</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            
            <form id="addForm" onsubmit="addNewWallet(event)">
                <div class="form-group">
                    <label for="addFormSelect" data-i18n="wallets.form_name">Форма</label>
                    <select class="form-control" id="addFormSelect" required onchange="updateAddFormApi()">
                        <option value="" data-i18n="wallets.select_form">Выберите форму</option>
                        <!-- Forms will be populated here -->
                    </select>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="testCurrentForm()" style="margin-top: 10px;">
                        <i class="fas fa-wifi"></i>
                        <span data-i18n="wallets.test_connection">Проверить подключение</span>
                    </button>
                </div>
                
                <div class="form-group">
                    <label for="addWalletType" data-i18n="wallets.wallet_type">Тип кошелька</label>
                    <select class="form-control" id="addWalletType" required>
                        <option value="vodafone">Vodafone Cash</option>
                        <option value="instapay">InstaPay</option>
                        <option value="other">Другой</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="addWalletName" data-i18n="wallets.wallet_name">Название кошелька</label>
                    <input type="text" class="form-control" id="addWalletName" required 
                           data-i18n-placeholder="wallets.wallet_name_placeholder" 
                           placeholder="Введите название кошелька">
                </div>
                
                <div class="form-group">
                    <label for="addWalletNumber" data-i18n="wallets.wallet_number">Номер кошелька</label>
                    <input type="text" class="form-control" id="addWalletNumber" required 
                           data-i18n-placeholder="wallets.wallet_number_placeholder" 
                           placeholder="Введите номер кошелька">
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="addWalletEnabled" checked>
                        <label for="addWalletEnabled" data-i18n="wallets.wallet_enabled">Активен</label>
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAddModal()" data-i18n="wallets.cancel">
                        Отмена
                    </button>
                    <button type="submit" class="btn btn-primary" id="addBtn" data-i18n="wallets.add">
                        Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorialOverlay">
        <div class="tutorial-highlight" id="tutorialHighlight"></div>
        <div class="tutorial-popup" id="tutorialPopup">
            <button class="tutorial-close-btn" onclick="skipTutorial()">&times;</button>
            <h3 id="tutorialTitle">Добро пожаловать!</h3>
            <div class="tutorial-progress" id="tutorialProgress">Шаг 1 из 8</div>
            <p id="tutorialText">Начнем изучение панели управления кошельками.</p>
            <div class="tutorial-actions">
                <button class="tutorial-btn tutorial-btn-secondary" onclick="prevTutorialStep()" id="prevBtn" style="display: none;">
                    <span data-i18n="tutorial.prev">Назад</span>
                </button>
                <button class="tutorial-btn tutorial-btn-primary" onclick="nextTutorialStep()" id="nextBtn">
                    <span data-i18n="tutorial.next">Далее</span>
                </button>
                <button class="tutorial-btn tutorial-btn-secondary" onclick="skipTutorial()" id="skipBtn">
                    <span data-i18n="tutorial.skip">Пропустить</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Help Button -->
    <button class="help-button" onclick="startTutorial()" title="Помощь">
        <i class="fas fa-question"></i>
    </button>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Успешно обновлено</span>
    </div>
    
    <script>
        // API Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbxDaBdYMx44M2W3FsJp5tOECFTRD6rWrhPAC96MuUexROt5Qjgj4U0er4So6Ehsh8xQ5g/exec';
        
        // State
        let currentUser = null;
        let currentPermissions = null;
        let currentLanguage = 'ru';
        let allWallets = [];
        let allForms = [];
        let filteredWallets = [];
        
        // Tutorial state
        let tutorialStepsConfig = [];
        let currentTutorialStep = 0;
        let isTutorialActive = false;
        let isScrollingEnabled = true;
        let highlightedElements = new Set();
        
        // Cache for API responses
        const apiCache = {
            forms: null,
            wallets: null,
            lastUpdated: null
        };
        
        // Translation dictionary with tutorial texts
        const translations = {
            ru: {
                // Navigation
                "nav.dashboard": "Дашборд",
                "nav.wallets": "Кошельки",
                "nav.forms": "Формы",
                "nav.agents": "Агенты",
                "nav.admins": "Администраторы",
                "nav.logout": "Выход",
                
                // Wallets page
                "wallets.title": "Кошельки",
                "wallets.subtitle": "Управление кошельками",
                "wallets.welcome": "Управление кошельками",
                "wallets.refresh": "Обновить",
                "wallets.refreshing": "Обновление...",
                "wallets.add_wallet": "Добавить кошелёк",
                "wallets.add": "Добавить",
                "wallets.adding": "Добавление...",
                "wallets.select_form": "Выберите форму",
                "wallets.list": "Список кошельков",
                "wallets.wallets_found": "кошельков найдено",
                "wallets.loading": "Загрузка кошельков...",
                "wallets.test_forms": "Тест форм",
                "wallets.test_connection": "Проверить подключение",
                "wallets.testing": "Тестирование...",
                
                // Filters
                "wallets.filter_form": "Форма",
                "wallets.all_forms": "Все формы",
                "wallets.filter_type": "Тип кошелька",
                "wallets.all_types": "Все типы",
                "wallets.filter_status": "Статус",
                "wallets.all_status": "Все статусы",
                "wallets.active": "Активные",
                "wallets.inactive": "Неактивные",
                "wallets.search": "Поиск",
                "wallets.search_placeholder": "По номеру или названию...",
                
                // Table
                "wallets.table_form": "Форма",
                "wallets.table_type": "Тип",
                "wallets.table_name": "Название",
                "wallets.table_number": "Номер",
                "wallets.table_status": "Статус",
                "wallets.table_actions": "Действия",
                
                // Modal
                "wallets.edit_wallet": "Редактировать кошелёк",
                "wallets.form_name": "Форма",
                "wallets.wallet_type": "Тип кошелька",
                "wallets.wallet_name": "Название кошелька",
                "wallets.wallet_name_placeholder": "Введите название кошелька",
                "wallets.wallet_number": "Номер кошелька",
                "wallets.wallet_number_placeholder": "Введите номер кошелька",
                "wallets.wallet_enabled": "Активен",
                "wallets.cancel": "Отмена",
                "wallets.save": "Сохранить",
                "wallets.saving": "Сохранение...",
                
                // Actions
                "wallets.edit": "Изменить",
                "wallets.toggle": "Переключить статус",
                "wallets.delete": "Удалить",
                
                // Status
                "status.active": "Активен",
                "status.inactive": "Неактивен",
                
                // Empty states
                "wallets.no_wallets": "Кошельки не найдены",
                "wallets.no_wallets_desc": "Нет доступных кошельков для отображения",
                
                // Toast messages
                "toast.success": "Данные успешно обновлены",
                "toast.error": "Ошибка при загрузке данных",
                "toast.save_success": "Кошелёк успешно обновлён",
                "toast.save_error": "Ошибка при сохранении кошелька",
                "toast.toggle_success": "Статус кошелька изменён",
                "toast.toggle_error": "Ошибка при изменении статуса",
                "toast.delete_success": "Кошелёк успешно удалён",
                "toast.delete_error": "Ошибка при удалении кошелька",
                "toast.add_success": "Кошелёк успешно добавлен",
                "toast.add_error": "Ошибка при добавлении кошелька",
                "toast.logout_success": "Выход выполнен успешно",
                "toast.logout_error": "Ошибка при выходе",
                "toast.test_success": "Подключение успешно",
                "toast.test_error": "Ошибка подключения",
                
                // Roles
                "role.superadmin": "Супер-админ",
                "role.admin": "Администратор",
                "role.manager": "Менеджер",
                "role.viewer": "Наблюдатель",
                
                // Tutorial
                "tutorial.welcome": "Добро пожаловать в панель управления кошельками!",
                "tutorial.welcome_desc": "Давайте познакомимся с основными функциями. Это интерактивная инструкция поможет вам освоить интерфейс.",
                "tutorial.sidebar": "Навигационное меню",
                "tutorial.sidebar_desc": "Здесь вы можете переключаться между разделами панели управления. Нажмите на бургер-меню, чтобы открыть/закрыть навигацию.",
                "tutorial.refresh": "Кнопка обновления",
                "tutorial.refresh_desc": "Эта кнопка обновляет список кошельков. Используйте её, чтобы получить актуальные данные.",
                "tutorial.add_wallet": "Добавление кошелька",
                "tutorial.add_wallet_desc": "Нажмите здесь, чтобы добавить новый кошелёк в систему.",
                "tutorial.filters": "Фильтры",
                "tutorial.filters_desc": "Используйте эти фильтры для поиска и сортировки кошельков по форме, типу, статусу или номеру.",
                "tutorial.table": "Таблица кошельков",
                "tutorial.table_desc": "Здесь отображаются все кошельки. Вы можете редактировать, включать/выключать или удалять кошельки с помощью кнопок действий.",
                "tutorial.edit_wallet": "Редактирование кошелька",
                "tutorial.edit_wallet_desc": "Нажмите на кнопку редактирования, чтобы изменить параметры кошелька.",
                "tutorial.forms_navigation": "Переход к формам",
                "tutorial.forms_navigation_desc": "Теперь давайте перейдём в раздел 'Формы', чтобы продолжить обучение. Откройте меню и выберите 'Формы'.",
                "tutorial.complete": "Обучение завершено!",
                "tutorial.complete_desc": "Вы успешно прошли базовое обучение. Теперь вы можете свободно использовать панель управления. Для повторения обучения нажмите на кнопку помощи в правом нижнем углу.",
                "tutorial.next": "Далее",
                "tutorial.prev": "Назад",
                "tutorial.skip": "Пропустить",
                "tutorial.start": "Начать обучение",
                "tutorial.restart": "Повторить обучение"
            },
            en: {
                "nav.dashboard": "Dashboard",
                "nav.wallets": "Wallets",
                "nav.forms": "Forms",
                "nav.agents": "Agents",
                "nav.admins": "Administrators",
                "nav.logout": "Logout",
                "wallets.title": "Wallets",
                "wallets.subtitle": "Wallet Management",
                "wallets.welcome": "Wallet Management",
                "wallets.refresh": "Refresh",
                "wallets.refreshing": "Refreshing...",
                "wallets.add_wallet": "Add Wallet",
                "wallets.add": "Add",
                "wallets.adding": "Adding...",
                "wallets.select_form": "Select form",
                "wallets.list": "Wallets List",
                "wallets.wallets_found": "wallets found",
                "wallets.loading": "Loading wallets...",
                "wallets.test_forms": "Test Forms",
                "wallets.test_connection": "Test Connection",
                "wallets.testing": "Testing...",
                "wallets.filter_form": "Form",
                "wallets.all_forms": "All forms",
                "wallets.filter_type": "Wallet Type",
                "wallets.all_types": "All types",
                "wallets.filter_status": "Status",
                "wallets.all_status": "All statuses",
                "wallets.active": "Active",
                "wallets.inactive": "Inactive",
                "wallets.search": "Search",
                "wallets.search_placeholder": "By number or name...",
                "wallets.table_form": "Form",
                "wallets.table_type": "Type",
                "wallets.table_name": "Name",
                "wallets.table_number": "Number",
                "wallets.table_status": "Status",
                "wallets.table_actions": "Actions",
                "wallets.edit_wallet": "Edit Wallet",
                "wallets.form_name": "Form",
                "wallets.wallet_type": "Wallet Type",
                "wallets.wallet_name": "Wallet Name",
                "wallets.wallet_name_placeholder": "Enter wallet name",
                "wallets.wallet_number": "Wallet Number",
                "wallets.wallet_number_placeholder": "Enter wallet number",
                "wallets.wallet_enabled": "Enabled",
                "wallets.cancel": "Cancel",
                "wallets.save": "Save",
                "wallets.saving": "Saving...",
                "wallets.edit": "Edit",
                "wallets.toggle": "Toggle Status",
                "wallets.delete": "Delete",
                "status.active": "Active",
                "status.inactive": "Inactive",
                "wallets.no_wallets": "No wallets found",
                "wallets.no_wallets_desc": "No wallets available to display",
                "toast.success": "Data updated successfully",
                "toast.error": "Error loading data",
                "toast.save_success": "Wallet updated successfully",
                "toast.save_error": "Error saving wallet",
                "toast.toggle_success": "Wallet status changed",
                "toast.toggle_error": "Error changing wallet status",
                "toast.delete_success": "Wallet deleted successfully",
                "toast.delete_error": "Error deleting wallet",
                "toast.add_success": "Wallet added successfully",
                "toast.add_error": "Error adding wallet",
                "toast.logout_success": "Logout successful",
                "toast.logout_error": "Logout error",
                "toast.test_success": "Connection successful",
                "toast.test_error": "Connection error",
                "role.superadmin": "Super Admin",
                "role.admin": "Administrator",
                "role.manager": "Manager",
                "role.viewer": "Viewer",
                "tutorial.welcome": "Welcome to Wallet Management Panel!",
                "tutorial.welcome_desc": "Let's get familiar with the main functions. This interactive tutorial will help you master the interface.",
                "tutorial.sidebar": "Navigation Menu",
                "tutorial.sidebar_desc": "Here you can switch between sections of the control panel. Click on the burger menu to open/close navigation.",
                "tutorial.refresh": "Refresh Button",
                "tutorial.refresh_desc": "This button refreshes the list of wallets. Use it to get up-to-date data.",
                "tutorial.add_wallet": "Add Wallet",
                "tutorial.add_wallet_desc": "Click here to add a new wallet to the system.",
                "tutorial.filters": "Filters",
                "tutorial.filters_desc": "Use these filters to search and sort wallets by form, type, status or number.",
                "tutorial.table": "Wallets Table",
                "tutorial.table_desc": "All wallets are displayed here. You can edit, enable/disable or delete wallets using action buttons.",
                "tutorial.edit_wallet": "Edit Wallet",
                "tutorial.edit_wallet_desc": "Click the edit button to change wallet parameters.",
                "tutorial.forms_navigation": "Go to Forms",
                "tutorial.forms_navigation_desc": "Now let's go to the 'Forms' section to continue learning. Open the menu and select 'Forms'.",
                "tutorial.complete": "Tutorial Complete!",
                "tutorial.complete_desc": "You have successfully completed basic training. Now you can freely use the control panel. To repeat the tutorial, click the help button in the lower right corner.",
                "tutorial.next": "Next",
                "tutorial.prev": "Back",
                "tutorial.skip": "Skip",
                "tutorial.start": "Start Tutorial",
                "tutorial.restart": "Repeat Tutorial"
            },
            fr: {
                "nav.dashboard": "Tableau de bord",
                "nav.wallets": "Portefeuilles",
                "nav.forms": "Formulaires",
                "nav.agents": "Agents",
                "nav.admins": "Administrateurs",
                "nav.logout": "Déconnexion",
                "wallets.title": "Portefeuilles",
                "wallets.subtitle": "Gestion des portefeuilles",
                "wallets.welcome": "Gestion des portefeuilles",
                "wallets.refresh": "Rafraîchir",
                "wallets.refreshing": "Rafraîchissement...",
                "wallets.add_wallet": "Ajouter un portefeuille",
                "wallets.add": "Ajouter",
                "wallets.adding": "Ajout...",
                "wallets.select_form": "Sélectionner un formulaire",
                "wallets.list": "Liste des portefeuilles",
                "wallets.wallets_found": "portefeuilles trouvés",
                "wallets.loading": "Chargement des portefeuilles...",
                "wallets.test_forms": "Tester les formulaires",
                "wallets.test_connection": "Tester la connexion",
                "wallets.testing": "Test en cours...",
                "wallets.filter_form": "Formulaire",
                "wallets.all_forms": "Tous les formulaires",
                "wallets.filter_type": "Type de portefeuille",
                "wallets.all_types": "Tous les types",
                "wallets.filter_status": "Statut",
                "wallets.all_status": "Tous les statuts",
                "wallets.active": "Actif",
                "wallets.inactive": "Inactif",
                "wallets.search": "Recherche",
                "wallets.search_placeholder": "Par numéro ou nom...",
                "wallets.table_form": "Formulaire",
                "wallets.table_type": "Type",
                "wallets.table_name": "Nom",
                "wallets.table_number": "Numéro",
                "wallets.table_status": "Statut",
                "wallets.table_actions": "Actions",
                "wallets.edit_wallet": "Modifier le portefeuille",
                "wallets.form_name": "Formulaire",
                "wallets.wallet_type": "Type de portefeuille",
                "wallets.wallet_name": "Nom du portefeuille",
                "wallets.wallet_name_placeholder": "Entrez le nom du portefeuille",
                "wallets.wallet_number": "Numéro du portefeuille",
                "wallets.wallet_number_placeholder": "Entrez le numéro du portefeuille",
                "wallets.wallet_enabled": "Activé",
                "wallets.cancel": "Annuler",
                "wallets.save": "Enregistrer",
                "wallets.saving": "Enregistrement...",
                "wallets.edit": "Modifier",
                "wallets.toggle": "Changer le statut",
                "wallets.delete": "Supprimer",
                "status.active": "Actif",
                "status.inactive": "Inactif",
                "wallets.no_wallets": "Aucun portefeuille trouvé",
                "wallets.no_wallets_desc": "Aucun portefeuille disponible à afficher",
                "toast.success": "Données mises à jour avec succès",
                "toast.error": "Erreur de chargement des données",
                "toast.save_success": "Portefeuille mis à jour avec succès",
                "toast.save_error": "Erreur lors de l'enregistrement du portefeuille",
                "toast.toggle_success": "Statut du portefeuille changé",
                "toast.toggle_error": "Erreur lors du changement de statut",
                "toast.delete_success": "Portefeuille supprimé avec succès",
                "toast.delete_error": "Erreur lors de la suppression du portefeuille",
                "toast.add_success": "Portefeuille ajouté avec succès",
                "toast.add_error": "Erreur lors de l'ajout du portefeuille",
                "toast.logout_success": "Déconnexion réussie",
                "toast.logout_error": "Erreur de déconnexion",
                "toast.test_success": "Connexion réussie",
                "toast.test_error": "Erreur de connexion",
                "role.superadmin": "Super Admin",
                "role.admin": "Administrateur",
                "role.manager": "Manager",
                "role.viewer": "Observateur",
                "tutorial.welcome": "Bienvenue dans le panneau de gestion des portefeuilles !",
                "tutorial.welcome_desc": "Familiarisons-nous avec les principales fonctions. Ce tutoriel interactif vous aidera à maîtriser l'interface.",
                "tutorial.sidebar": "Menu de navigation",
                "tutorial.sidebar_desc": "Ici, vous pouvez passer d'une section à l'autre du panneau de contrôle. Cliquez sur le menu burger pour ouvrir/fermer la navigation.",
                "tutorial.refresh": "Bouton d'actualisation",
                "tutorial.refresh_desc": "Ce bouton actualise la liste des portefeuilles. Utilisez-le pour obtenir des données à jour.",
                "tutorial.add_wallet": "Ajouter un portefeuille",
                "tutorial.add_wallet_desc": "Cliquez ici pour ajouter un nouveau portefeuille au système.",
                "tutorial.filters": "Filtres",
                "tutorial.filters_desc": "Utilisez ces filtres pour rechercher и trier les portefeuilles par formulaire, type, statut ou numéro.",
                "tutorial.table": "Tableau des portefeuilles",
                "tutorial.table_desc": "Tous les portefeuilles sont affichés ici. Vous pouvez modifier, activer/désactiver ou supprimer des portefeuilles à l'aide des boutons d'action.",
                "tutorial.edit_wallet": "Modifier le portefeuille",
                "tutorial.edit_wallet_desc": "Cliquez sur le bouton de modification pour changer les paramètres du portefeuille.",
                "tutorial.forms_navigation": "Aller aux formulaires",
                "tutorial.forms_navigation_desc": "Passons maintenant à la section 'Formulaires' pour continuer l'apprentissage. Ouvrez le menu et sélectionnez 'Formulaires'.",
                "tutorial.complete": "Tutoriel terminé !",
                "tutorial.complete_desc": "Vous avez terminé avec succès la formation de base. Vous pouvez maintenant utiliser librement le panneau de contrôle. Pour répéter le tutoriel, cliquez sur le bouton d'aide dans le coin inférieur droit.",
                "tutorial.next": "Suivant",
                "tutorial.prev": "Retour",
                "tutorial.skip": "Passer",
                "tutorial.start": "Commencer le tutoriel",
                "tutorial.restart": "Répéter le tutoriel"
            },
            ar: {
                "nav.dashboard": "لوحة التحكم",
                "nav.wallets": "المحافظ",
                "nav.forms": "النماذج",
                "nav.agents": "الوكلاء",
                "nav.admins": "المشرفين",
                "nav.logout": "تسجيل الخروج",
                "wallets.title": "المحافظ",
                "wallets.subtitle": "إدارة المحافظ",
                "wallets.welcome": "إدارة المحافظ",
                "wallets.refresh": "تحديث",
                "wallets.refreshing": "جاري التحديث...",
                "wallets.add_wallet": "إضافة محفظة",
                "wallets.add": "إضافة",
                "wallets.adding": "جاري الإضافة...",
                "wallets.select_form": "اختر نموذج",
                "wallets.list": "قائمة المحافظ",
                "wallets.wallets_found": "محفظة وجدت",
                "wallets.loading": "جاري تحميل المحافظ...",
                "wallets.test_forms": "اختبار النماذج",
                "wallets.test_connection": "اختبار الاتصال",
                "wallets.testing": "جاري الاختبار...",
                "wallets.filter_form": "النموذج",
                "wallets.all_forms": "جميع النماذج",
                "wallets.filter_type": "نوع المحفظة",
                "wallets.all_types": "جميع الأنواع",
                "wallets.filter_status": "الحالة",
                "wallets.all_status": "جميع الحالات",
                "wallets.active": "نشط",
                "wallets.inactive": "غير نشط",
                "wallets.search": "بحث",
                "wallets.search_placeholder": "بالرقم أو الاسم...",
                "wallets.table_form": "النموذج",
                "wallets.table_type": "النوع",
                "wallets.table_name": "الاسم",
                "wallets.table_number": "الرقم",
                "wallets.table_status": "الحالة",
                "wallets.table_actions": "الإجراءات",
                "wallets.edit_wallet": "تعديل المحفظة",
                "wallets.form_name": "النموذج",
                "wallets.wallet_type": "نوع المحفظة",
                "wallets.wallet_name": "اسم المحفظة",
                "wallets.wallet_name_placeholder": "أدخل اسم المحفظة",
                "wallets.wallet_number": "رقم المحفظة",
                "wallets.wallet_number_placeholder": "أدخل رقم المحفظة",
                "wallets.wallet_enabled": "مفعل",
                "wallets.cancel": "إلغاء",
                "wallets.save": "حفظ",
                "wallets.saving": "جاري الحفظ...",
                "wallets.edit": "تعديل",
                "wallets.toggle": "تغيير الحالة",
                "wallets.delete": "حذف",
                "status.active": "نشط",
                "status.inactive": "غير نشط",
                "wallets.no_wallets": "لم يتم العثور على محافظ",
                "wallets.no_wallets_desc": "لا توجد محافظ متاحة للعرض",
                "toast.success": "تم تحديث البيانات بنجاح",
                "toast.error": "خطأ في تحميل البيانات",
                "toast.save_success": "تم تحديث المحفظة بنجاح",
                "toast.save_error": "خطأ في حفظ المحفظة",
                "toast.toggle_success": "تم تغيير حالة المحفظة",
                "toast.toggle_error": "خطأ في تغيير الحالة",
                "toast.delete_success": "تم حذف المحفظة بنجاح",
                "toast.delete_error": "خطأ في حذف المحفظة",
                "toast.add_success": "تم إضافة المحفظة بنجاح",
                "toast.add_error": "خطأ في إضافة المحفظة",
                "toast.logout_success": "تم تسجيل الخروج بنجاح",
                "toast.logout_error": "خطأ في تسجيل الخروج",
                "toast.test_success": "تم الاتصال بنجاح",
                "toast.test_error": "خطأ في الاتصال",
                "role.superadmin": "مشرف رئيسي",
                "role.admin": "مشرف",
                "role.manager": "مدير",
                "role.viewer": "مشاهد",
                "tutorial.welcome": "مرحبًا بك في لوحة إدارة المحافظ!",
                "tutorial.welcome_desc": "دعنا نتعرف على الوظائف الرئيسية. سيساعدك هذا البرنامج التعليمي التفاعلي على إتقان الواجهة.",
                "tutorial.sidebar": "قائمة التنقل",
                "tutorial.sidebar_desc": "هنا يمكنك التبديل بين أقسام لوحة التحكم. انقر على قائمة البرجر لفتح/إغلاق التنقل.",
                "tutorial.refresh": "زر التحديث",
                "tutorial.refresh_desc": "يحدث هذا الزر قائمة المحافظ. استخدمه للحصول على بيانات محدثة.",
                "tutorial.add_wallet": "إضافة محفظة",
                "tutorial.add_wallet_desc": "انقر هنا لإضافة محفظة جديدة إلى النظام.",
                "tutorial.filters": "الفلاتر",
                "tutorial.filters_desc": "استخدم هذه الفلاتر للبحث وفرز المحافظ حسب النموذج أو النوع أو الحالة أو الرقم.",
                "tutorial.table": "جدول المحافظ",
                "tutorial.table_desc": "يتم عرض جميع المحافظ هنا. يمكنك تعديل أو تمكين/تعطيل أو حذف المحافظ باستخدام أزرار الإجراءات.",
                "tutorial.edit_wallet": "تعديل المحفظة",
                "tutorial.edit_wallet_desc": "انقر على زر التعديل لتغيير معلمات المحفظة.",
                "tutorial.forms_navigation": "الانتقال إلى النماذج",
                "tutorial.forms_navigation_desc": "الآن دعنا ننتقل إلى قسم 'النماذج' لمواصلة التعلم. افتح القائمة واختر 'النماذج'.",
                "tutorial.complete": "اكتمل البرنامج التعليمي!",
                "tutorial.complete_desc": "لقد أكملت بنجاح التدريب الأساسي. يمكنك الآن استخدام لوحة التحكم بحرية. لتكرار البرنامج التعليمي، انقر على زر المساعدة في الزاوية اليمنى السفلية.",
                "tutorial.next": "التالي",
                "tutorial.prev": "السابق",
                "tutorial.skip": "تخطي",
                "tutorial.start": "بدء البرنامج التعليمي",
                "tutorial.restart": "تكرار البرنامج التعليمي"
            }
        };
        
        // Tutorial steps configuration
        /*const*/ tutorialStepsConfig = [
            {
                elementId: 'burgerMenu',
                title: 'tutorial.sidebar',
                description: 'tutorial.sidebar_desc',
                position: 'bottom',
                action: () => {
                    // Auto-open sidebar on mobile
                    if (window.innerWidth <= 1024) {
                        toggleSidebar();
                    }
                }
            },
            {
                elementId: 'refreshBtn',
                title: 'tutorial.refresh',
                description: 'tutorial.refresh_desc',
                position: 'bottom'
            },
            {
                elementId: 'addWalletBtn',
                title: 'tutorial.add_wallet',
                description: 'tutorial.add_wallet_desc',
                position: 'bottom'
            },
            {
                elementId: 'formFilter',
                title: 'tutorial.filters',
                description: 'tutorial.filters_desc',
                position: 'bottom'
            },
            {
                elementId: 'walletsTable',
                title: 'tutorial.table',
                description: 'tutorial.table_desc',
                position: 'top'
            },
            {
                elementId: 'editBtnPlaceholder',
                title: 'tutorial.edit_wallet',
                description: 'tutorial.edit_wallet_desc',
                position: 'bottom',
                action: () => {
                    // Find first edit button in table
                    const editBtn = document.querySelector('.action-btn.edit');
                    if (editBtn) {
                        highlightElement(editBtn.getBoundingClientRect());
                    }
                }
            },
            {
                elementId: 'sidebar',
                title: 'tutorial.forms_navigation',
                description: 'tutorial.forms_navigation_desc',
                position: 'right',
                action: () => {
                    // Open sidebar and highlight Forms link
                    if (window.innerWidth > 1024) {
                        const formsLink = document.querySelector('a[href*="forms.html"]');
                        if (formsLink) {
                            highlightElement(formsLink.getBoundingClientRect());
                        }
                    } else {
                        toggleSidebar();
                        setTimeout(() => {
                            const formsLink = document.querySelector('a[href*="forms.html"]');
                            if (formsLink) {
                                highlightElement(formsLink.getBoundingClientRect());
                            }
                        }, 300);
                    }
                }
            },
            {
                elementId: null, // No element for final step
                title: 'tutorial.complete',
                description: 'tutorial.complete_desc',
                position: 'center'
            }
        ];
        
        // Initialize tutorial
       /* function initTutorial() {
            // Check if tutorial was completed before
            const tutorialCompleted = localStorage.getItem('wallets_tutorial_completed');
            if (!tutorialCompleted) {
                // Show start tutorial button after page loads
                setTimeout(() => {
                    if (confirm(translations[currentLanguage]['tutorial.start'] + '?')) {
                        startTutorial();
                    }
                }, 2000);
            }
        }*/
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('i');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toastIcon.className = type === 'success' ? 'fas fa-check-circle' : 
                                type === 'error' ? 'fas fa-exclamation-circle' : 
                                type === 'warning' ? 'fas fa-exclamation-triangle' :
                                'fas fa-info-circle';
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Show table loader
        function showTableLoader() {
            document.getElementById('tableLoader').classList.add('show');
            document.getElementById('walletsTableBody').innerHTML = '';
            document.getElementById('noWallets').style.display = 'none';
        }
        
        // Hide table loader
        function hideTableLoader() {
            document.getElementById('tableLoader').classList.remove('show');
        }
        
        // Toggle sidebar for mobile
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }
        
        // Apply translation
        function applyTranslation(lang) {
            const dict = translations[lang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) el.textContent = dict[key];
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (dict[key]) el.setAttribute('placeholder', dict[key]);
            });
            
            document.getElementById('currentLanguage').textContent = 
                lang === 'ru' ? 'RU' : 
                lang === 'en' ? 'EN' : 
                lang === 'fr' ? 'FR' : 'AR';
            
            // Set RTL for Arabic
            if (lang === 'ar') {
                document.body.setAttribute('dir', 'rtl');
            } else {
                document.body.removeAttribute('dir');
            }
            
            currentLanguage = lang;
            localStorage.setItem('dashboard_language', lang);
            
            // Update role translation
            if (currentUser && currentUser.role) {
                updateRoleTranslation();
            }
        }
        
        // Update role translation
        function updateRoleTranslation() {
            const roleKey = `role.${currentUser.role}`;
            const dict = translations[currentLanguage];
            if (dict[roleKey]) {
                document.getElementById('userRole').textContent = dict[roleKey];
            }
        }
        
        // Setup navigation based on user role
        function setupNavigation() {
            const navLinks = document.getElementById('navLinks');
            navLinks.innerHTML = '';
            
            const navItems = [
                { id: 'dashboard', icon: 'fas fa-tachometer-alt', text: 'nav.dashboard', href: 'dashboard.html' },
                { id: 'wallets', icon: 'fas fa-wallet', text: 'nav.wallets', href: 'wallets.html' },
                { id: 'forms', icon: 'fas fa-clipboard-list', text: 'nav.forms', href: 'forms.html' },
                { id: 'agents', icon: 'fas fa-users', text: 'nav.agents', href: 'agents.html' },
                { id: 'admins', icon: 'fas fa-user-shield', text: 'nav.admins', href: 'admins.html' }
            ];
            
            // Filter navigation based on user role
            let allowedNavItems = navItems;
            
            if (currentUser.role === 'manager' || currentUser.role === 'admin') {
                allowedNavItems = navItems.filter(item => 
                    item.id === 'wallets' || item.id === 'forms'
                );
            } else if (currentUser.role === 'viewer') {
                allowedNavItems = navItems.filter(item => item.id === 'dashboard');
            }
            
            allowedNavItems.forEach(item => {
                const a = document.createElement('a');
                a.href = item.href;
                a.className = window.location.pathname.includes(item.href) ? 'active' : '';
                a.innerHTML = `
                    <i class="${item.icon}"></i>
                    <span data-i18n="${item.text}">${item.text}</span>
                `;
                a.addEventListener('click', function(e) {
                    if (window.innerWidth <= 1024) {
                        toggleSidebar();
                    }
                });
                navLinks.appendChild(a);
            });
            
            // Re-apply translations after navigation is set up
            applyTranslation(currentLanguage);
        }
        
        // Load page data
        async function loadPageData() {
            showTableLoader();
            
            try {
                const token = localStorage.getItem('admin_token');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }
                
                // Load user info
                const userData = localStorage.getItem('admin_user');
                const permissionsData = localStorage.getItem('admin_permissions');
                
                if (userData && permissionsData) {
                    currentUser = JSON.parse(userData);
                    currentPermissions = JSON.parse(permissionsData);
                    
                    document.getElementById('userName').textContent = currentUser.username;
                    updateRoleTranslation();
                    
                    // Setup navigation based on role
                    setupNavigation();
                }
                
                // Load language
                const savedLang = localStorage.getItem('dashboard_language') || localStorage.getItem('preferred_language') || 'ru';
                applyTranslation(savedLang);
                
                // Load forms and wallets in parallel
                await Promise.all([
                    loadForms(),
                    loadWallets()
                ]);
                
                /*// Initialize tutorial after page loads
                setTimeout(initTutorial, 1000);*/
                
            } catch (error) {
                console.error('Error loading page:', error);
                showToast(translations[currentLanguage]?.['toast.error'], 'error');
            } finally {
                hideTableLoader();
            }
        }
        
        // Load forms
        async function loadForms() {
            try {
                const token = localStorage.getItem('admin_token');
                
                // Check cache
                if (apiCache.forms && Date.now() - apiCache.lastUpdated < 30000) {
                    allForms = apiCache.forms;
                } else {
                    const response = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
                    
                    if (!response.ok) throw new Error('Network error');
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        allForms = result.forms || [];
                        apiCache.forms = allForms;
                        apiCache.lastUpdated = Date.now();
                    } else {
                        showToast(result.error || translations[currentLanguage]?.['toast.error'], 'error');
                        return;
                    }
                }
                
                // Filter forms based on user role
                let displayForms = allForms;
                
                // If user is manager, filter by assigned forms
                if (currentUser.role === 'manager') {
                    const assignedForms = await getAssignedForms();
                    displayForms = allForms.filter(form => 
                        assignedForms.some(assigned => assigned === form.formName)
                    );
                }
                
                // Populate form filter dropdown
                const formFilter = document.getElementById('formFilter');
                formFilter.innerHTML = '<option value="all">' + (translations[currentLanguage]?.['wallets.all_forms'] || 'Все формы') + '</option>';
                
                // Populate add form dropdown
                const addFormSelect = document.getElementById('addFormSelect');
                addFormSelect.innerHTML = '<option value="">' + (translations[currentLanguage]?.['wallets.select_form'] || 'Выберите форму') + '</option>';
                
                displayForms.forEach(form => {
                    const option = document.createElement('option');
                    option.value = form.formName;
                    option.textContent = form.formName;
                    option.dataset.api = form.formAPI;
                    formFilter.appendChild(option.cloneNode(true));
                    addFormSelect.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading forms:', error);
            }
        }
        
        // Update form API when form is selected in add modal
        function updateAddFormApi() {
            // This function is called when form selection changes
            // No action needed as we get API from option dataset
        }
        
        // Get assigned forms for manager
        async function getAssignedForms() {
            try {
                const token = localStorage.getItem('admin_token');
                const username = currentUser.username;
                
                const response = await fetch(`${API_URL}?action=get_assigned_forms&token=${token}&username=${encodeURIComponent(username)}`);
                
                if (!response.ok) throw new Error('Network error');
                
                const result = await response.json();
                
                if (result.success) {
                    return result.forms || [];
                }
                return [];
            } catch (error) {
                console.error('Error getting assigned forms:', error);
                return [];
            }
        }
        
        // Load wallets
        async function loadWallets() {
            showTableLoader();
            
            try {
                const token = localStorage.getItem('admin_token');
                
                // Check cache for forms
                if (!apiCache.forms) {
                    await loadForms();
                }
                
                let displayForms = allForms;
                if (currentUser.role === 'manager') {
                    const assignedForms = await getAssignedForms();
                    displayForms = allForms.filter(form => 
                        assignedForms.some(assigned => assigned === form.formName)
                    );
                }
                
                // Get wallets from each form in parallel
                const walletsPromises = displayForms.map(async (form) => {
                    try {
                        const cacheKey = `wallets_${form.formName}`;
                        const cachedWallets = localStorage.getItem(cacheKey);
                        const cacheTimestamp = localStorage.getItem(`${cacheKey}_timestamp`);
                        
                        // Use cache if less than 30 seconds old
                        if (cachedWallets && cacheTimestamp && Date.now() - parseInt(cacheTimestamp) < 30000) {
                            return JSON.parse(cachedWallets);
                        }
                        
                        const walletsResponse = await fetch(`${form.formAPI}?action=get_wallets&show_all=true`);
                        if (!walletsResponse.ok) {
                            console.warn(`Failed to load wallets from form: ${form.formName}`);
                            return [];
                        }
                        
                        const walletsResult = await walletsResponse.json();
                        let formWallets = [];
                        
                        if (walletsResult.status === 'success' && walletsResult.wallets) {
                            formWallets = Object.entries(walletsResult.wallets).flatMap(([walletType, walletData]) => {
                                const walletNumbers = walletData.numbersInfo || walletData.availableNumbers || [];
                                
                                return Object.entries(walletNumbers).map(([walletNumber, walletInfo]) => {
                                    const isEnabled = walletInfo.enabled === true || 
                                                   walletInfo.enabled === 'true' || 
                                                   (typeof walletInfo === 'boolean' && walletInfo);
                                    
                                    return {
                                        id: `${form.formName}_${walletType}_${walletNumber}`.replace(/\s+/g, '_'),
                                        formName: form.formName,
                                        formApi: form.formAPI,
                                        type: walletType,
                                        name: walletInfo.name || walletData.name || walletType,
                                        number: walletNumber,
                                        enabled: isEnabled,
                                        originalData: walletInfo
                                    };
                                });
                            });
                            
                            // Cache the results
                            localStorage.setItem(cacheKey, JSON.stringify(formWallets));
                            localStorage.setItem(`${cacheKey}_timestamp`, Date.now().toString());
                        }
                        
                        return formWallets;
                    } catch (error) {
                        console.error(`Error loading wallets from form ${form.formName}:`, error);
                        return [];
                    }
                });
                
                const walletsArrays = await Promise.all(walletsPromises);
                allWallets = walletsArrays.flat();
                
                filterWallets();
                
                showToast(translations[currentLanguage]?.['toast.success'], 'success');
                
            } catch (error) {
                console.error('Error loading wallets:', error);
                showToast((translations[currentLanguage]?.['toast.error'] || 'Ошибка') + ': ' + error.message, 'error');
                renderWalletsTable([]);
            } finally {
                hideTableLoader();
            }
        }
        
        // Filter wallets
        function filterWallets() {
            const formFilter = document.getElementById('formFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            filteredWallets = allWallets.filter(wallet => {
                // Form filter
                if (formFilter !== 'all' && wallet.formName !== formFilter) {
                    return false;
                }
                
                // Type filter
                if (typeFilter !== 'all' && wallet.type !== typeFilter) {
                    return false;
                }
                
                // Status filter
                if (statusFilter !== 'all') {
                    const isActive = wallet.enabled === true || wallet.enabled === 'true';
                    if (statusFilter === 'active' && !isActive) return false;
                    if (statusFilter === 'inactive' && isActive) return false;
                }
                
                // Search filter
                if (searchQuery) {
                    const searchInNumber = wallet.number && wallet.number.toLowerCase().includes(searchQuery);
                    const searchInName = wallet.name && wallet.name.toLowerCase().includes(searchQuery);
                    const searchInForm = wallet.formName && wallet.formName.toLowerCase().includes(searchQuery);
                    
                    if (!searchInNumber && !searchInName && !searchInForm) {
                        return false;
                    }
                }
                
                return true;
            });
            
            renderWalletsTable(filteredWallets);
            updateWalletsCount();
        }
        
        // Update wallets count
        function updateWalletsCount() {
            const countElement = document.getElementById('walletsCount');
            countElement.textContent = filteredWallets.length;
        }
        
        // Render wallets table
        function renderWalletsTable(wallets) {
            const tbody = document.getElementById('walletsTableBody');
            const noWallets = document.getElementById('noWallets');
            
            tbody.innerHTML = '';
            
            if (wallets.length === 0) {
                noWallets.style.display = 'block';
                return;
            }
            
            noWallets.style.display = 'none';
            
            wallets.forEach(wallet => {
                const row = document.createElement('tr');
                
                const statusClass = wallet.enabled ? 'active' : 'inactive';
                const statusText = wallet.enabled ? 
                    translations[currentLanguage]?.['status.active'] || 'Активен' : 
                    translations[currentLanguage]?.['status.inactive'] || 'Неактивен';
                
                row.innerHTML = `
                    <td>${wallet.formName || 'N/A'}</td>
                    <td>${wallet.type || ''}</td>
                    <td>${wallet.name || ''}</td>
                    <td><code>${wallet.number || ''}</code></td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        ${currentPermissions.canManageWallets ? `
                            <button class="action-btn edit" onclick="openEditModal('${wallet.id}')" title="${translations[currentLanguage]?.['wallets.edit'] || 'Изменить'}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn toggle" onclick="toggleWalletStatus('${wallet.id}', ${!wallet.enabled}, this)" title="${translations[currentLanguage]?.['wallets.toggle'] || 'Переключить'}">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteWallet('${wallet.id}', this)" title="${translations[currentLanguage]?.['wallets.delete'] || 'Удалить'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : ''}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        // Open edit modal
        function openEditModal(walletId) {
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet) return;
            
            document.getElementById('editWalletId').value = walletId;
            document.getElementById('editWalletFormApi').value = wallet.formApi || '';
            document.getElementById('editFormName').value = wallet.formName || '';
            document.getElementById('editWalletType').value = wallet.type || 'vodafone';
            document.getElementById('editWalletName').value = wallet.name || '';
            document.getElementById('editWalletNumber').value = wallet.number || '';
            document.getElementById('editWalletEnabled').checked = wallet.enabled === true || wallet.enabled === 'true';
            
            document.getElementById('editModal').classList.add('show');
        }
        
        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            document.getElementById('editForm').reset();
        }
        
        // Open add modal
        function openAddModal() {
            document.getElementById('addModal').classList.add('show');
        }
        
        // Close add modal
        function closeAddModal() {
            document.getElementById('addModal').classList.remove('show');
            document.getElementById('addForm').reset();
        }
        
        // Test form connection
        async function testCurrentForm() {
            const formSelect = document.getElementById('addFormSelect');
            const selectedOption = formSelect.options[formSelect.selectedIndex];
            const formName = formSelect.value;
            const formApi = selectedOption?.dataset.api;
            
            if (!formName || !formApi) {
                showToast('Выберите форму для тестирования', 'warning');
                return;
            }
            
            const testBtn = event?.target?.closest('button');
            const originalText = testBtn?.innerHTML;
            
            try {
                if (testBtn) {
                    testBtn.disabled = true;
                    testBtn.classList.add('loading');
                    testBtn.innerHTML = `<div class="loader"></div> ${translations[currentLanguage]?.['wallets.testing'] || 'Тестирование...'}`;
                }
                
                const params = new URLSearchParams();
                params.append('action', 'test');
                params.append('_t', Date.now().toString());
                
                const testUrl = `${formApi}?${params.toString()}`;
                console.log('Testing form:', testUrl);
                
                let response;
                let result;
                
                try {
                    response = await fetch(testUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-cache'
                    });
                    
                    const responseText = await response.text();
                    
                    try {
                        result = JSON.parse(responseText);
                    } catch {
                        result = { success: true, message: 'Form is responding' };
                    }
                    
                } catch (fetchError) {
                    console.warn('Direct fetch failed, trying /exec:', fetchError);
                    
                    const execUrl = formApi.replace(/\/[^\/]*$/, '/exec') + '?' + params.toString();
                    response = await fetch(execUrl, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        cache: 'no-cache'
                    });
                    
                    const responseText = await response.text();
                    result = JSON.parse(responseText);
                }
                
                if (result && (result.success || result.status === 'success')) {
                    showToast(`${formName}: ${translations[currentLanguage]?.['toast.test_success'] || 'Подключение успешно'}`, 'success');
                } else {
                    throw new Error(result?.error || result?.message || 'Unknown error');
                }
                
            } catch (error) {
                console.error('Form test error:', error);
                showToast(`${formName}: ${translations[currentLanguage]?.['toast.test_error'] || 'Ошибка подключения'}: ${error.message}`, 'error');
            } finally {
                if (testBtn) {
                    testBtn.disabled = false;
                    testBtn.classList.remove('loading');
                    testBtn.innerHTML = originalText;
                }
            }
        }
        
        // Test all forms
        async function testAllForms() {
            const btn = document.getElementById('testFormsBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.classList.add('loading');
                btn.innerHTML = `<div class="loader"></div> ${translations[currentLanguage]?.['wallets.testing'] || 'Тестирование...'}`;
                
                let successCount = 0;
                let errorCount = 0;
                
                for (const form of allForms) {
                    try {
                        const testUrl = `${form.formAPI}?action=test&_t=${Date.now()}`;
                        const response = await fetch(testUrl, { method: 'GET', cache: 'no-cache' });
                        
                        if (response.ok) {
                            successCount++;
                        } else {
                            errorCount++;
                        }
                    } catch {
                        errorCount++;
                    }
                }
                
                showToast(
                    `${translations[currentLanguage]?.['wallets.test_forms'] || 'Тест форм'}: ${successCount} успешно, ${errorCount} с ошибками`,
                    errorCount === 0 ? 'success' : errorCount === allForms.length ? 'error' : 'warning'
                );
                
            } catch (error) {
                console.error('Test all forms error:', error);
                showToast(translations[currentLanguage]?.['toast.error'], 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            }
        }
        
        // Save wallet changes
        async function saveWalletChanges(event) {
            event.preventDefault();
            
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.classList.add('loading');
                btn.innerHTML = `<div class="loader"></div> ${translations[currentLanguage]?.['wallets.saving'] || 'Сохранение...'}`;
                
                const walletId = document.getElementById('editWalletId').value;
                const formApi = document.getElementById('editWalletFormApi').value;
                const walletType = document.getElementById('editWalletType').value;
                const walletName = document.getElementById('editWalletName').value;
                const walletNumber = document.getElementById('editWalletNumber').value;
                const walletEnabled = document.getElementById('editWalletEnabled').checked;
                
                if (!formApi) {
                    throw new Error('API формы не найден');
                }
                
                const originalWallet = allWallets.find(w => w.id === walletId);
                if (!originalWallet) {
                    throw new Error('Кошелек не найден');
                }
                
                // Шаг 1: Сначала добавляем новый кошелёк
                const addParams = new URLSearchParams();
                addParams.append('action', 'add_wallet');
                addParams.append('type', walletType);
                addParams.append('name', walletName || walletType);
                addParams.append('number', walletNumber);
                addParams.append('enabled', walletEnabled.toString());
                addParams.append('_t', Date.now().toString());
            
                const addUrl = `${formApi}?${addParams.toString()}`;
                console.log('Add new wallet URL:', addUrl);
            
                const addResponse = await fetch(addUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    cache: 'no-cache'
                });
            
                const addResultText = await addResponse.text();
                console.log('Add response:', addResultText);
            
                // Проверяем, что добавление успешно
                let addResult;
                try {
                    addResult = JSON.parse(addResultText);
                } catch {
                    // Если не JSON, но ответ пришел
                    if (addResponse.ok || addResultText.includes('success')) {
                        addResult = { success: true };
                    } else {
                        throw new Error('Ошибка при добавлении нового кошелька');
                    }
                }
            
                if (!addResult.success && addResult.status !== 'success') {
                    throw new Error(addResult.error || 'Ошибка добавления');
                }
            
                // Шаг 2: Только после успешного добавления удаляем старый
                const deleteParams = new URLSearchParams();
                deleteParams.append('action', 'delete_wallet');
                deleteParams.append('wallet_type', originalWallet.type);
                deleteParams.append('wallet_number', originalWallet.number);
                deleteParams.append('_t', Date.now().toString() + '2');
            
                const deleteUrl = `${formApi}?${deleteParams.toString()}`;
                console.log('Delete old wallet URL:', deleteUrl);
            
                await fetch(deleteUrl, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    cache: 'no-cache'
                });
            
                console.log('✅ Кошелёк успешно заменен');
                
                // Clear cache for this form
                const formName = originalWallet.formName;
                localStorage.removeItem(`wallets_${formName}`);
                localStorage.removeItem(`wallets_${formName}_timestamp`);
                
                // Reload wallets
                await loadWallets();
                
                showToast(translations[currentLanguage]?.['toast.save_success'] || 'Кошелёк успешно обновлён', 'success');
                closeEditModal();
                
            } catch (error) {
                console.error('Error in saveWalletChanges:', error);
                showToast((translations[currentLanguage]?.['toast.save_error'] || 'Ошибка сохранения') + ': ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            } /*catch (error) {
                console.error('Error saving wallet:', error);
                showToast((translations[currentLanguage]?.['toast.save_error'] || 'Ошибка сохранения') + ': ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            }*/
        }
        
        // Add new wallet
        async function addNewWallet(event) {
            event.preventDefault();
            
            const btn = document.getElementById('addBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.classList.add('loading');
                btn.innerHTML = `<div class="loader"></div> ${translations[currentLanguage]?.['wallets.adding'] || 'Добавление...'}`;
                
                const formSelect = document.getElementById('addFormSelect');
                const selectedOption = formSelect.options[formSelect.selectedIndex];
                const formName = formSelect.value;
                const formApi = selectedOption.dataset.api;
                const walletType = document.getElementById('addWalletType').value;
                const walletName = document.getElementById('addWalletName').value || walletType;
                const walletNumber = document.getElementById('addWalletNumber').value;
                const walletEnabled = document.getElementById('addWalletEnabled').checked;
                
                console.log('=== ДАННЫЕ ДЛЯ ДОБАВЛЕНИЯ ===');
                console.log('Форма:', formName);
                console.log('API формы:', formApi);
                console.log('Тип кошелька:', walletType);
                console.log('Имя кошелька:', walletName);
                console.log('Номер кошелька:', walletNumber);
                console.log('Активен:', walletEnabled);
                
                if (!formName || !formApi) {
                    throw new Error('Пожалуйста, выберите форму');
                }
                
                if (!walletType || !walletNumber) {
                    throw new Error('Пожалуйста, заполните тип и номер кошелька');
                }
                
                // Создаем URL с параметрами
                const params = new URLSearchParams();
                params.append('action', 'add_wallet');
                params.append('type', walletType);
                params.append('name', walletName);
                params.append('number', walletNumber);
                params.append('enabled', walletEnabled.toString());
                
                // Добавляем timestamp для предотвращения кэширования
                params.append('_t', Date.now().toString());
                
                const addUrl = `${formApi}?${params.toString()}`;
                console.log('Полный URL запроса:', addUrl);
                
                // Пробуем разные методы запроса
                let response;
                let result;
                
                try {
                    console.log('Пробуем Method 1: прямой fetch...');
                    response = await fetch(addUrl, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        cache: 'no-cache'
                    });
                    
                    console.log('Response status:', response.status);
                    
                    const responseText = await response.text();
                    console.log('Response text:', responseText);
                    
                    // Пробуем распарсить JSON
                    try {
                        result = JSON.parse(responseText);
                        console.log('Parsed JSON result:', result);
                    } catch (parseError) {
                        console.warn('Не удалось распарсить JSON:', parseError);
                        // Может быть, это JSONP?
                        if (responseText.includes('(') && responseText.includes(')')) {
                            const jsonpMatch = responseText.match(/\((.*)\)/);
                            if (jsonpMatch && jsonpMatch[1]) {
                                result = JSON.parse(jsonpMatch[1]);
                                console.log('Parsed JSONP result:', result);
                            }
                        }
                        throw new Error('Некорректный ответ от сервера');
                    }
                    
                } catch (fetchError) {
                    console.warn('Method 1 failed:', fetchError);
                    
                    // Пробуем Method 2: через /exec
                    try {
                        console.log('Пробуем Method 2: через /exec...');
                        const execUrl = formApi.replace(/\/[^\/]*$/, '/exec') + '?' + params.toString();
                        console.log('Exec URL:', execUrl);
                        
                        response = await fetch(execUrl, {
                            method: 'GET',
                            headers: {
                                'Accept': 'application/json',
                            },
                            cache: 'no-cache'
                        });
                        
                        const responseText = await response.text();
                        console.log('Exec response text:', responseText);
                        
                        result = JSON.parse(responseText);
                        console.log('Exec parsed result:', result);
                        
                    } catch (execError) {
                        console.warn('Method 2 failed:', execError);
                        throw new Error('Не удалось подключиться к форме. Проверьте подключение.');
                    }
                }
                
                // Проверяем результат
                if (result && (result.success === true || result.status === 'success')) {
                    console.log('✅ Кошелек успешно добавлен');
                    
                    // Очищаем кэш
                    localStorage.removeItem(`wallets_${formName}`);
                    localStorage.removeItem(`wallets_${formName}_timestamp`);
                    
                    // Показываем успешное сообщение
                    showToast(
                        result.message || translations[currentLanguage]?.['toast.add_success'] || 'Кошелёк успешно добавлен', 
                        'success'
                    );
                    
                    // Перезагружаем кошельки
                    await loadWallets();
                    
                    // Закрываем модальное окно
                    closeAddModal();
                    
                } else {
                    // Показываем ошибку
                    const errorMsg = result?.error || result?.message || 'Неизвестная ошибка при добавлении кошелька';
                    console.error('Ошибка добавления кошелька:', errorMsg);
                    throw new Error(errorMsg);
                }
                
            } catch (error) {
                console.error('❌ Ошибка в addNewWallet:', error);
                
                // Более подробное сообщение об ошибке
                let errorMessage = error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Проблема с сетью. Проверьте подключение к интернету.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'Проблема с CORS. Попробуйте обновить страницу.';
                }
                
                showToast(
                    (translations[currentLanguage]?.['toast.add_error'] || 'Ошибка добавления') + ': ' + errorMessage, 
                    'error'
                );
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            }
        }
        
        // Toggle wallet status
        async function toggleWalletStatus(walletId, newStatus, button) {
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet || !wallet.formApi) return;
            
            try {
                // Add loading state to button
                const originalHTML = button.innerHTML;
                button.innerHTML = `<div class="loader"></div>`;
                button.disabled = true;
                
                const updateUrl = `${wallet.formApi}?action=update_wallet_status&wallet_type=${encodeURIComponent(wallet.type)}&wallet_number=${encodeURIComponent(wallet.number)}&enabled=${newStatus.toString()}`;
                
                await fetch(updateUrl, { method: 'GET', mode: 'no-cors' })
                    .catch(err => fetch(`${wallet.formApi}/exec?action=update_wallet_status&wallet_type=${wallet.type}&wallet_number=${wallet.number}&enabled=${newStatus}`));
                
                // Clear cache for this form
                localStorage.removeItem(`wallets_${wallet.formName}`);
                localStorage.removeItem(`wallets_${wallet.formName}_timestamp`);
                
                // Reload wallets
                await loadWallets();
                
                showToast(translations[currentLanguage]?.['toast.toggle_success'] || 'Статус кошелька изменён', 'success');
                
            } catch (error) {
                console.error('Error toggling wallet:', error);
                showToast((translations[currentLanguage]?.['toast.toggle_error'] || 'Ошибка при изменении статуса') + ': ' + error.message, 'error');
                
                // Restore button state on error
                if (button) {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            }
        }
        
        // Delete wallet
        async function deleteWallet(walletId, button) {
            if (!confirm(translations[currentLanguage]?.['wallets.delete'] || 'Удалить' + '?')) return;
            
            const wallet = allWallets.find(w => w.id === walletId);
            if (!wallet || !wallet.formApi) return;
            
            try {
                // Add loading state to button
                const originalHTML = button.innerHTML;
                button.innerHTML = `<div class="loader"></div>`;
                button.disabled = true;
                
                const deleteUrl = `${wallet.formApi}?action=delete_wallet&wallet_type=${encodeURIComponent(wallet.type)}&wallet_number=${encodeURIComponent(wallet.number)}`;
                
                await fetch(deleteUrl, { method: 'GET', mode: 'no-cors' })
                    .catch(err => fetch(`${wallet.formApi}/exec?action=delete_wallet&wallet_type=${wallet.type}&wallet_number=${wallet.number}`));
                
                // Clear cache for this form
                localStorage.removeItem(`wallets_${wallet.formName}`);
                localStorage.removeItem(`wallets_${wallet.formName}_timestamp`);
                
                // Reload wallets
                await loadWallets();
                
                showToast(translations[currentLanguage]?.['toast.delete_success'] || 'Кошелёк успешно удалён', 'success');
                
            } catch (error) {
                console.error('Error deleting wallet:', error);
                showToast((translations[currentLanguage]?.['toast.delete_error'] || 'Ошибка при удалении кошелька') + ': ' + error.message, 'error');
                
                // Restore button state on error
                if (button) {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            }
        }
        
        // Refresh wallets
        async function refreshWallets() {
            const btn = document.getElementById('refreshBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.classList.add('loading');
                btn.innerHTML = `<div class="loader"></div> ${translations[currentLanguage]?.['wallets.refreshing'] || 'Обновление...'}`;
                
                // Clear all cache
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('wallets_') || key.includes('_timestamp')) {
                        localStorage.removeItem(key);
                    }
                });
                apiCache.forms = null;
                apiCache.lastUpdated = null;
                
                await loadWallets();
                
                showToast(translations[currentLanguage]?.['toast.success'] || 'Данные обновлены', 'success');
                
            } catch (error) {
                console.error('Error refreshing:', error);
                showToast(translations[currentLanguage]?.['toast.error'], 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            }
        }
        
        // Logout
        async function logout() {
            const btn = document.getElementById('logoutBtn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.classList.add('loading');
                btn.innerHTML = `<div class="loader"></div> ...`;
                
                const token = localStorage.getItem('admin_token');
                await fetch(`${API_URL}?action=logout&token=${token}`).catch(() => {});
                
                // Clear all local storage
                localStorage.clear();
                
                // Redirect to login
                window.location.href = 'index.html';
                
            } catch (error) {
                console.error('Logout error:', error);
                showToast(translations[currentLanguage]?.['toast.logout_error'], 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            }
        }
        
        // ТУТОРИАЛ - ОСНОВНЫЕ ИСПРАВЛЕНИЯ
        
        // Start tutorial
       /* function startTutorial() {
            console.log('=== START TUTORIAL ===');
            
            isTutorialActive = true;
            currentTutorialStep = 0;
            highlightedElements.clear();
            
            // Прокручиваем к верху страницы
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Запрещаем скроллинг
            disableScroll();
            
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.classList.add('active');
            } else {
                console.error('Tutorial overlay element not found!');
                return;
            }
            
            // Даем время для прокрутки
            setTimeout(() => {
                updateTutorialStep();
            }, 300);
            
            localStorage.removeItem('wallets_tutorial_completed');
            
            console.log('=== TUTORIAL STARTED SUCCESSFULLY ===');
        }*/
        
        // Disable scroll during tutorial
        function disableScroll() {
            if (!isScrollingEnabled) return;
            
            isScrollingEnabled = false;
            
            // Сохраняем текущую позицию скролла
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
            
            // Функция для предотвращения скролла
            window.onscroll = function() {
                window.scrollTo(scrollLeft, scrollTop);
            };
            
            // Добавляем стили для body
            document.body.style.overflow = 'hidden';
            document.body.style.position = 'fixed';
            document.body.style.width = '100%';
            document.body.style.top = `-${scrollTop}px`;
        }
        
        // Enable scroll after tutorial
        function enableScroll() {
            if (isScrollingEnabled) return;
            
            isScrollingEnabled = true;
            
            // Восстанавливаем скролл
            window.onscroll = null;
            
            // Восстанавливаем стили body
            const scrollTop = parseInt(document.body.style.top || '0') * -1;
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.width = '';
            document.body.style.top = '';
            
            // Восстанавливаем позицию скролла
            window.scrollTo(0, scrollTop);
        }
        
        // Highlight element - УЛУЧШЕННАЯ ВЕРСИЯ
        function highlightElement(rect) {
            const highlight = document.getElementById('tutorialHighlight');
            
            if (!highlight) return;
            
            // Добавляем небольшие отступы
            const padding = 8;
            
            // Учитываем текущую позицию скролла
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            
            highlight.style.cssText = `
                display: block;
                top: ${rect.top + scrollY - padding}px;
                left: ${rect.left + scrollX - padding}px;
                width: ${rect.width + (padding * 2)}px;
                height: ${rect.height + (padding * 2)}px;
                pointer-events: none;
                z-index: 2003;
                transform: translateZ(0);
            `;
        }
        
        // Position popup
        function positionPopup(rect, position) {
            const popup = document.getElementById('tutorialPopup');
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Рассчитываем оптимальную позицию
            let top, left;
            
            switch(position) {
                case 'top':
                    top = Math.max(20, rect.top - 220);
                    left = Math.max(20, Math.min(rect.left - 200, viewportWidth - 420));
                    break;
                case 'bottom':
                    top = Math.min(viewportHeight - 320, rect.bottom + 25);
                    left = Math.max(20, Math.min(rect.left - 150, viewportWidth - 420));
                    break;
                case 'left':
                    top = Math.max(20, rect.top - 50);
                    left = Math.max(20, rect.left - 440);
                    break;
                case 'right':
                    top = Math.max(20, rect.top - 50);
                    left = Math.min(viewportWidth - 420, rect.right + 25);
                    break;
                default:
                    // Центр для финального шага
                    top = '50%';
                    left = '50%';
                    popup.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        max-width: 450px;
                        z-index: 2002;
                    `;
                    return;
            }
            
            popup.style.cssText = `
                position: absolute;
                top: ${top}px;
                left: ${left}px;
                max-width: 380px;
                z-index: 2002;
            `;
        }
        
        // Update tutorial step
        function updateTutorialStep() {
            // Очищаем стили от предыдущего шага
            resetElementStyles();
            
            const step = tutorialStepsConfig[currentTutorialStep];
            const dict = translations[currentLanguage];
            
            if (!step || !dict) {
                console.error('Step or dictionary not found');
                return;
            }
            
            // Update tutorial text
            document.getElementById('tutorialTitle').textContent = dict[step.title];
            document.getElementById('tutorialText').textContent = dict[step.description];
            document.getElementById('tutorialProgress').textContent = 
                `Шаг ${currentTutorialStep + 1} из ${tutorialStepsConfig.length}`;
            
            // Update buttons
            document.getElementById('prevBtn').style.display = currentTutorialStep === 0 ? 'none' : 'inline-block';
            document.getElementById('nextBtn').textContent = currentTutorialStep === tutorialStepsConfig.length - 1 ? 
                dict['tutorial.complete'] : dict['tutorial.next'];
            
            // Highlight element
            if (step.elementId) {
                if (step.elementId === 'editBtnPlaceholder') {
                    // Special case for edit button
                    if (step.action) step.action();
                } else {
                    const element = document.getElementById(step.elementId);
                    if (element) {
                        const rect = element.getBoundingClientRect();
                        highlightElement(rect);
                        positionPopup(rect, step.position);
                        
                        // Выделяем элемент на передний план
                        element.classList.add('tutorial-highlighted-element');
                        element.style.zIndex = '2004';
                        element.style.position = 'relative';
                        
                        // Execute custom action if exists
                        if (step.action) {
                            setTimeout(() => {
                                if (step.action) step.action();
                            }, 300);
                        }
                    }
                }
            } else {
                // Center popup for final step
                document.getElementById('tutorialHighlight').style.display = 'none';
                document.getElementById('tutorialPopup').style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    z-index: 2002;
                    max-width: 450px;
                `;
            }
        }
        
        // Reset element styles
        function resetElementStyles() {
            // Убираем классы подсветки
            document.querySelectorAll('.tutorial-highlighted-element').forEach(el => {
                el.classList.remove('tutorial-highlighted-element');
                el.style.zIndex = '';
                el.style.position = '';
            });
            
            // Скрываем подсветку
            const highlight = document.getElementById('tutorialHighlight');
            if (highlight) {
                highlight.style.display = 'none';
            }
        }
        
        // Next tutorial step
        function nextTutorialStep() {
            if (currentTutorialStep < tutorialStepsConfig.length - 1) {
                currentTutorialStep++;
                updateTutorialStep();
            } else {
                completeTutorial();
            }
        }
        
        // Previous tutorial step
        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialStep();
            }
        }
        
        // Skip tutorial
        function skipTutorial() {
            if (confirm(translations[currentLanguage]?.['tutorial.skip'] || 'Пропустить обучение?')) {
                completeTutorial();
            }
        }
        
        // Complete tutorial
        function completeTutorial() {
            isTutorialActive = false;
            
            // Восстанавливаем скроллинг
            enableScroll();
            
            // Очищаем стили
            resetElementStyles();
            
            // Скрываем overlay
            const overlay = document.getElementById('tutorialOverlay');
            if (overlay) {
                overlay.classList.remove('active');
            }
            
            localStorage.setItem('wallets_tutorial_completed', 'true');
            showToast(translations[currentLanguage]?.['tutorial.complete'] || 'Обучение завершено!', 'success');
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Burger menu
            const burgerMenu = document.getElementById('burgerMenu');
            const sidebar = document.getElementById('sidebar');
            
            burgerMenu.addEventListener('click', toggleSidebar);
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !burgerMenu.contains(e.target) &&
                    sidebar.classList.contains('mobile-open')) {
                    sidebar.classList.remove('mobile-open');
                }
            });
            
            // Language selector
            const languageBtn = document.getElementById('languageBtn');
            const languageDropdown = document.getElementById('languageDropdown');
            
            languageBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                languageDropdown.classList.toggle('show');
            });
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.getAttribute('data-lang');
                    applyTranslation(lang);
                    languageDropdown.classList.remove('show');
                    refreshWallets();
                });
            });
            
            document.addEventListener('click', function() {
                languageDropdown.classList.remove('show');
            });
            
            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
            
            // Разрешаем клики через overlay НА КНОПКИ ТУТОРИАЛА
            document.getElementById('tutorialOverlay').addEventListener('click', function(e) {
                if (!isTutorialActive) return;
                
                // Если кликнули на кнопки туториала - пропускаем
                if (e.target.closest('.tutorial-popup') || 
                    e.target.closest('.tutorial-btn') ||
                    e.target.closest('.tutorial-close-btn')) {
                    return;
                }
                
                // Если кликнули на подсвечиваемый элемент - переходим дальше
                const highlight = document.getElementById('tutorialHighlight');
                if (highlight && highlight.style.display !== 'none') {
                    const rect = highlight.getBoundingClientRect();
                    
                    // Проверяем, был ли клик внутри подсветки
                    if (e.clientX >= rect.left && e.clientX <= rect.right &&
                        e.clientY >= rect.top && e.clientY <= rect.bottom) {
                        
                        // Ищем реальный элемент под курсором
                        const element = document.elementFromPoint(e.clientX, e.clientY);
                        if (element && !element.closest('.tutorial-popup')) {
                            // Клик на подсвечиваемый элемент - переходим дальше
                            setTimeout(nextTutorialStep, 100);
                        }
                    }
                }
            });
            
            // Load page data
            loadPageData();
        });
    </script>
</body>
</html>
