<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #042F28 0%, #0A5C4A 100%);
            --accent: #D0E41E;
            --text: white;
            --card-bg: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: var(--primary-bg); color: var(--text); min-height: 100vh; }
        
        /* –®–∞–ø–∫–∞ */
        .header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-title { font-size: 24px; font-weight: bold; color: var(--accent); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { 
            padding: 8px 15px; 
            background: rgba(231, 76, 60, 0.2); 
            color: #e74c3c; 
            border: 1px solid #e74c3c; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { 
            display: flex; 
            background: rgba(255, 255, 255, 0.05); 
            border-bottom: 1px solid var(--border); 
            padding: 0 20px; 
            gap: 5px; 
        }
        .tab { 
            padding: 15px 25px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s; 
        }
        .tab.active { 
            background: var(--card-bg); 
            border-bottom-color: var(--accent); 
            color: var(--accent); 
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">üí∞ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
        <div class="user-info">
            <span id="currentUser">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</div>
        <div class="tab" onclick="switchTab('wallets')">üëõ –ö–æ—à–µ–ª—å–∫–∏</div>
        <div class="tab" onclick="switchTab('forms')">üåê –§–æ—Ä–º—ã</div>
        <div class="tab" onclick="switchTab('agents')">üë• –ê–≥–µ–Ω—Ç—ã</div>
        <div class="tab" onclick="switchTab('history')">üìà –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="tab" onclick="switchTab('admins')">üõ°Ô∏è –ê–¥–º–∏–Ω—ã</div>
    </div>
    
    <div class="content">
        <!-- –î–∞—à–±–æ—Ä–¥ -->
        <div id="dashboardTab" class="tab-content active">
            <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            <div class="loader"></div>
        </div>
        
        <!-- –ö–æ—à–µ–ª—å–∫–∏ (–û–°–ù–û–í–ù–û–ô –§–£–ù–ö–¶–ò–û–ù–ê–õ) -->
        <div id="walletsTab" class="tab-content">
            <h2>üëõ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞–º–∏</h2>
            <button onclick="loadWallets()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            <div id="walletsList" style="margin-top: 20px;">
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤...</p>
                <div class="loader"></div>
            </div>
        </div>
        
        <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <div id="formsTab" class="tab-content"><p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏...</p></div>
        <div id="agentsTab" class="tab-content"><p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏...</p></div>
        <div id="historyTab" class="tab-content"><p>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π...</p></div>
        <div id="adminsTab" class="tab-content"><p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏...</p></div>
    </div>

    <script>
        const API_URL = '–í–ê–®_API_URL'; // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –ù–ê –í–ê–® –†–ï–ê–õ–¨–ù–´–ô URL
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('admin_token');
            const user = localStorage.getItem('admin_user');
            
            if (!token || !user) {
                window.location.href = 'login.html';
                return;
            }
            
            try {
                const userData = JSON.parse(user);
                document.getElementById('currentUser').textContent = `${userData.username} (${userData.role})`;
                loadDashboard();
            } catch (e) {
                logout();
            }
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞
        async function loadDashboard() {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}/admin?action=get_dashboard_data&token=${token}`);
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('dashboardTab').innerHTML = `
                        <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${result.stats.totalWallets || 0}</div>
                                <div>–í—Å–µ–≥–æ –∫–æ—à–µ–ª—å–∫–æ–≤</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${result.stats.activeWallets || 0}</div>
                                <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${result.stats.totalForms || 0}</div>
                                <div>–§–æ—Ä–º</div>
                            </div>
                            <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center;">
                                <div style="font-size: 32px;">${result.stats.totalAgents || 0}</div>
                                <div>–ê–≥–µ–Ω—Ç–æ–≤</div>
                            </div>
                        </div>
                    `;
                } else {
                    if (result.code === 'UNAUTHORIZED') logout();
                }
            } catch (error) {
                console.error('Dashboard error:', error);
            }
        }
        
        // === –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–ê–ì–†–£–ó–ö–ê –ö–û–®–ï–õ–¨–ö–û–í ===
        async function loadWallets() {
            const container = document.getElementById('walletsList');
            container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
            
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}/admin?action=get_all_wallets&token=${token}`);
                const result = await response.json();
                
                if (result.success) {
                    if (result.wallets.length === 0) {
                        container.innerHTML = '<p>–ö–æ—à–µ–ª—å–∫–æ–≤ –Ω–µ—Ç</p>';
                        return;
                    }
                    
                    let html = `
                        <table style="width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden;">
                            <thead>
                                <tr style="background: rgba(0,0,0,0.3);">
                                    <th style="padding: 15px; text-align: left;">–¢–∏–ø</th>
                                    <th style="padding: 15px; text-align: left;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th style="padding: 15px; text-align: left;">–ù–æ–º–µ—Ä</th>
                                    <th style="padding: 15px; text-align: left;">–°—Ç–∞—Ç—É—Å</th>
                                    <th style="padding: 15px; text-align: left;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    result.wallets.forEach(wallet => {
                        html += `
                            <tr style="border-bottom: 1px solid var(--border);">
                                <td style="padding: 15px;">${wallet.type}</td>
                                <td style="padding: 15px;">${wallet.name}</td>
                                <td style="padding: 15px;">
                                    <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; cursor: pointer;" onclick="copyToClipboard('${wallet.number}')">${wallet.number}</code>
                                </td>
                                <td style="padding: 15px;">
                                    <span style="color: ${wallet.enabled ? '#2ecc71' : '#e74c3c'}">
                                        ${wallet.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω'}
                                    </span>
                                </td>
                                <td style="padding: 15px;">
                                    <button style="padding: 5px 10px; margin-right: 5px; background: ${wallet.enabled ? '#e74c3c' : '#2ecc71'}; color: white; border: none; border-radius: 5px; cursor: pointer;" 
                                            onclick="toggleWallet(${wallet.row}, ${!wallet.enabled})">
                                        ${wallet.enabled ? '–û—Ç–∫–ª—é—á–∏—Ç—å' : '–í–∫–ª—é—á–∏—Ç—å'}
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${result.error}</p>`;
                }
            } catch (error) {
                container.innerHTML = `<p style="color: #e74c3c">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}</p>`;
            }
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–æ—à–µ–ª—å–∫–∞
        async function toggleWallet(walletId, newStatus) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${newStatus ? '–≤–∫–ª—é—á–∏—Ç—å' : '–æ—Ç–∫–ª—é—á–∏—Ç—å'} —ç—Ç–æ—Ç –∫–æ—à–µ–ª—ë–∫?`)) return;
            
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}/admin?action=update_wallet&token=${token}&wallet_id=${walletId}&enabled=${newStatus}`);
                const result = await response.json();
                
                if (result.success) {
                    alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    loadWallets(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text);
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
        function switchTab(tabName) {
            // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (tabName === 'wallets') loadWallets();
        }
        
        // –í—ã—Ö–æ–¥
        async function logout() {
            const token = localStorage.getItem('admin_token');
            if (token) {
                await fetch(`${API_URL}/admin?action=logout&token=${token}`);
            }
            localStorage.clear();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
