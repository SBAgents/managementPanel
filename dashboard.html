<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #042F28 0%, #0A5C4A 100%);
            --accent: #D0E41E;
            --text: white;
            --card-bg: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: var(--primary-bg); color: var(--text); min-height: 100vh; }
        
        /* –®–∞–ø–∫–∞ */
        .header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-title { font-size: 24px; font-weight: bold; color: var(--accent); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { 
            padding: 8px 15px; 
            background: rgba(231, 76, 60, 0.2); 
            color: #e74c3c; 
            border: 1px solid #e74c3c; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { 
            display: flex; 
            background: rgba(255, 255, 255, 0.05); 
            border-bottom: 1px solid var(--border); 
            padding: 0 20px; 
            gap: 5px; 
        }
        .tab { 
            padding: 15px 25px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s; 
        }
        .tab.active { 
            background: var(--card-bg); 
            border-bottom-color: var(--accent); 
            color: var(--accent); 
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; color: var(--accent); }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .wallet-table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .wallet-table th { background: rgba(0,0,0,0.3); padding: 15px; text-align: left; }
        .wallet-table td { padding: 15px; border-bottom: 1px solid var(--border); }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { padding: 10px 20px; background: var(--accent); color: #2c3e50; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn:hover { background: #b8cc1a; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        
        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –¥–∞—à–±–æ—Ä–¥–µ */
.clickable {
    cursor: pointer;
    transition: all 0.3s;
    border: 2px solid transparent;
}

.clickable:hover {
    transform: translateY(-5px);
    border-color: var(--accent);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* –¢–∞–±–ª–∏—Ü—ã */
.wallet-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 10px;
    overflow: hidden;
    margin-top: 20px;
}

.wallet-table th {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    text-align: left;
    font-weight: bold;
}

.wallet-table td {
    padding: 15px;
    border-bottom: 1px solid var(--border);
}

.wallet-table tr:hover {
    background: rgba(255,255,255,0.05);
}
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">üí∞ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
        <div class="user-info">
            <span id="currentUser">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</div>
        <div class="tab" onclick="switchTab('wallets')">üëõ –ö–æ—à–µ–ª—å–∫–∏</div>
        <div class="tab" onclick="switchTab('forms')">üåê –§–æ—Ä–º—ã</div>
        <div class="tab" onclick="switchTab('agents')">üë• –ê–≥–µ–Ω—Ç—ã</div>
        <div class="tab" onclick="switchTab('history')">üìà –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="tab" onclick="switchTab('admins')">üõ°Ô∏è –ê–¥–º–∏–Ω—ã</div>
    </div>
    
    <div class="content">
    <!-- –î–∞—à–±–æ—Ä–¥ -->
    <div id="dashboardTab" class="tab-content active">
        <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
        <div id="dashboardStats">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            <div class="loader"></div>
        </div>
    </div>
    
    <!-- –ö–æ—à–µ–ª—å–∫–∏ -->
    <div id="walletsTab" class="tab-content">
        <h2>üëõ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞–º–∏</h2>
        <button class="btn" onclick="loadWallets()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <button class="btn btn-success" onclick="showAddWalletForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
        <div id="walletsList" style="margin-top: 20px;">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤...</p>
            <div class="loader"></div>
        </div>
    </div>
    
    <!-- –§–æ—Ä–º—ã -->
    <div id="formsTab" class="tab-content">
        <h2>üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏</h2>
        <button class="btn" onclick="loadForms()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—ã</button>
        <div id="formsList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—ã" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
    
    <!-- –ê–≥–µ–Ω—Ç—ã -->
    <div id="agentsTab" class="tab-content">
        <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏</h2>
        <button class="btn" onclick="loadAgents()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤</button>
        <div id="agentsList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div id="historyTab" class="tab-content">
        <h2>üìà –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        <div style="margin-bottom: 15px;">
            <input type="text" id="historyFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ—Ä–º–µ..." style="padding: 8px; width: 300px; margin-right: 10px;">
            <button class="btn" onclick="loadHistory()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <button class="btn" onclick="clearHistoryFilter()">‚ùå –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
        </div>
        <div id="historyList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
    
    <!-- –ê–¥–º–∏–Ω—ã -->
    <div id="adminsTab" class="tab-content">
        <h2>üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</h2>
        <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
            <h3>–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞</h3>
            <div style="display: grid; gap: 10px; max-width: 500px;">
                <input type="text" id="newAdminUsername" placeholder="–õ–æ–≥–∏–Ω" style="padding: 10px;">
                <input type="password" id="newAdminPassword" placeholder="–ü–∞—Ä–æ–ª—å" style="padding: 10px;">
                <input type="email" id="newAdminEmail" placeholder="Email" style="padding: 10px;">
                <select id="newAdminRole" style="padding: 10px;">
                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                    <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                    <option value="viewer">–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                </select>
                <button class="btn btn-success" onclick="createNewAdmin()">‚ûï –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∞</button>
            </div>
        </div>
        <button class="btn" onclick="loadAdmins()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤</button>
        <div id="adminsList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
</div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxDaBdYMx44M2W3FsJp5tOECFTRD6rWrhPAC96MuUexROt5Qjgj4U0er4So6Ehsh8xQ5g/exec';

        // ========== –°–ò–°–¢–ï–ú–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø –ö–û–®–ï–õ–¨–ö–û–í ==========

// –ö–ª—é—á–∏ –¥–ª—è localStorage
const CACHE_KEYS = {
    WALLETS: 'cached_wallets',
    WALLETS_TIMESTAMP: 'wallets_timestamp',
    CACHE_DURATION: 5 * 60 * 1000 // 5 –º–∏–Ω—É—Ç –∫—ç—à
};

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏ –≤ –∫—ç—à
function saveWalletsToCache(wallets) {
    try {
        const cacheData = {
            wallets: wallets,
            timestamp: Date.now()
        };
        localStorage.setItem(CACHE_KEYS.WALLETS, JSON.stringify(cacheData));
        console.log('‚úÖ –ö–æ—à–µ–ª—å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à:', error);
    }
}

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –∫—ç—à–∞
function getWalletsFromCache() {
    try {
        const cachedData = localStorage.getItem(CACHE_KEYS.WALLETS);
        if (!cachedData) return null;
        
        const data = JSON.parse(cachedData);
        const now = Date.now();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –ª–∏ –¥–∞–Ω–Ω—ã–µ
        if (now - data.timestamp > CACHE_KEYS.CACHE_DURATION) {
            console.log('–ö—ç—à —É—Å—Ç–∞—Ä–µ–ª, —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ');
            return null;
        }
        
        console.log('‚úÖ –ö–æ—à–µ–ª—å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞');
        return data.wallets;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞:', error);
        return null;
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–æ—Ä–º (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
async function loadAllWalletsFromForms(forceRefresh = false) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if (!forceRefresh) {
        const cachedWallets = getWalletsFromCache();
        if (cachedWallets) {
            return cachedWallets;
        }
    }
    
    console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –∏–∑ —Ñ–æ—Ä–º...');
    
    try {
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        if (!formsResult.success || !formsResult.forms) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º');
            return {};
        }
        
        const allWallets = {};
        const formWalletsMap = {};
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã
        for (const form of formsResult.forms) {
            if (!form.formAPI) continue;
            
            try {
                console.log(`üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã: ${form.formName}`);
                
                const walletResponse = await fetch(`${form.formAPI}?action=get_wallets`);
                const walletResult = await walletResponse.json();
                
                if (walletResult.status === 'success' && walletResult.wallets) {
                    formWalletsMap[form.formName] = [];
                    
                    Object.entries(walletResult.wallets).forEach(([walletType, walletData]) => {
                        if (walletData.enabled && walletData.availableNumbers) {
                            walletData.availableNumbers.forEach(walletNumber => {
                                const walletKey = `${walletType}_${walletNumber}`;
                                
                                if (!allWallets[walletKey]) {
                                    allWallets[walletKey] = {
                                        type: walletType,
                                        name: walletData.name || walletType,
                                        number: walletNumber,
                                        enabled: walletData.enabled,
                                        forms: [form.formName],
                                        formAPIs: [form.formAPI]
                                    };
                                } else {
                                    if (!allWallets[walletKey].forms.includes(form.formName)) {
                                        allWallets[walletKey].forms.push(form.formName);
                                        allWallets[walletKey].formAPIs.push(form.formAPI);
                                    }
                                }
                                
                                formWalletsMap[form.formName].push(walletKey);
                            });
                        }
                    });
                }
            } catch (formError) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã ${form.formName}:`, formError);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        saveWalletsToCache(allWallets);
        
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(allWallets).length} –∫–æ—à–µ–ª—å–∫–æ–≤`);
        return allWallets;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤:', error);
        return {};
    }
}

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
async function refreshWalletsCache() {
    try {
        console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∫–æ—à–µ–ª—å–∫–æ–≤');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const oldWallets = getWalletsFromCache();
        const wasCached = oldWallets !== null;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const newWallets = await loadAllWalletsFromForms(true);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ –∏ –≤–∫–ª–∞–¥–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
        loadDashboard();
        
        // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –∞–∫—Ç–∏–≤–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
        if (document.getElementById('walletsTab').classList.contains('active')) {
            loadWallets();
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        alert(`‚úÖ –ö—ç—à –∫–æ—à–µ–ª—å–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!\n\n–ë—ã–ª–æ –≤ –∫—ç—à–µ: ${wasCached ? Object.keys(oldWallets || {}).length : 0}\n–°—Ç–∞–ª–æ: ${Object.keys(newWallets).length}`);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞: ' + error.message);
    }
}

        // –°–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
        function hideUnauthorizedTabs() {
    const permissions = JSON.parse(localStorage.getItem('admin_permissions') || '{}');
    
    // –û—Ç–ª–∞–¥–∫–∞ - –ø–æ—Å–º–æ—Ç—Ä–∏–º —á—Ç–æ –≤ permissions
    console.log('Permissions from localStorage:', permissions);
    console.log('Current user:', JSON.parse(localStorage.getItem('admin_user') || '{}'));
    
    // –ï—Å–ª–∏ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
    if (user.role === 'superadmin') {
        console.log('Superadmin detected - showing all tabs');
        return; // –ù–µ —Å–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞
    }
    
    const tabsToCheck = {
        'wallets': permissions.canManageWallets,
        'forms': permissions.canViewHistory || permissions.canManageWallets,
        'agents': permissions.canManageAdmins,
        'history': permissions.canViewHistory,
        'admins': permissions.canManageAdmins
    };
    
    // –û—Ç–ª–∞–¥–∫–∞ - –∫–∞–∫–∏–µ –≤–∫–ª–∞–¥–∫–∏ –±—É–¥—É—Ç —Å–∫—Ä—ã—Ç—ã
    console.log('Tabs check:', tabsToCheck);
    
    Object.entries(tabsToCheck).forEach(([tabName, hasPermission]) => {
        const tabElement = document.querySelector(`.tab[onclick*="${tabName}"]`);
        if (tabElement && !hasPermission) {
            console.log(`Hiding tab: ${tabName}`);
            tabElement.style.display = 'none';
        }
        });
    }
        
        document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('admin_token');
    const user = localStorage.getItem('admin_user');
    
    if (!token || !user) {
        window.location.href = 'login.html';
        return;
    }
    
    try {
        const userData = JSON.parse(user);
        document.getElementById('currentUser').textContent = `${userData.username} (${userData.role})`;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞
        hideUnauthorizedTabs();
        
        loadDashboard();
    } catch (e) {
        logout();
    }
});
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
          async function loadDashboard() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('dashboardStats');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞...</p><div class="loader"></div>';
        
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞–Ω–µ–ª–∏
        const dashboardResponse = await fetch(`${API_URL}?action=get_dashboard_data&token=${token}`);
        const dashboardResult = await dashboardResponse.json();
        
        if (!dashboardResult.success) {
            if (dashboardResult.code === 'UNAUTHORIZED') logout();
            throw new Error(dashboardResult.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞');
        }
        
        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º
        const wallets = await loadAllWalletsFromForms();
        const walletsArray = Object.values(wallets);
        const activeWallets = walletsArray.filter(w => w.enabled);
        
        console.log('–ö–æ—à–µ–ª—å–∫–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞:', {
            total: walletsArray.length,
            active: activeWallets.length
        });
        
        // 3. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞—à–±–æ—Ä–¥
        container.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card clickable" onclick="switchTab('wallets')">
                    <div class="stat-number">${activeWallets.length}</div>
                    <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –í—Å–µ–≥–æ: ${walletsArray.length}
                    </div>
                </div>
                <div class="stat-card clickable" onclick="switchTab('forms')">
                    <div class="stat-number">${dashboardResult.stats.totalForms || 0}</div>
                    <div>–§–æ—Ä–º</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${dashboardResult.stats.activeForms || 0}
                    </div>
                </div>
                <div class="stat-card clickable" onclick="switchTab('agents')">
                    <div class="stat-number">${dashboardResult.stats.totalAgents || 0}</div>
                    <div>–ê–≥–µ–Ω—Ç–æ–≤</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –í —Å–µ—Ç–∏: ${getOnlineAgentsCount(dashboardResult.stats.totalAgents)}
                    </div>
                </div>
                <div class="stat-card clickable" onclick="switchTab('history')">
                    <div class="stat-number">üìà</div>
                    <div>–ò—Å—Ç–æ—Ä–∏—è</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                    </div>
                </div>
            </div>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ -->
            <div style="margin-top: 30px; background: var(--card-bg); padding: 20px; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üî• –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏ (${activeWallets.length})</h3>
                    <div>
                        <button class="btn" onclick="refreshWalletsCache()" style="padding: 8px 15px; font-size: 14px;">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="btn" onclick="switchTab('wallets')" style="padding: 8px 15px; font-size: 14px; margin-left: 10px;">
                            üëÅÔ∏è –í—Å–µ –∫–æ—à–µ–ª—å–∫–∏
                        </button>
                    </div>
                </div>
                
                ${activeWallets.length > 0 ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        ${activeWallets.slice(0, 6).map(wallet => `
                            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid ${getWalletTypeColor(wallet.type)};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${wallet.name}</strong>
                                        <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                                            ${wallet.type}
                                        </div>
                                    </div>
                                    <span style="background: ${getWalletTypeColor(wallet.type)}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                        ${wallet.forms.length} —Ñ–æ—Ä–º
                                    </span>
                                </div>
                                <div style="margin-top: 10px;">
                                    <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; font-size: 14px; cursor: pointer;" 
                                          onclick="copyToClipboard('${wallet.number}')">
                                        ${wallet.number}
                                    </code>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${activeWallets.length > 6 ? `
                        <div style="text-align: center; margin-top: 15px; color: #3498db; cursor: pointer;" 
                             onclick="switchTab('wallets')">
                            + –µ—â—ë ${activeWallets.length - 6} –∫–æ—à–µ–ª—å–∫–æ–≤
                        </div>
                    ` : ''}
                ` : `
                    <div style="text-align: center; padding: 30px; color: #95a5a6;">
                        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</p>
                        <button class="btn" onclick="switchTab('wallets')" style="margin-top: 10px;">
                            –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ—à–µ–ª—å–∫–∞–º
                        </button>
                    </div>
                `}
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 10px;">
                <div>
                    <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–∞–∑–¥–µ–ª—É
                </div>
                <div style="font-size: 12px; color: #95a5a6;">
                    –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${new Date().toLocaleTimeString()}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Dashboard error:', error);
        container.innerHTML = `
            <p style="color: #e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞: ${error.message}</p>
            <button class="btn" onclick="loadDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
        `;
    }
}

        // ========== –§–û–†–ú–´ ==========
async function loadForms() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('formsList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
        
        const response = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const result = await response.json();
        
        if (result.success && result.forms && result.forms.length > 0) {
            let html = '<table class="wallet-table"><thead><tr>';
            html += '<th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã</th><th>API URL</th><th>–†–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è</th><th>–°—Ç–∞—Ç—É—Å</th><th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th></tr></thead><tbody>';
            
            result.forms.forEach(form => {
                html += `
                    <tr>
                        <td><strong>${form.formName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong></td>
                        <td><code style="font-size: 12px">${form.formAPI || '–ù–µ—Ç URL'}</code></td>
                        <td>${form.serviceMode ? 'üîß –í–ö–õ–Æ–ß–ï–ù' : '‚úÖ –í—ã–∫–ª—é—á–µ–Ω'}</td>
                        <td>
                            <span style="color: ${form.enabled ? '#2ecc71' : '#e74c3c'}">
                                ${form.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞'}
                            </span>
                        </td>
                        <td>${form.updatedAt ? new Date(form.updatedAt).toLocaleDateString() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p>–§–æ—Ä–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ä–º—ã –≤ —Ç–∞–±–ª–∏—Ü—É FORM_SETTINGS.</p>';
        }
    } catch (error) {
        document.getElementById('formsList').innerHTML = 
            `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
}

// ========== –ê–ì–ï–ù–¢–´ ==========
async function loadAgents() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('agentsList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
        
        const response = await fetch(`${API_URL}?action=get_agents&token=${token}`);
        const result = await response.json();
        
        if (result.success && result.agents && result.agents.length > 0) {
            let html = '<table class="wallet-table"><thead><tr>';
            html += '<th>–õ–æ–≥–∏–Ω</th><th>Email</th><th>–†–æ–ª—å</th><th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
            
            result.agents.forEach(agent => {
                const lastLogin = agent.lastLogin ? 
                    new Date(agent.lastLogin).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞';
                const isOnline = isAgentOnline(agent.lastLogin);
                
                html += `
                    <tr>
                        <td><strong>${agent.username}</strong></td>
                        <td>${agent.email || '–ù–µ—Ç email'}</td>
                        <td>
                            <span style="background: ${getRoleColor(agent.role)}; padding: 3px 8px; border-radius: 12px; color: white; font-size: 12px;">
                                ${agent.role}
                            </span>
                        </td>
                        <td>${lastLogin}</td>
                        <td>
                            <span style="color: ${isOnline ? '#2ecc71' : '#95a5a6'}">
                                ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –û—Ñ–ª–∞–π–Ω'}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p>–ê–≥–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
        }
    } catch (error) {
        document.getElementById('agentsList').innerHTML = 
            `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
}

// ========== –ò–°–¢–û–†–ò–Ø ==========
async function loadHistory() {
    try {
        const token = localStorage.getItem('admin_token');
        const filter = document.getElementById('historyFilter').value;
        const container = document.getElementById('historyList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
        
        let url = `${API_URL}?action=get_wallet_history&token=${token}`;
        if (filter) {
            url += `&form_name=${encodeURIComponent(filter)}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.history && result.history.length > 0) {
            let html = `<p>–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.count}</p>`;
            html += '<table class="wallet-table"><thead><tr>';
            html += '<th>–§–æ—Ä–º–∞</th><th>–¢–∏–ø –∫–æ—à–µ–ª—å–∫–∞</th><th>–ù–æ–º–µ—Ä</th><th>–ê–≥–µ–Ω—Ç</th><th>–í—Ä–µ–º—è</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
            
            result.history.forEach(record => {
                html += `
                    <tr>
                        <td><strong>${record.formName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></td>
                        <td>${record.walletType || '‚Äî'}</td>
                        <td><code>${record.walletNumber || '‚Äî'}</code></td>
                        <td>${record.agentId || '–°–∏—Å—Ç–µ–º–∞'}</td>
                        <td>${record.usedAt ? new Date(record.usedAt).toLocaleString() : '‚Äî'}</td>
                        <td style="color: #2ecc71; font-weight: bold;">${record.amount || 0}</td>
                        <td>
                            <span style="color: ${record.status === 'success' ? '#2ecc71' : '#e74c3c'}">
                                ${record.status === 'success' ? '‚úÖ –£—Å–ø–µ—Ö' : record.status || '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞.</p>';
        }
    } catch (error) {
        document.getElementById('historyList').innerHTML = 
            `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
}

function clearHistoryFilter() {
    document.getElementById('historyFilter').value = '';
    loadHistory();
}

// ========== –ê–î–ú–ò–ù–´ ==========
async function loadAdmins() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('adminsList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
        
        const response = await fetch(`${API_URL}?action=get_agents&token=${token}`);
        const result = await response.json();
        
        if (result.success && result.agents && result.agents.length > 0) {
            let html = '<table class="wallet-table"><thead><tr>';
            html += '<th>–õ–æ–≥–∏–Ω</th><th>Email</th><th>–†–æ–ª—å</th><th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead><tbody>';
            
            result.agents.forEach(admin => {
                const lastLogin = admin.lastLogin ? 
                    new Date(admin.lastLogin).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞';
                
                html += `
                    <tr>
                        <td><strong>${admin.username}</strong></td>
                        <td>${admin.email || '‚Äî'}</td>
                        <td>
                            <span style="background: ${getRoleColor(admin.role)}; padding: 3px 8px; border-radius: 12px; color: white; font-size: 12px;">
                                ${admin.role}
                            </span>
                        </td>
                        <td>${lastLogin}</td>
                        <td>
                            <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                                    onclick="editAdmin('${admin.username}')">‚úèÔ∏è</button>
                            ${admin.role !== 'superadmin' ? 
                                `<button class="btn btn-danger" style="padding: 5px 10px; font-size: 12px;" 
                                        onclick="deleteAdmin('${admin.username}')">üóëÔ∏è</button>` : 
                                '<span style="color: #7f8c8d; font-size: 12px;">–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>';
        }
    } catch (error) {
        document.getElementById('adminsList').innerHTML = 
            `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
}

async function createNewAdmin() {
    const username = document.getElementById('newAdminUsername').value.trim();
    const password = document.getElementById('newAdminPassword').value.trim();
    const email = document.getElementById('newAdminEmail').value.trim();
    const role = document.getElementById('newAdminRole').value;
    
    if (!username || !password) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
        return;
    }
    
    try {
        const token = localStorage.getItem('admin_token');
        const url = `${API_URL}?action=create_admin&token=${token}&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&email=${encodeURIComponent(email)}&role=${role}`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ –ê–¥–º–∏–Ω —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('newAdminUsername').value = '';
            document.getElementById('newAdminPassword').value = '';
            document.getElementById('newAdminEmail').value = '';
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            loadAdmins();
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
    }
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function getRoleColor(role) {
    switch(role) {
        case 'superadmin': return '#e74c3c';
        case 'admin': return '#3498db';
        case 'manager': return '#2ecc71';
        case 'viewer': return '#95a5a6';
        default: return '#7f8c8d';
    }
}

function isAgentOnline(lastLogin) {
    if (!lastLogin) return false;
    const lastLoginTime = new Date(lastLogin).getTime();
    const now = Date.now();
    // –°—á–∏—Ç–∞–µ–º –æ–Ω–ª–∞–π–Ω, –µ—Å–ª–∏ –±—ã–ª –≤ —Å–µ—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
    return (now - lastLoginTime) < 30 * 60 * 1000;
}

function editAdmin(username) {
    alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞: ' + username + '\n(—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}

function deleteAdmin(username) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ "${username}"?`)) {
        alert('–£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞: ' + username + '\n(—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É)
function getOnlineAgentsCount(total) {
    return Math.floor(total * 0.7); // –ü—Ä–∏–º–µ—Ä: 70% –æ–Ω–ª–∞–π–Ω
}
        
                // ========== –ö–û–®–ï–õ–¨–ö–ò (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ==========
           async function loadWallets(forceRefresh = false) {
    try {
        const container = document.getElementById('walletsList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤...</p><div class="loader"></div>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ —Ñ–æ—Ä–º
        const wallets = await loadAllWalletsFromForms(forceRefresh);
        const walletsArray = Object.values(wallets);
        
        console.log('–ö–æ—à–µ–ª—å–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', walletsArray.length);
        
        if (walletsArray.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ö</p>
                    <button class="btn" onclick="loadWallets(true)" style="margin-top: 10px;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            `;
            return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∫–∞–∫ –±—ã–ª, –Ω–æ —Å walletsArray)
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>–ö–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º: ${walletsArray.length}</h3>
                <div>
                    <button class="btn" onclick="loadWallets(true)" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-success" onclick="showAddWalletForm()" style="margin-left: 10px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
            <table class="wallet-table">
                <thead>
                    <tr>
                        <th>–¢–∏–ø</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–æ–º–µ—Ä</th>
                        <th>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ö</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        walletsArray.forEach(wallet => {
            const walletTypeColor = getWalletTypeColor(wallet.type);
            
            html += `
                <tr>
                    <td>
                        <span style="background: ${walletTypeColor}; padding: 5px 10px; border-radius: 15px; color: white; font-size: 12px;">
                            ${wallet.type}
                        </span>
                    </td>
                    <td>${wallet.name}</td>
                    <td>
                        <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; cursor: pointer;" 
                              onclick="copyToClipboard('${wallet.number}')">
                            ${wallet.number}
                        </code>
                    </td>
                    <td>
                        ${wallet.forms.map(formName => 
                            `<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 10px; margin: 2px; display: inline-block; font-size: 12px;">
                                ${formName}
                            </span>`
                        ).join('')}
                    </td>
                    <td style="color: ${wallet.enabled ? '#2ecc71' : '#e74c3c'}">
                        ${wallet.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω'}
                    </td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                                onclick="editFormWallet('${wallet.type}', '${wallet.number}')">
                            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤:', error);
        container.innerHTML = `
            <p style="color: #e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤: ${error.message}</p>
            <button class="btn" onclick="loadWallets(true)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–∏–ø–∞ –∫–æ—à–µ–ª—å–∫–∞
function getWalletTypeColor(type) {
    const colors = {
        'vodafone': '#e4405f',
        'instapay': '#3498db',
        'orange': '#ff9800',
        'etisalat': '#4caf50',
        'we': '#9c27b0'
    };
    return colors[type] || '#7f8c8d';
}

// –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ)
function editFormWallet(walletType, walletNumber) {
    alert(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞:\n–¢–∏–ø: ${walletType}\n–ù–æ–º–µ—Ä: ${walletNumber}\n\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
}

function showAddWalletForm() {
    alert('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –≤ —Ñ–æ—Ä–º—É\n\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–∏–ø–∞ –∫–æ—à–µ–ª—å–∫–∞
function getWalletTypeColor(type) {
    const colors = {
        'vodafone': '#e4405f',
        'instapay': '#3498db',
        'orange': '#ff9800',
        'etisalat': '#4caf50',
        'we': '#9c27b0'
    };
    return colors[type] || '#7f8c8d';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ (–∞–∫—Ç–∏–≤–Ω—ã–µ + –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ)
async function showAllWallets() {
    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
    alert('–§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
}
        
        async function toggleWallet(walletId, newStatus) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${newStatus ? '–≤–∫–ª—é—á–∏—Ç—å' : '–æ—Ç–∫–ª—é—á–∏—Ç—å'} —ç—Ç–æ—Ç –∫–æ—à–µ–ª—ë–∫?`)) return;
            
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}?action=update_wallet&token=${token}&wallet_id=${walletId}&enabled=${newStatus}`);
                
                if (!response.ok) {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    loadWallets();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        function showAddWalletForm() {
            const container = document.getElementById('walletsList');
            container.innerHTML = `
                <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫</h3>
                    <div style="display: grid; gap: 15px; margin-top: 15px;">
                        <div>
                            <label>–¢–∏–ø –∫–æ—à–µ–ª—å–∫–∞</label>
                            <input type="text" id="newWalletType" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: vodafone" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(255,255,255,0.9); color: #2c3e50;">
                        </div>
                        <div>
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="newWalletName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Vodafone Cash" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(255,255,255,0.9); color: #2c3e50;">
                        </div>
                        <div>
                            <label>–ù–æ–º–µ—Ä</label>
                            <input type="text" id="newWalletNumber" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 01012345678" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(255,255,255,0.9); color: #2c3e50;">
                        </div>
                        <div>
                            <label>
                                <input type="checkbox" id="newWalletEnabled" checked> –ê–∫—Ç–∏–≤–µ–Ω
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="addNewWallet()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="btn" onclick="loadWallets()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function addNewWallet() {
            try {
                const type = document.getElementById('newWalletType').value.trim();
                const name = document.getElementById('newWalletName').value.trim();
                const number = document.getElementById('newWalletNumber').value.trim();
                const enabled = document.getElementById('newWalletEnabled').checked;
                
                if (!type || !name || !number) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }
                
                const token = localStorage.getItem('admin_token');
                const url = `${API_URL}?action=add_wallet&token=${token}&type=${encodeURIComponent(type)}&name=${encodeURIComponent(name)}&number=${encodeURIComponent(number)}&enabled=${enabled}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    alert('–ö–æ—à–µ–ª—ë–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    loadWallets();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        function switchTab(tabName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
    document.getElementById(tabName + 'Tab').classList.add('active');
    document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    switch(tabName) {
        case 'wallets':
            loadWallets();
            break;
        case 'forms':
            loadForms();
            break;
        case 'agents':
            loadAgents();
            break;
        case 'history':
            loadHistory();
            break;
        case 'admins':
            loadAdmins();
            break;
        case 'dashboard':
            loadDashboard();
            break;
    }
}
        
        async function logout() {
            try {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    await fetch(`${API_URL}?action=logout&token=${token}`).catch(() => {});
                }
            } finally {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
