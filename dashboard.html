<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <style>
        :root {
            --primary-bg: linear-gradient(135deg, #042F28 0%, #0A5C4A 100%);
            --accent: #D0E41E;
            --text: white;
            --card-bg: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.2);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
        body { background: var(--primary-bg); color: var(--text); min-height: 100vh; }
        
        /* –®–∞–ø–∫–∞ */
        .header { 
            padding: 20px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .header-title { font-size: 24px; font-weight: bold; color: var(--accent); }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .logout-btn { 
            padding: 8px 15px; 
            background: rgba(231, 76, 60, 0.2); 
            color: #e74c3c; 
            border: 1px solid #e74c3c; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { 
            display: flex; 
            background: rgba(255, 255, 255, 0.05); 
            border-bottom: 1px solid var(--border); 
            padding: 0 20px; 
            gap: 5px; 
        }
        .tab { 
            padding: 15px 25px; 
            cursor: pointer; 
            border-bottom: 3px solid transparent; 
            transition: all 0.3s; 
        }
        .tab.active { 
            background: var(--card-bg); 
            border-bottom-color: var(--accent); 
            color: var(--accent); 
        }
        
        /* –ö–æ–Ω—Ç–µ–Ω—Ç */
        .content { padding: 30px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 10px; text-align: center; }
        .stat-number { font-size: 32px; font-weight: bold; color: var(--accent); }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .wallet-table { width: 100%; border-collapse: collapse; background: var(--card-bg); border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .wallet-table th { background: rgba(0,0,0,0.3); padding: 15px; text-align: left; }
        .wallet-table td { padding: 15px; border-bottom: 1px solid var(--border); }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { padding: 10px 20px; background: var(--accent); color: #2c3e50; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; }
        .btn:hover { background: #b8cc1a; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-success { background: #2ecc71; color: white; }
        
        /* –ó–∞–≥—Ä—É–∑—á–∏–∫ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 50px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –¥–∞—à–±–æ—Ä–¥–µ */
        .clickable {
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .clickable:hover {
            transform: translateY(-5px);
            border-color: var(--accent);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        /* –¢–∞–±–ª–∏—Ü—ã */
        .wallet-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .wallet-table th {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        .wallet-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .wallet-table tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .modal-fade-in {
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        #editWalletsModal > div {
            background: rgba(26, 35, 44, 0.95) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .wallet-status-select {
            transition: all 0.2s ease;
        }
        
        .wallet-status-select:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        #saveChangesBtn {
            transition: all 0.3s ease;
        }
        
        #saveChangesBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        #saveChangesBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
                /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–≥–æ –ª–æ–∞–¥–µ—Ä–∞ */
        /*.loader-small {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }*/

                .loader-small {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            vertical-align: middle;
        }

                /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞ */
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent) !important;
        }

                /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .wallet-table tbody tr {
            animation: fadeIn 0.3s ease;
        }
        
        /* –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏ */
        #saveChangesBtn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #saveChangesBtn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        /* –ü—É–ª—å—Å–∏—Ä—É—é—â–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .loading-pulse {
            animation: pulse 1.5s infinite;
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —É—Å–ø–µ—Ö–∞ */
        .success-animation {
            animation: successPulse 0.5s ease;
        }
        
        @keyframes successPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">üí∞ –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</div>
        <div class="user-info">
            <span id="currentUser">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏</button>
        </div>
    </div>
    
    <div class="tabs">
        <div class="tab active" onclick="switchTab('dashboard')">üìä –î–∞—à–±–æ—Ä–¥</div>
        <div class="tab" onclick="switchTab('wallets')">üëõ –ö–æ—à–µ–ª—å–∫–∏</div>
        <div class="tab" onclick="switchTab('forms')">üåê –§–æ—Ä–º—ã</div>
        <div class="tab" onclick="switchTab('agents')">üë• –ê–≥–µ–Ω—Ç—ã</div>
        <div class="tab" onclick="switchTab('history')">üìà –ò—Å—Ç–æ—Ä–∏—è</div>
        <div class="tab" onclick="switchTab('admins')">üõ°Ô∏è –ê–¥–º–∏–Ω—ã</div>
    </div>
    
    <div class="content">
    <!-- –î–∞—à–±–æ—Ä–¥ -->
    <div id="dashboardTab" class="tab-content active">
        <h2>üìä –î–∞—à–±–æ—Ä–¥</h2>
        <div id="dashboardStats">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</p>
            <div class="loader"></div>
        </div>
    </div>
    
    <!-- –ö–æ—à–µ–ª—å–∫–∏ -->
    <div id="walletsTab" class="tab-content">
        <h2>üëõ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞–º–∏</h2>
        <button class="btn" onclick="loadWallets()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <button class="btn btn-success" onclick="showAddWalletForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª—ë–∫</button>
        <div id="walletsList" style="margin-top: 20px;">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤...</p>
            <div class="loader"></div>
        </div>
    </div>
    
    <!-- –§–æ—Ä–º—ã -->
    <div id="formsTab" class="tab-content">
        <h2>üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏</h2>
        <button class="btn" onclick="loadForms()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—ã</button>
        <div id="formsList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ä–º—ã" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
    
    <!-- –ê–≥–µ–Ω—Ç—ã -->
    <div id="agentsTab" class="tab-content">
        <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏</h2>
        <button class="btn" onclick="loadAgents()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤</button>
        <div id="agentsList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–≥–µ–Ω—Ç–æ–≤" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
    
    <!-- –ò—Å—Ç–æ—Ä–∏—è -->
    <div id="historyTab" class="tab-content">
        <h2>üìà –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
        <div style="margin-bottom: 15px;">
            <input type="text" id="historyFilter" placeholder="–§–∏–ª—å—Ç—Ä –ø–æ —Ñ–æ—Ä–º–µ..." style="padding: 8px; width: 300px; margin-right: 10px;">
            <button class="btn" onclick="loadHistory()">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <button class="btn" onclick="clearHistoryFilter()">‚ùå –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
        </div>
        <div id="historyList" style="margin-top: 20px;">
            <p>–ù–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é" –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        </div>
    </div>
    
            <!-- –ê–¥–º–∏–Ω—ã -->
        <div id="adminsTab" class="tab-content">
            <h2>üõ°Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏</h2>
            
            <!-- –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞ -->
            <div style="background: var(--card-bg); padding: 25px; border-radius: 10px; margin-bottom: 25px; border: 1px solid rgba(255,255,255,0.1);">
                <h3 style="margin-bottom: 20px; color: var(--accent);">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                
                <div id="createAdminForm" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–õ–æ–≥–∏–Ω *</label>
                        <input type="text" id="newAdminUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ª–æ–≥–∏–Ω" 
                               style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                      color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;"
                               onfocus="this.style.borderColor='var(--accent)'" 
                               onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                        <div style="font-size: 11px; color: #95a5a6; margin-top: 5px;">–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã –∏ —Ü–∏—Ñ—Ä—ã</div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–ü–∞—Ä–æ–ª—å *</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="password" id="newAdminPassword" placeholder="–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤" 
                                   style="flex: 1; padding: 12px; background: rgba(255,255,255,0.05); 
                                          color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;"
                                   onfocus="this.style.borderColor='var(--accent)'" 
                                   onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                            <button type="button" onclick="generatePassword()" 
                                    style="padding: 12px 15px; background: rgba(52, 152, 219, 0.2); 
                                           border: 1px solid #3498db; color: #3498db; border-radius: 5px; 
                                           cursor: pointer; white-space: nowrap;">
                                üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                        <div id="passwordStrength" style="font-size: 11px; margin-top: 5px;"></div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">Email</label>
                        <input type="email" id="newAdminEmail" placeholder="user@example.com" 
                               style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                      color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;"
                               onfocus="this.style.borderColor='var(--accent)'" 
                               onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                        <div style="font-size: 11px; color: #95a5a6; margin-top: 5px;">–î–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è</div>
                    </div>
                    
                    <div>
                        <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–†–æ–ª—å *</label>
                        <select id="newAdminRole" 
                                style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                       color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;
                                       cursor: pointer;"
                                onfocus="this.style.borderColor='var(--accent)'" 
                                onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                            <option value="viewer">üëÅÔ∏è –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä)</option>
                            <option value="manager">üë®‚Äçüíº –ú–µ–Ω–µ–¥–∂–µ—Ä (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏)</option>
                            <option value="admin">üõ°Ô∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø)</option>
                        </select>
                        <div style="font-size: 11px; color: #95a5a6; margin-top: 5px;">
                            <span id="selectedRoleDescription">–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 13px; color: #95a5a6;">
                        <span style="color: #e74c3c;">*</span> –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                    </div>
                    <button class="btn btn-success" onclick="createNewAdmin()" id="createAdminBtn" 
                            style="padding: 12px 30px; font-size: 14px;">
                        ‚ûï –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    </button>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ -->
            <div style="background: var(--card-bg); padding: 25px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="color: var(--accent);">üìã –°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h3>
                    <button class="btn" onclick="loadAdmins(true)" id="refreshAdminsBtn" 
                            style="padding: 8px 15px; display: flex; align-items: center; gap: 8px;">
                        <span>üîÑ</span>
                        <span>–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</span>
                    </button>
                </div>
                
                <div id="adminsList">
                    <div style="text-align: center; padding: 40px; color: #95a5a6;">
                        <p>–°–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
                        <p style="font-size: 14px; margin-top: 10px;">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</p>
                    </div>
                </div>
            </div>
            
            <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
            <div id="editAdminModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: var(--card-bg); padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 id="editAdminModalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
                        <button onclick="closeEditAdminModal()" style="background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;">√ó</button>
                    </div>
                    <div id="editAdminModalContent">
                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
</div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxDaBdYMx44M2W3FsJp5tOECFTRD6rWrhPAC96MuUexROt5Qjgj4U0er4So6Ehsh8xQ5g/exec';

        // ========== –°–ò–°–¢–ï–ú–ê –ö–≠–®–ò–†–û–í–ê–ù–ò–Ø –ö–û–®–ï–õ–¨–ö–û–í ==========

// –ö–ª—é—á–∏ –¥–ª—è localStorage
const CACHE_KEYS = {
    WALLETS: 'cached_wallets',
    WALLETS_TIMESTAMP: 'wallets_timestamp',
    CACHE_DURATION: 5 * 60 * 1000 // 5 –º–∏–Ω—É—Ç –∫—ç—à
};

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏ –≤ –∫—ç—à
function saveWalletsToCache(wallets) {
    try {
        const cacheData = {
            wallets: wallets,
            timestamp: Date.now()
        };
        localStorage.setItem(CACHE_KEYS.WALLETS, JSON.stringify(cacheData));
        console.log('‚úÖ –ö–æ—à–µ–ª—å–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫—ç—à');
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –∫—ç—à:', error);
    }
}

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –∫—ç—à–∞
function getWalletsFromCache() {
    try {
        const cachedData = localStorage.getItem(CACHE_KEYS.WALLETS);
        if (!cachedData) return null;
        
        const data = JSON.parse(cachedData);
        const now = Date.now();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –ª–∏ –¥–∞–Ω–Ω—ã–µ
        if (now - data.timestamp > CACHE_KEYS.CACHE_DURATION) {
            console.log('–ö—ç—à —É—Å—Ç–∞—Ä–µ–ª, —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ');
            return null;
        }
        
        console.log('‚úÖ –ö–æ—à–µ–ª—å–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –∫—ç—à–∞');
        return data.wallets;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∫—ç—à–∞:', error);
        return null;
    }
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –≤—Å–µ—Ö —Ñ–æ—Ä–º (—Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
async function loadAllWalletsFromForms(forceRefresh = false) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à –µ—Å–ª–∏ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if (!forceRefresh) {
        const cachedWallets = getWalletsFromCache();
        if (cachedWallets) {
            return cachedWallets;
        }
    }
    
    console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –∏–∑ —Ñ–æ—Ä–º...');
    
    try {
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        if (!formsResult.success || !formsResult.forms) {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º');
            return {};
        }
        
        const allWallets = {};
        const formWalletsMap = {};
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã
        for (const form of formsResult.forms) {
            if (!form.formAPI) continue;
            
            try {
                console.log(`üì° –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã: ${form.formName}`);
                
                const walletResponse = await fetch(`${form.formAPI}?action=get_wallets`);
                const walletResult = await walletResponse.json();
                
                if (walletResult.status === 'success' && walletResult.wallets) {
                    formWalletsMap[form.formName] = [];
                    
                    Object.entries(walletResult.wallets).forEach(([walletType, walletData]) => {
                        if (walletData.enabled && walletData.availableNumbers) {
                            walletData.availableNumbers.forEach(walletNumber => {
                                const walletKey = `${walletType}_${walletNumber}`;
                                
                                if (!allWallets[walletKey]) {
                                    allWallets[walletKey] = {
                                        type: walletType,
                                        name: walletData.name || walletType,
                                        number: walletNumber,
                                        enabled: walletData.enabled,
                                        forms: [form.formName],
                                        formAPIs: [form.formAPI]
                                    };
                                } else {
                                    if (!allWallets[walletKey].forms.includes(form.formName)) {
                                        allWallets[walletKey].forms.push(form.formName);
                                        allWallets[walletKey].formAPIs.push(form.formAPI);
                                    }
                                }
                                
                                formWalletsMap[form.formName].push(walletKey);
                            });
                        }
                    });
                }
            } catch (formError) {
                console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã ${form.formName}:`, formError);
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
        saveWalletsToCache(allWallets);
        
        console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(allWallets).length} –∫–æ—à–µ–ª—å–∫–æ–≤`);
        return allWallets;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤:', error);
        return {};
    }
}

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∫–æ—à–µ–ª—å–∫–æ–≤
async function refreshWalletsCache() {
    try {
        console.log('üîÑ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞ –∫–æ—à–µ–ª—å–∫–æ–≤');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const oldWallets = getWalletsFromCache();
        const wasCached = oldWallets !== null;
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const newWallets = await loadAllWalletsFromForms(true);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ –∏ –≤–∫–ª–∞–¥–∫—É –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
        loadDashboard();
        
        // –ï—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –∞–∫—Ç–∏–≤–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º –µ—ë
        if (document.getElementById('walletsTab').classList.contains('active')) {
            loadWallets();
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        alert(`‚úÖ –ö—ç—à –∫–æ—à–µ–ª—å–∫–æ–≤ –æ–±–Ω–æ–≤–ª–µ–Ω!\n\n–ë—ã–ª–æ –≤ –∫—ç—à–µ: ${wasCached ? Object.keys(oldWallets || {}).length : 0}\n–°—Ç–∞–ª–æ: ${Object.keys(newWallets).length}`);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞:', error);
        alert('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—ç—à–∞: ' + error.message);
    }
}

        // –°–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫–∏, –∫ –∫–æ—Ç–æ—Ä—ã–º –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞
                function hideUnauthorizedTabs() {
            const permissions = JSON.parse(localStorage.getItem('admin_permissions') || '{}');
            const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
            
            // –ï—Å–ª–∏ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –∏–ª–∏ –∞–¥–º–∏–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            if (user.role === 'superadmin' || user.role === 'admin') {
                return;
            }
            
            // –î–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º
            if (user.role === 'manager') {
                const formsTab = document.querySelector('.tab[onclick*="forms"]');
                if (formsTab) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫—É, –Ω–æ –¥–æ—Å—Ç—É–ø –±—É–¥–µ—Ç —Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å—Å—è –≤ loadForms()
                    // –∏–ª–∏ –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É —Å–∫—Ä—ã—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                }
            }
            
            // –û—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∫—Ä—ã—Ç–∏—è
            const tabsToCheck = {
                'wallets': permissions.canManageWallets,
                'agents': permissions.canManageAdmins,
                'history': permissions.canViewHistory,
                'admins': permissions.canManageAdmins
            };
            
            Object.entries(tabsToCheck).forEach(([tabName, hasPermission]) => {
                const tabElement = document.querySelector(`.tab[onclick*="${tabName}"]`);
                if (tabElement && !hasPermission) {
                    tabElement.style.display = 'none';
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', function() {
    const token = localStorage.getItem('admin_token');
    const user = localStorage.getItem('admin_user');
    
    if (!token || !user) {
        window.location.href = 'login.html';
        return;
    }
    
    try {
        const userData = JSON.parse(user);
        document.getElementById('currentUser').textContent = `${userData.username} (${userData.role})`;
        
        // –°–∫—Ä—ã–≤–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞
        hideUnauthorizedTabs();
        
        loadDashboard();
    } catch (e) {
        logout();
    }
});
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞ —Å –∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–º–∏ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏
          async function loadDashboard() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('dashboardStats');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞—à–±–æ—Ä–¥–∞...</p><div class="loader"></div>';
        
        // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–∞–Ω–µ–ª–∏
        const dashboardResponse = await fetch(`${API_URL}?action=get_dashboard_data&token=${token}`);
        const dashboardResult = await dashboardResponse.json();
        
        if (!dashboardResult.success) {
            if (dashboardResult.code === 'UNAUTHORIZED') logout();
            throw new Error(dashboardResult.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞');
        }
        
        // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º
        const wallets = await loadAllWalletsFromForms();
        const walletsArray = Object.values(wallets);
        const activeWallets = walletsArray.filter(w => w.enabled);
        
        console.log('–ö–æ—à–µ–ª—å–∫–∏ –¥–ª—è –¥–∞—à–±–æ—Ä–¥–∞:', {
            total: walletsArray.length,
            active: activeWallets.length
        });
        
        // 3. –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∞—à–±–æ—Ä–¥
        container.innerHTML = `
            <div class="stats-grid">
                <div class="stat-card clickable" onclick="switchTab('wallets')">
                    <div class="stat-number">${activeWallets.length}</div>
                    <div>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –í—Å–µ–≥–æ: ${walletsArray.length}
                    </div>
                </div>
                <div class="stat-card clickable" onclick="switchTab('forms')">
                    <div class="stat-number">${dashboardResult.stats.totalForms || 0}</div>
                    <div>–§–æ—Ä–º</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –ê–∫—Ç–∏–≤–Ω—ã—Ö: ${dashboardResult.stats.activeForms || 0}
                    </div>
                </div>
                <div class="stat-card clickable" onclick="switchTab('agents')">
                    <div class="stat-number">${dashboardResult.stats.totalAgents || 0}</div>
                    <div>–ê–≥–µ–Ω—Ç–æ–≤</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –í —Å–µ—Ç–∏: ${getOnlineAgentsCount(dashboardResult.stats.totalAgents)}
                    </div>
                </div>
                <div class="stat-card clickable" onclick="switchTab('history')">
                    <div class="stat-number">üìà</div>
                    <div>–ò—Å—Ç–æ—Ä–∏—è</div>
                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                        –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
                    </div>
                </div>
            </div>
            
            <!-- –ë—ã—Å—Ç—Ä—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ -->
            <div style="margin-top: 30px; background: var(--card-bg); padding: 20px; border-radius: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üî• –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏ (${activeWallets.length})</h3>
                    <div>
                        <button class="btn" onclick="refreshWalletsCache()" style="padding: 8px 15px; font-size: 14px;">
                            üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                        </button>
                        <button class="btn" onclick="switchTab('wallets')" style="padding: 8px 15px; font-size: 14px; margin-left: 10px;">
                            üëÅÔ∏è –í—Å–µ –∫–æ—à–µ–ª—å–∫–∏
                        </button>
                    </div>
                </div>
                
                ${activeWallets.length > 0 ? `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                        ${activeWallets.slice(0, 6).map(wallet => `
                            <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; border-left: 4px solid ${getWalletTypeColor(wallet.type)};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div>
                                        <strong>${wallet.name}</strong>
                                        <div style="color: #95a5a6; font-size: 12px; margin-top: 5px;">
                                            ${wallet.type}
                                        </div>
                                    </div>
                                    <span style="background: ${getWalletTypeColor(wallet.type)}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                                        ${wallet.forms.length} —Ñ–æ—Ä–º
                                    </span>
                                </div>
                                <div style="margin-top: 10px;">
                                    <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; font-size: 14px; cursor: pointer;" 
                                          onclick="copyToClipboard('${wallet.number}')">
                                        ${wallet.number}
                                    </code>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ${activeWallets.length > 6 ? `
                        <div style="text-align: center; margin-top: 15px; color: #3498db; cursor: pointer;" 
                             onclick="switchTab('wallets')">
                            + –µ—â—ë ${activeWallets.length - 6} –∫–æ—à–µ–ª—å–∫–æ–≤
                        </div>
                    ` : ''}
                ` : `
                    <div style="text-align: center; padding: 30px; color: #95a5a6;">
                        <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤</p>
                        <button class="btn" onclick="switchTab('wallets')" style="margin-top: 10px;">
                            –ü–µ—Ä–µ–π—Ç–∏ –∫ –∫–æ—à–µ–ª—å–∫–∞–º
                        </button>
                    </div>
                `}
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card-bg); padding: 15px; border-radius: 10px;">
                <div>
                    <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –ª—é–±—É—é –∫–∞—Ä—Ç–æ—á–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Ä–∞–∑–¥–µ–ª—É
                </div>
                <div style="font-size: 12px; color: #95a5a6;">
                    –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: ${new Date().toLocaleTimeString()}
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('Dashboard error:', error);
        container.innerHTML = `
            <p style="color: #e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞: ${error.message}</p>
            <button class="btn" onclick="loadDashboard()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
        `;
    }
}

        // ========== –§–û–†–ú–´ ==========
async function loadForms() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('formsList');
        const currentUser = JSON.parse(localStorage.getItem('admin_user') || '{}');
        
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º...</p><div class="loader"></div>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        if (formsResult.success && formsResult.forms && formsResult.forms.length > 0) {
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ñ–æ—Ä–º—ã –ø–æ –¥–æ—Å—Ç—É–ø—É
            let accessibleForms = formsResult.forms;
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω –∏ –Ω–µ –∞–¥–º–∏–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
            if (currentUser.role !== 'superadmin' && currentUser.role !== 'admin') {
                // –ü–æ–ª—É—á–∞–µ–º —Ñ–æ—Ä–º—ã –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —ç—Ç–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
                const assignedForms = await getAssignedForms(currentUser.username);
                if (assignedForms.length > 0) {
                    accessibleForms = formsResult.forms.filter(form => 
                        assignedForms.includes(form.formName)
                    );
                } else {
                    accessibleForms = []; // –ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º
                }
            }
            
            if (accessibleForms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: var(--card-bg); border-radius: 10px;">
                        <p style="color: #95a5a6; font-size: 24px; margin-bottom: 10px;">üì≠</p>
                        <p>–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–æ—Ä–º–∞–º</p>
                        ${currentUser.role === 'manager' ? 
                            '<p style="color: #95a5a6; font-size: 14px; margin-top: 10px;">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–æ—Ä–º–∞–º</p>' : 
                            '<p style="color: #95a5a6; font-size: 14px; margin-top: 10px;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º</p>'
                        }
                    </div>
                `;
                return;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ–æ—Ä–º
            const walletsData = await loadAllWalletsFromForms();
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º walletsData –≤ —É–¥–æ–±–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
            const walletsByForm = {};
            Object.values(walletsData).forEach(wallet => {
                wallet.forms.forEach(formName => {
                    if (!walletsByForm[formName]) {
                        walletsByForm[formName] = [];
                    }
                    walletsByForm[formName].push(wallet);
                });
            });
            
            let html = `
                <div style="margin-bottom: 20px; color: #95a5a6; font-size: 14px;">
                    –ù–∞–π–¥–µ–Ω–æ —Ñ–æ—Ä–º: ${accessibleForms.length}
                    ${currentUser.role !== 'superadmin' && currentUser.role !== 'admin' ? 
                        `(–¥–æ—Å—Ç—É–ø–Ω–æ –≤–∞–º: ${accessibleForms.length})` : ''
                    }
                </div>
                <table class="wallet-table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ —Ñ–æ—Ä–º—ã</th>
                            <th>API URL</th>
                            <th>–ê–≥–µ–Ω—Ç—ã</th>
                            <th>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–æ—à–µ–ª—å–∫–∏</th>
                            <th>–°—Ç–∞—Ç—É—Å</th>
                            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            accessibleForms.forEach(form => {
                const formWallets = walletsByForm[form.formName] || [];
                const activeWallets = formWallets.filter(w => w.enabled);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–µ–π—Å—Ç–≤–∏—è–º
                const canEditWallets = currentUser.role === 'superadmin' || 
                                       currentUser.role === 'admin' || 
                                       (currentUser.role === 'manager' && accessibleForms.includes(form));
                
                html += `
                    <tr>
                        <td>
                            <strong>${form.formName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
                            <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                                ID: ${form.formName.toLowerCase().replace(/\s+/g, '_')}
                            </div>
                        </td>
                        <td>
                            <div style="max-width: 200px; overflow: hidden;">
                                <code style="font-size: 11px; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; display: block; word-break: break-all;">
                                    ${form.formAPI || '–ù–µ—Ç URL'}
                                </code>
                            </div>
                        </td>
                        <td>
                            ${getAgentsForForm(form.formName).length > 0 ? 
                                getAgentsForForm(form.formName).map(agent => 
                                    `<span style="background: #9b59b6; color: white; padding: 3px 8px; border-radius: 10px; margin: 2px; display: inline-block; font-size: 11px;">
                                        ${agent}
                                    </span>`
                                ).join('') :
                                '<span style="color: #95a5a6; font-size: 12px;">–ù–µ—Ç –∞–≥–µ–Ω—Ç–æ–≤</span>'
                            }
                            ${currentUser.role === 'superadmin' || currentUser.role === 'admin' ? `
                                <div style="margin-top: 5px;">
                                    <button class="btn" style="padding: 3px 8px; font-size: 11px;" 
                                            onclick="manageFormAgents('${form.formName}')">
                                        üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                    </button>
                                </div>
                            ` : ''}
                        </td>
                        <td>
                            <div style="margin-bottom: 10px;">
                                <strong style="color: ${activeWallets.length > 0 ? '#2ecc71' : '#e74c3c'}">
                                    ${activeWallets.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö
                                </strong>
                                <div style="font-size: 11px; color: #95a5a6;">
                                    –í—Å–µ–≥–æ: ${formWallets.length}
                                </div>
                            </div>
                            ${activeWallets.slice(0, 3).map(wallet => `
                                <div style="display: flex; align-items: center; margin-bottom: 5px; font-size: 12px;">
                                    <span style="background: ${getWalletTypeColor(wallet.type)}; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px;"></span>
                                    <span>${wallet.type}:</span>
                                    <code style="margin-left: 5px; background: rgba(0,0,0,0.2); padding: 2px 5px; border-radius: 3px;">
                                        ${wallet.number.substring(0, 3)}...${wallet.number.substring(wallet.number.length - 3)}
                                    </code>
                                </div>
                            `).join('')}
                            ${activeWallets.length > 3 ? 
                                `<div style="color: #3498db; font-size: 11px; cursor: pointer;" onclick="showAllFormWallets('${form.formName}')">
                                    + –µ—â—ë ${activeWallets.length - 3} –∫–æ—à–µ–ª—å–∫–æ–≤
                                </div>` : 
                                ''
                            }
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <span style="color: ${form.enabled ? '#2ecc71' : '#e74c3c'}">
                                    ${form.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞'}
                                </span>
                                <span style="color: ${form.serviceMode ? '#e67e22' : '#2ecc71'}">
                                    ${form.serviceMode ? 'üîß –¢–µ—Ö. —Ä–∞–±–æ—Ç—ã' : '‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç'}
                                </span>
                                <div style="font-size: 11px; color: #95a5a6;">
                                    –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${form.updatedAt ? new Date(form.updatedAt).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                ${canEditWallets ? `
                                    <button class="btn btn-success" style="padding: 6px 12px; font-size: 12px;" 
                                            onclick="showEditWalletsModal('${form.formName}')">
                                        üè¶ –ò–∑–º–µ–Ω–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏
                                    </button>
                                ` : `
                                    <button class="btn" style="padding: 6px 12px; font-size: 12px; background: #95a5a6;" 
                                            disabled title="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∞–≤">
                                        üîí –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞
                                    </button>
                                `}
                                <button class="btn" style="padding: 6px 12px; font-size: 12px;" 
                                        onclick="testFormConnection('${form.formName}', '${form.formAPI}')">
                                    üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                ${currentUser.role === 'superadmin' || currentUser.role === 'admin' ? `
                                    <button class="btn" style="padding: 6px 12px; font-size: 12px;" 
                                            onclick="editFormSettings('${form.formName}')">
                                        ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `</tbody></table>`;
            container.innerHTML = html;
            
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; background: var(--card-bg); border-radius: 10px;">
                    <p>–§–æ—Ä–º –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>
                    <p style="color: #95a5a6; font-size: 14px; margin-top: 10px;">
                        –î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ä–º—ã –≤ —Ç–∞–±–ª–∏—Ü—É FORM_SETTINGS –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é
                    </p>
                    ${currentUser.role === 'superadmin' || currentUser.role === 'admin' ? `
                        <button class="btn btn-success" onclick="showAddFormModal()" style="margin-top: 20px;">
                            ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ñ–æ—Ä–º—É
                        </button>
                    ` : ''}
                </div>
            `;
        }
    } catch (error) {
        console.error('Forms loading error:', error);
        container.innerHTML = `
            <div style="color: #e74c3c">
                <p><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º:</strong></p>
                <p>${error.message}</p>
                <button class="btn" onclick="loadForms()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
            </div>
        `;
    }
}

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ä–º, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        async function getAssignedForms(username) {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}?action=get_assigned_forms&token=${token}&username=${encodeURIComponent(username)}`);
                
                if (!response.ok) {
                    console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤');
                    return [];
                }
                
                const result = await response.json();
                
                if (result.success && result.forms) {
                    return result.forms;
                }
                
                return [];
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Ñ–æ—Ä–º:', error);
                return [];
            }
        }

// –í—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∞–≥–µ–Ω—Ç–æ–≤
function getAgentsForForm(formName) {
    // –ü–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    return formName === 'TestPayForm' ? ['agent1', 'agent2'] : [];
}

        // ========== –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ö–û–®–ï–õ–¨–ö–û–í ==========

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤
         async function showEditWalletsModal(formName) {
    try {
        console.log('–û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–ª—è —Ñ–æ—Ä–º—ã:', formName);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ä–∞–∑—É —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
        document.getElementById('modalFormTitle').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞–º–∏: ${formName}`;
        document.getElementById('modalFormContent').innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="loader" style="width: 40px; height: 40px; margin: 0 auto 20px;"></div>
                <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤ –∏–∑ —Ñ–æ—Ä–º—ã...</p>
            </div>
        `;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        document.getElementById('editWalletsModal').style.display = 'flex';
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        const form = formsResult.forms?.find(f => f.formName === formName);
        if (!form) {
            document.getElementById('modalFormContent').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #e74c3c;">
                    <p style="font-size: 24px;">‚ùå</p>
                    <p><strong>–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</strong></p>
                    <button class="btn" onclick="closeEditWalletsModal()" style="margin-top: 20px;">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            `;
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –í–°–ï –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã (–≤–∫–ª—é—á–∞—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–µ)
        const walletsResponse = await fetch(`${form.formAPI}?action=get_wallets&show_all=true`);
        const walletsResult = await walletsResponse.json();
        
        if (walletsResult.status !== 'success') {
            document.getElementById('modalFormContent').innerHTML = `
                <div style="text-align: center; padding: 30px; color: #e74c3c;">
                    <p style="font-size: 24px;">‚ö†Ô∏è</p>
                    <p><strong>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—à–µ–ª—å–∫–∏</strong></p>
                    <p style="color: #95a5a6; font-size: 14px; margin-top: 10px;">
                        –û—à–∏–±–∫–∞: ${walletsResult.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}
                    </p>
                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                        <button class="btn" onclick="closeEditWalletsModal()">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button class="btn" onclick="showEditWalletsModal('${formName}')">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;
            return;
        }
        
                // –ü–æ–¥–≥–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                const allWallets = [];
        if (walletsResult.wallets) {
          Object.entries(walletsResult.wallets).forEach(([walletType, walletData]) => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å numbersInfo
            if (walletData.numbersInfo) {
              // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Å—Ç–∞—Ç—É—Å–∞–º–∏
              Object.entries(walletData.numbersInfo).forEach(([walletNumber, walletInfo], index) => {
                allWallets.push({
                  type: walletType,
                  name: walletInfo.name || walletType,
                  number: walletNumber,
                  enabled: walletInfo.enabled,
                  originalEnabled: walletInfo.enabled,
                  index: index
                });
              });
            } else if (walletData.availableNumbers && walletData.availableNumbers.length > 0) {
              // –°—Ç–∞—Ä–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
              walletData.availableNumbers.forEach((walletNumber, index) => {
                allWallets.push({
                  type: walletType,
                  name: walletData.name || walletType,
                  number: walletNumber,
                  enabled: true, // –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
                  originalEnabled: true,
                  index: index
                });
              });
            }
          });
        }
        
        console.log('–í—Å–µ –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã:', allWallets);
        
        // –°–æ–∑–¥–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        let modalContent = `
            <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                    <div style="background: #3498db; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                        üìã
                    </div>
                    <div>
                        <h3 style="margin: 0; font-size: 18px; color: white;">${formName}</h3>
                        <div style="font-size: 13px; color: #95a5a6; margin-top: 3px;">
                            ${allWallets.length} –∫–æ—à–µ–ª—å–∫–æ–≤
                        </div>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                    <div style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 8px; padding: 10px;">
                        <div style="font-size: 12px; color: #95a5a6;">–ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                        <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">
                            ${allWallets.filter(w => w.enabled).length}
                        </div>
                    </div>
                    <div style="background: rgba(231, 76, 60, 0.1); border: 1px solid rgba(231, 76, 60, 0.3); border-radius: 8px; padding: 10px;">
                        <div style="font-size: 12px; color: #95a5a6;">–û—Ç–∫–ª—é—á–µ–Ω—ã</div>
                        <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">
                            ${allWallets.filter(w => !w.enabled).length}
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="walletsListContainer" style="margin-bottom: 20px;">
        `;
        
        if (allWallets.length > 0) {
            modalContent += `
                <div style="background: rgba(255, 255, 255, 0.03); border-radius: 8px; overflow: hidden;">
                    <div style="display: grid; grid-template-columns: 120px 1fr 150px 100px; gap: 1px; background: rgba(255, 255, 255, 0.05);">
                        <div style="padding: 12px 15px; background: rgba(0, 0, 0, 0.3); font-weight: bold; font-size: 13px;">–¢–∏–ø</div>
                        <div style="padding: 12px 15px; background: rgba(0, 0, 0, 0.3); font-weight: bold; font-size: 13px;">–ù–æ–º–µ—Ä</div>
                        <div style="padding: 12px 15px; background: rgba(0, 0, 0, 0.3); font-weight: bold; font-size: 13px;">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                        <div style="padding: 12px 15px; background: rgba(0, 0, 0, 0.3); font-weight: bold; font-size: 13px;">–°—Ç–∞—Ç—É—Å</div>
            `;
            
            allWallets.forEach((wallet, idx) => {
                const walletTypeColor = getWalletTypeColor(wallet.type);
                modalContent += `
                    <div style="padding: 12px 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <span style="background: ${walletTypeColor}; padding: 5px 10px; border-radius: 6px; color: white; font-size: 12px; display: inline-block;">
                            ${wallet.type}
                        </span>
                    </div>
                    <div style="padding: 12px 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <code style="background: rgba(0, 0, 0, 0.3); padding: 6px 10px; border-radius: 5px; font-family: monospace; font-size: 13px; display: inline-block;">
                            ${wallet.number}
                        </code>
                    </div>
                    <div style="padding: 12px 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05); font-size: 13px;">
                        ${wallet.name}
                    </div>
                    <div style="padding: 12px 15px; background: rgba(255, 255, 255, 0.02); border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                        <select data-wallet-index="${idx}" 
                                data-wallet-type="${wallet.type}" 
                                data-wallet-number="${wallet.number}"
                                data-original-enabled="${wallet.enabled}"
                                style="width: 100%; padding: 8px 10px; background: ${wallet.enabled ? 'rgba(46, 204, 113, 0.15)' : 'rgba(231, 76, 60, 0.15)'}; 
                                       color: ${wallet.enabled ? '#2ecc71' : '#e74c3c'}; border: 1px solid ${wallet.enabled ? '#2ecc71' : '#e74c3c'}; 
                                       border-radius: 5px; cursor: pointer; font-size: 13px;"
                                onchange="this.style.background = this.value === 'true' ? 'rgba(46, 204, 113, 0.15)' : 'rgba(231, 76, 60, 0.15)';
                                         this.style.borderColor = this.value === 'true' ? '#2ecc71' : '#e74c3c';
                                         this.style.color = this.value === 'true' ? '#2ecc71' : '#e74c3c'">
                            <option value="true" ${wallet.enabled ? 'selected' : ''}>‚úÖ –í–∫–ª—é—á—ë–Ω</option>
                            <option value="false" ${!wallet.enabled ? 'selected' : ''}>‚ùå –û—Ç–∫–ª—é—á—ë–Ω</option>
                        </select>
                    </div>
                `;
            });
            
            modalContent += `</div></div>`;
        } else {
            modalContent += `
                <div style="text-align: center; padding: 40px; color: #95a5a6;">
                    <p style="font-size: 48px; margin-bottom: 10px;">üè¶</p>
                    <p><strong>–ù–µ—Ç –∫–æ—à–µ–ª—å–∫–æ–≤ –≤ —Ñ–æ—Ä–º–µ</strong></p>
                    <p>–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –∫–æ—à–µ–ª—ë–∫</p>
                </div>
            `;
        }
        
        modalContent += `</div>`;
        
        // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        modalContent += `
            <div style="margin-bottom: 20px;">
                <button onclick="toggleAddWalletForm()" 
                        style="width: 100%; padding: 12px; background: rgba(52, 152, 219, 0.1); 
                               border: 1px dashed rgba(52, 152, 219, 0.5); border-radius: 8px; 
                               color: #3498db; cursor: pointer; font-size: 14px; display: flex; 
                               align-items: center; justify-content: center; gap: 8px;">
                    <span style="font-size: 18px;">‚ûï</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫</span>
                </button>
                
                <div id="addWalletForm" style="display: none; margin-top: 15px; padding: 20px; 
                                               background: rgba(0, 0, 0, 0.2); border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–¢–∏–ø</label>
                            <select id="newWalletType" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05); 
                                                              color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 5px;">
                                <option value="vodafone">Vodafone Cash</option>
                                <option value="instapay">InstaPay QR</option>
                                <option value="orange">Orange Money</option>
                                <option value="etisalat">Etisalat Cash</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–ù–æ–º–µ—Ä</label>
                            <input type="text" id="newWalletNumber" placeholder="01012345678" 
                                   style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05); 
                                          color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="newWalletName" placeholder="–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ—à–µ–ª—ë–∫" 
                                   style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05); 
                                          color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 5px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–°—Ç–∞—Ç—É—Å</label>
                            <select id="newWalletStatus" style="width: 100%; padding: 10px; background: rgba(255, 255, 255, 0.05); 
                                                               color: white; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 5px;">
                                <option value="true">‚úÖ –í–∫–ª—é—á—ë–Ω</option>
                                <option value="false">‚ùå –û—Ç–∫–ª—é—á—ë–Ω</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                <button onclick="closeEditWalletsModal()" 
                        style="flex: 1; padding: 12px; background: rgba(231, 76, 60, 0.1); 
                               border: 1px solid rgba(231, 76, 60, 0.3); color: #e74c3c; 
                               border-radius: 8px; cursor: pointer; font-size: 14px;">
                    ‚ùå –û—Ç–º–µ–Ω–∞
                </button>
                <button onclick="saveAllWalletChanges('${formName}')" 
                        id="saveChangesBtn"
                        style="flex: 2; padding: 12px; background: linear-gradient(135deg, #2ecc71, #27ae60); 
                               border: none; color: white; border-radius: 8px; cursor: pointer; 
                               font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                </button>
            </div>
        `;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ
        const contentDiv = document.getElementById('modalFormContent');
        contentDiv.innerHTML = modalContent;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        setTimeout(() => {
            if (typeof window.toggleAddWalletForm === 'undefined') {
                window.toggleAddWalletForm = function() {
                    const form = document.getElementById('addWalletForm');
                    const button = event.target.closest('button');
                    if (form.style.display === 'none') {
                        form.style.display = 'block';
                        button.innerHTML = '<span style="font-size: 18px;">‚ûñ</span><span>–°–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</span>';
                    } else {
                        form.style.display = 'none';
                        button.innerHTML = '<span style="font-size: 18px;">‚ûï</span><span>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫</span>';
                    }
                };
            }
        }, 100);
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞:', error);
        document.getElementById('modalFormContent').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #e74c3c;">
                <p style="font-size: 48px; margin-bottom: 20px;">‚ùå</p>
                <p><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</strong></p>
                <p style="color: #95a5a6; margin: 15px 0; font-size: 14px;">
                    ${error.message}
                </p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 30px;">
                    <button class="btn" onclick="closeEditWalletsModal()">
                        –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                    <button class="btn" onclick="showEditWalletsModal('${formName}')">
                        üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                    </button>
                </div>
            </div>
        `;
    }
}

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–æ—à–µ–ª—å–∫–∞ –≤ —Ñ–æ—Ä–º–µ
async function updateWalletInForm(formAPI, walletType, walletNumber, newStatus, walletName = null) {
    try {
        console.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –≤ —Ñ–æ—Ä–º–µ:', { formAPI, walletType, walletNumber, newStatus });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = event?.target;
        const originalText = button?.innerHTML;
        if (button) {
            button.innerHTML = '<div class="loader" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px;"></div>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
            button.disabled = true;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
        const params = new URLSearchParams({
            action: 'update_wallet_status',
            wallet_type: walletType,
            wallet_number: walletNumber,
            enabled: newStatus ? 'true' : 'false'
        });
        
        if (walletName) {
            params.append('wallet_name', walletName);
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Ñ–æ—Ä–º—ã
        const response = await fetch(`${formAPI}?${params.toString()}`);
        const result = await response.json();
        
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', result);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        if (result.status === 'success') {
            return { success: true, message: '–°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞ –æ–±–Ω–æ–≤–ª—ë–Ω' };
        } else {
            return { success: false, error: result.message || '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è' };
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
        
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        return { success: false, error: error.message };
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞ –≤ —Ñ–æ—Ä–º—É
async function addNewWalletToForm(formAPI, walletData) {
    try {
        console.log('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–æ—à–µ–ª—å–∫–∞:', { formAPI, walletData });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = event?.target;
        const originalText = button?.innerHTML;
        if (button) {
            button.innerHTML = '<div class="loader" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px;"></div>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...';
            button.disabled = true;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
        const params = new URLSearchParams({
            action: 'add_wallet',
            type: walletData.type,
            name: walletData.name || walletData.type,
            number: walletData.number,
            enabled: walletData.enabled ? 'true' : 'false'
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Ñ–æ—Ä–º—ã
        const response = await fetch(`${formAPI}?${params.toString()}`);
        const result = await response.json();
        
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', result);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        if (result.status === 'success') {
            return { success: true, message: '–ö–æ—à–µ–ª—ë–∫ –¥–æ–±–∞–≤–ª–µ–Ω' };
        } else {
            return { success: false, error: result.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è' };
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
        
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        return { success: false, error: error.message };
    }
}

            async function saveAllWalletChanges(formName) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        const form = formsResult.forms?.find(f => f.formName === formName);
        if (!form) {
            alert('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –≤–∏–¥
        const button = document.getElementById('saveChangesBtn');
        const originalHTML = button.innerHTML;
        const originalClasses = button.className;
        
        // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å - –º–µ–Ω—è–µ–º –≤–∏–¥ –∫–Ω–æ–ø–∫–∏
        button.innerHTML = `
            <div class="loader-small" style="width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid white; border-radius: 50%; animation: spin 0.6s linear infinite; display: inline-block; margin-right: 10px; vertical-align: middle;"></div>
            <span style="vertical-align: middle;">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>
        `;
        button.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
        button.style.transform = 'scale(0.98)';
        button.disabled = true;
        
        // –°–æ–±–∏—Ä–∞–µ–º –¢–û–õ–¨–ö–û –ò–ó–ú–ï–ù–ï–ù–ù–´–ï —Å—Ç–∞—Ç—É—Å—ã
        const changedWallets = [];
        const selects = document.querySelectorAll('#walletsListContainer select[data-wallet-index]');
        
        selects.forEach(select => {
            const walletType = select.dataset.walletType;
            const walletNumber = select.dataset.walletNumber;
            const newEnabled = select.value === 'true';
            const originalEnabled = select.dataset.originalEnabled === 'true';
            
            if (newEnabled !== originalEnabled) {
                changedWallets.push({
                    type: walletType,
                    number: walletNumber,
                    enabled: newEnabled,
                    originalEnabled: originalEnabled
                });
            }
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫
        const newWalletData = {};
        const addForm = document.getElementById('addWalletForm');
        if (addForm && addForm.style.display !== 'none') {
            const newType = document.getElementById('newWalletType').value;
            const newNumber = document.getElementById('newWalletNumber').value.trim();
            const newName = document.getElementById('newWalletName').value.trim() || newType;
            const newStatus = document.getElementById('newWalletStatus').value === 'true';
            
            if (newType && newNumber) {
                newWalletData.type = newType;
                newWalletData.number = newNumber;
                newWalletData.name = newName;
                newWalletData.enabled = newStatus;
                changedWallets.push({
                    type: newType,
                    number: newNumber,
                    enabled: newStatus,
                    isNew: true
                });
            }
        }
        
        // –ï—Å–ª–∏ –Ω–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if (changedWallets.length === 0) {
            // –ê–Ω–∏–º–∞—Ü–∏—è "–Ω–∏—á–µ–≥–æ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å"
            button.innerHTML = '<span style="color: #95a5a6;">‚úì –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π</span>';
            button.style.background = 'rgba(149, 165, 166, 0.1)';
            button.style.border = '1px solid rgba(149, 165, 166, 0.3)';
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.background = '';
                button.style.border = '';
                button.style.transform = '';
                button.disabled = false;
            }, 1500);
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        const progressContainer = document.createElement('div');
        progressContainer.style.cssText = `
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            font-size: 13px;
        `;
        progressContainer.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                <span id="progressText">0/${changedWallets.length}</span>
            </div>
            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                <div id="progressBar" style="width: 0%; height: 100%; background: #3498db; transition: width 0.3s ease;"></div>
            </div>
        `;
        
        button.parentNode.insertBefore(progressContainer, button.nextSibling);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < changedWallets.length; i++) {
            const change = changedWallets[i];
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = Math.round(((i + 1) / changedWallets.length) * 100);
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = `${i + 1}/${changedWallets.length}`;
            
            try {
                let result;
                
                if (change.isNew) {
                    result = await addNewWalletToForm(form.formAPI, {
                        type: change.type,
                        name: newWalletData.name,
                        number: change.number,
                        enabled: change.enabled
                    });
                } else {
                    result = await updateWalletInForm(form.formAPI, change.type, change.number, change.enabled);
                }
                
                if (result.success) {
                    successCount++;
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                    if (!change.isNew) {
                        const select = document.querySelector(`select[data-wallet-type="${change.type}"][data-wallet-number="${change.number}"]`);
                        if (select) {
                            select.dataset.originalEnabled = change.enabled.toString();
                        }
                    }
                } else {
                    errorCount++;
                }
            } catch (error) {
                errorCount++;
            }
            
            // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // –£–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        progressContainer.remove();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
        loadAllWalletsFromForms(true);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
        if (errorCount === 0) {
            // –£—Å–ø–µ—Ö - –∑–µ–ª–µ–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
            button.innerHTML = `
                <span style="color: white; font-size: 18px; margin-right: 8px;">‚úì</span>
                <span>–£—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!</span>
            `;
            button.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
            button.style.boxShadow = '0 0 20px rgba(46, 204, 113, 0.4)';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 1.5 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                closeEditWalletsModal();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–æ—Ä–º –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞
                if (document.getElementById('formsTab').classList.contains('active')) {
                    loadForms();
                }
                
                // –ö—Ä–∞—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                if (changedWallets.length === 1) {
                    alert('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                } else {
                    alert(`‚úÖ ${changedWallets.length} –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!`);
                }
            }, 1500);
            
        } else if (successCount > 0) {
            // –ß–∞—Å—Ç–∏—á–Ω—ã–π —É—Å–ø–µ—Ö - –æ—Ä–∞–Ω–∂–µ–≤–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
            button.innerHTML = `
                <span style="color: white; font-size: 18px; margin-right: 8px;">‚ö†Ô∏è</span>
                <span>–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ${successCount}/${changedWallets.length}</span>
            `;
            button.style.background = 'linear-gradient(135deg, #e67e22, #d35400)';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.background = '';
                button.style.boxShadow = '';
                button.style.transform = '';
                button.disabled = false;
            }, 2000);
            
            alert(`‚ö†Ô∏è –ß–∞—Å—Ç–∏—á–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${successCount} —É—Å–ø–µ—à–Ω–æ, ${errorCount} —Å –æ—à–∏–±–∫–∞–º–∏`);
            
        } else {
            // –ü–æ–ª–Ω–∞—è –æ—à–∏–±–∫–∞ - –∫—Ä–∞—Å–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
            button.innerHTML = `
                <span style="color: white; font-size: 18px; margin-right: 8px;">‚ùå</span>
                <span>–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</span>
            `;
            button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            button.style.boxShadow = '0 0 20px rgba(231, 76, 60, 0.4)';
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.style.background = '';
                button.style.boxShadow = '';
                button.style.transform = '';
                button.disabled = false;
            }, 2000);
            
            alert('‚ùå –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å (F12)');
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
        const button = document.getElementById('saveChangesBtn');
        if (button) {
            button.innerHTML = `
                <span style="color: white; font-size: 18px; margin-right: 8px;">‚ùå</span>
                <span>–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span>
            `;
            button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            
            setTimeout(() => {
                button.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                button.style.background = '';
                button.style.transform = '';
                button.disabled = false;
            }, 2000);
        }
        
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
    }
}
        
// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞ –∏–∑ —Ñ–æ—Ä–º—ã
async function deleteWalletFromForm(formAPI, walletType, walletNumber) {
    try {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–æ—à–µ–ª—ë–∫ ${walletNumber} (${walletType})?`)) {
            return { success: false, error: '–û—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º' };
        }
        
        console.log('–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞:', { formAPI, walletType, walletNumber });
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = event?.target;
        const originalText = button?.innerHTML;
        if (button) {
            button.innerHTML = '<div class="loader" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px;"></div>–£–¥–∞–ª–µ–Ω–∏–µ...';
            button.disabled = true;
        }
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞
        const params = new URLSearchParams({
            action: 'delete_wallet',
            wallet_type: walletType,
            wallet_number: walletNumber
        });
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Ñ–æ—Ä–º—ã
        const response = await fetch(`${formAPI}?${params.toString()}`);
        const result = await response.json();
        
        console.log('–†–µ–∑—É–ª—å—Ç–∞—Ç —É–¥–∞–ª–µ–Ω–∏—è:', result);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        if (result.status === 'success') {
            return { success: true, message: '–ö–æ—à–µ–ª—ë–∫ —É–¥–∞–ª—ë–Ω' };
        } else {
            return { success: false, error: result.message || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è' };
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
        
        if (button) {
            button.innerHTML = originalText;
            button.disabled = false;
        }
        
        return { success: false, error: error.message };
    }
}

        // –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
function showButtonLoader(buttonId, text = '–ó–∞–≥—Ä—É–∑–∫–∞...') {
    const button = typeof buttonId === 'string' ? document.getElementById(buttonId) : buttonId;
    if (button) {
        button.dataset.originalText = button.innerHTML;
        button.innerHTML = `
            <div class="loader" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px; vertical-align: middle;"></div>
            <span style="vertical-align: middle;">${text}</span>
        `;
        button.disabled = true;
    }
}

// –°–∫—Ä—ã—Ç—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ
function hideButtonLoader(buttonId, originalText = null) {
    const button = typeof buttonId === 'string' ? document.getElementById(buttonId) : buttonId;
    if (button) {
        button.innerHTML = originalText || button.dataset.originalText || '';
        button.disabled = false;
    }
}

// –û–±–Ω–æ–≤–∏–º —Ñ—É–Ω–∫—Ü–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ –∑–∞–≥—Ä—É–∑–∫–∏
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –∫–æ—à–µ–ª—ë–∫" –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
async function addWalletToForm(formName) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        const form = formsResult.forms?.find(f => f.formName === formName);
        if (!form) {
            alert('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ø–æ–ª–µ–π –≤–≤–æ–¥–∞
        const type = document.getElementById('new_wallet_type').value;
        const name = document.getElementById('new_wallet_name').value || type;
        const number = document.getElementById('new_wallet_number').value.trim();
        const enabled = document.getElementById('new_wallet_enabled').value === 'true';
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!type || !number) {
            alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–∏–ø –∏ –Ω–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞');
            return;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω–æ–º–µ—Ä–∞ (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
        if (!/^[0-9]+$/.test(number)) {
            alert('–ù–æ–º–µ—Ä –∫–æ—à–µ–ª—å–∫–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã');
            return;
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—à–µ–ª—ë–∫
        const result = await addNewWalletToForm(form.formAPI, {
            type: type,
            name: name,
            number: number,
            enabled: enabled
        });
        
        if (result.success) {
            alert('‚úÖ –ö–æ—à–µ–ª—ë–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
            document.getElementById('new_wallet_name').value = '';
            document.getElementById('new_wallet_number').value = '';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            showEditWalletsModal(formName);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
            loadAllWalletsFromForms(true);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + result.error);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞
        async function deleteWalletFromForm(formName, walletType, walletNumber) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
                const token = localStorage.getItem('admin_token');
                const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
                const formsResult = await formsResponse.json();
                
                const form = formsResult.forms?.find(f => f.formName === formName);
                if (!form) {
                    alert('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                // –£–¥–∞–ª—è–µ–º –∫–æ—à–µ–ª—ë–∫
                const result = await deleteWalletFromFormAPI(form.formAPI, walletType, walletNumber);
                
                if (result.success) {
                    alert('‚úÖ –ö–æ—à–µ–ª—ë–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω!');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    showEditWalletsModal(formName);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
                    loadAllWalletsFromForms(true);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞: ' + result.error);
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
async function applyWalletChanges(formName) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        const form = formsResult.forms?.find(f => f.formName === formName);
        if (!form) {
            alert('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const button = document.getElementById('applyChangesBtn');
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="loader" style="width: 16px; height: 16px; display: inline-block; margin-right: 8px;"></div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π...';
        button.disabled = true;
        
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        const changes = [];
        
        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º —Å—Ç—Ä–æ–∫–∞–º —Ç–∞–±–ª–∏—Ü—ã –∏ —Å–æ–±–∏—Ä–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
        const tableRows = document.querySelectorAll('#modalFormContent table tbody tr');
        tableRows.forEach(row => {
            const typeElement = row.querySelector('td:nth-child(1) span');
            const numberElement = row.querySelector('td:nth-child(3) code');
            const statusSelect = row.querySelector('td:nth-child(4) select');
            
            if (typeElement && numberElement && statusSelect) {
                const walletType = typeElement.textContent.trim();
                const walletNumber = numberElement.textContent.trim();
                const newStatus = statusSelect.value === 'enabled';
                
                changes.push({
                    type: walletType,
                    number: walletNumber,
                    enabled: newStatus
                });
            }
        });
        
        console.log('–ò–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', changes);
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ –æ–¥–Ω–æ–º—É
        let successCount = 0;
        let errorCount = 0;
        
        for (const change of changes) {
            try {
                const result = await updateWalletInForm(form.formAPI, change.type, change.number, change.enabled);
                if (result.success) {
                    successCount++;
                } else {
                    errorCount++;
                    console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', change, result.error);
                }
            } catch (error) {
                errorCount++;
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—à–µ–ª—å–∫–∞:', change, error);
            }
            
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
            await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        button.innerHTML = originalText;
        button.disabled = false;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (errorCount === 0) {
            alert(`‚úÖ –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n\n–£—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${successCount} –∫–æ—à–µ–ª—å–∫–æ–≤`);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            loadAllWalletsFromForms(true); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à
            setTimeout(() => closeEditWalletsModal(), 1000);
        } else {
            alert(`‚ö†Ô∏è –ß–∞—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞\n\n–£—Å–ø–µ—à–Ω–æ: ${successCount}\n–û—à–∏–±–æ–∫: ${errorCount}\n\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –¥–µ—Ç–∞–ª–µ–π`);
        }
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
        const button = document.getElementById('applyChangesBtn');
        if (button) {
            button.innerHTML = '‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            button.disabled = false;
        }
        
        alert('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message);
    }
}

// –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeEditWalletsModal() {
    document.getElementById('editWalletsModal').style.display = 'none';
    document.getElementById('modalFormContent').innerHTML = '';
}

// ========== –ê–ì–ï–ù–¢–´ ==========
async function loadAgents() {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('agentsList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
        
        const response = await fetch(`${API_URL}?action=get_agents&token=${token}`);
        const result = await response.json();
        
        if (result.success && result.agents && result.agents.length > 0) {
            let html = '<table class="wallet-table"><thead><tr>';
            html += '<th>–õ–æ–≥–∏–Ω</th><th>Email</th><th>–†–æ–ª—å</th><th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
            
            result.agents.forEach(agent => {
                const lastLogin = agent.lastLogin ? 
                    new Date(agent.lastLogin).toLocaleString() : '–ù–∏–∫–æ–≥–¥–∞';
                const isOnline = isAgentOnline(agent.lastLogin);
                
                html += `
                    <tr>
                        <td><strong>${agent.username}</strong></td>
                        <td>${agent.email || '–ù–µ—Ç email'}</td>
                        <td>
                            <span style="background: ${getRoleColor(agent.role)}; padding: 3px 8px; border-radius: 12px; color: white; font-size: 12px;">
                                ${agent.role}
                            </span>
                        </td>
                        <td>${lastLogin}</td>
                        <td>
                            <span style="color: ${isOnline ? '#2ecc71' : '#95a5a6'}">
                                ${isOnline ? 'üü¢ –û–Ω–ª–∞–π–Ω' : '‚ö´ –û—Ñ–ª–∞–π–Ω'}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p>–ê–≥–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>';
        }
    } catch (error) {
        document.getElementById('agentsList').innerHTML = 
            `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
}

// ========== –ò–°–¢–û–†–ò–Ø ==========
async function loadHistory() {
    try {
        const token = localStorage.getItem('admin_token');
        const filter = document.getElementById('historyFilter').value;
        const container = document.getElementById('historyList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p><div class="loader"></div>';
        
        let url = `${API_URL}?action=get_wallet_history&token=${token}`;
        if (filter) {
            url += `&form_name=${encodeURIComponent(filter)}`;
        }
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.history && result.history.length > 0) {
            let html = `<p>–ù–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${result.count}</p>`;
            html += '<table class="wallet-table"><thead><tr>';
            html += '<th>–§–æ—Ä–º–∞</th><th>–¢–∏–ø –∫–æ—à–µ–ª—å–∫–∞</th><th>–ù–æ–º–µ—Ä</th><th>–ê–≥–µ–Ω—Ç</th><th>–í—Ä–µ–º—è</th><th>–°—É–º–º–∞</th><th>–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>';
            
            result.history.forEach(record => {
                html += `
                    <tr>
                        <td><strong>${record.formName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></td>
                        <td>${record.walletType || '‚Äî'}</td>
                        <td><code>${record.walletNumber || '‚Äî'}</code></td>
                        <td>${record.agentId || '–°–∏—Å—Ç–µ–º–∞'}</td>
                        <td>${record.usedAt ? new Date(record.usedAt).toLocaleString() : '‚Äî'}</td>
                        <td style="color: #2ecc71; font-weight: bold;">${record.amount || 0}</td>
                        <td>
                            <span style="color: ${record.status === 'success' ? '#2ecc71' : '#e74c3c'}">
                                ${record.status === 'success' ? '‚úÖ –£—Å–ø–µ—Ö' : record.status || '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        } else {
            container.innerHTML = '<p>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π –ø—É—Å—Ç–∞.</p>';
        }
    } catch (error) {
        document.getElementById('historyList').innerHTML = 
            `<p style="color: #e74c3c">–û—à–∏–±–∫–∞: ${error.message}</p>`;
    }
}

function clearHistoryFilter() {
    document.getElementById('historyFilter').value = '';
    loadHistory();
}

        // ========== –ê–î–ú–ò–ù–´ ==========
        // ========== –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ì–ï–ù–¢–ê–ú–ò –§–û–†–ú–´ ==========
async function manageFormAgents(formName) {
    try {
        // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ä–º–µ
        const token = localStorage.getItem('admin_token');
        const formsResponse = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const formsResult = await formsResponse.json();
        
        const form = formsResult.forms?.find(f => f.formName === formName);
        if (!form) {
            alert('–§–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            return;
        }
        
        // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
        const modalHTML = `
            <div id="manageAgentsModal" style="display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
                <div style="background: var(--card-bg); padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="color: var(--accent);">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç–∞–º–∏ —Ñ–æ—Ä–º—ã</h3>
                        <button onclick="closeManageAgentsModal()" style="background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;">√ó</button>
                    </div>
                    
                    <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                            <div style="background: #3498db; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                üìã
                            </div>
                            <div>
                                <h4 style="margin: 0; color: white;">${formName}</h4>
                                <div style="font-size: 13px; color: #95a5a6; margin-top: 3px;">
                                    ${form.formAPI ? `<code style="font-size: 11px;">${form.formAPI}</code>` : '–ù–µ—Ç API URL'}
                                </div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                            <div style="background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); border-radius: 8px; padding: 10px;">
                                <div style="font-size: 12px; color: #95a5a6;">–°—Ç–∞—Ç—É—Å</div>
                                <div style="font-size: 16px; font-weight: bold; color: ${form.enabled ? '#2ecc71' : '#e74c3c'}">
                                    ${form.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–∞'}
                                </div>
                            </div>
                            <div style="background: rgba(52, 152, 219, 0.1); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 8px; padding: 10px;">
                                <div style="font-size: 12px; color: #95a5a6;">–¢–µ—Ö. —Ä–∞–±–æ—Ç—ã</div>
                                <div style="font-size: 16px; font-weight: bold; color: ${form.serviceMode ? '#e67e22' : '#2ecc71'}">
                                    ${form.serviceMode ? 'üîß –í–∫–ª—é—á–µ–Ω—ã' : '‚úÖ –ù–µ—Ç'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="agentsManagementContent">
                        <div style="text-align: center; padding: 40px;">
                            <div class="loader"></div>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ DOM
        const modalDiv = document.createElement('div');
        modalDiv.innerHTML = modalHTML;
        document.body.appendChild(modalDiv);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç–æ–≤
        await loadFormAgentsData(formName, form.formAPI);
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è
        window.closeManageAgentsModal = function() {
            const modal = document.getElementById('manageAgentsModal');
            if (modal) {
                modal.remove();
            }
        };
        
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞: ' + error.message);
    }
}

async function loadFormAgentsData(formName, formAPI) {
    try {
        const token = localStorage.getItem('admin_token');
        const container = document.getElementById('agentsManagementContent');
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        const response = await fetch(`${API_URL}?action=get_form_assignments&token=${token}&form_name=${encodeURIComponent(formName)}`);
        const result = await response.json();
        
        if (!result.success) {
            container.innerHTML = `
                <div style="text-align: center; padding: 30px; color: #e74c3c;">
                    <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>
                    <button class="btn" onclick="loadFormAgentsData('${formName}', '${formAPI}')" style="margin-top: 15px;">
                        üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                    </button>
                </div>
            `;
            return;
        }
        
        let html = `
            <!-- –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã -->
            <div style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px; color: white; display: flex; align-items: center; gap: 10px;">
                    <span>üë• –ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã</span>
                    <span style="background: #3498db; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                        ${result.assignments.length}
                    </span>
                </h4>
        `;
        
        if (result.assignments.length > 0) {
            html += `
                <div style="display: grid; gap: 10px;">
                    ${result.assignments.map(assignment => `
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: white;">${assignment.agentId}</strong>
                                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                                        –£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞: ${assignment.accessLevel === 'full' ? '–ü–æ–ª–Ω—ã–π' : '–ü—Ä–æ—Å–º–æ—Ç—Ä'}
                                    </div>
                                    <div style="font-size: 11px; color: #95a5a6; margin-top: 3px;">
                                        –ù–∞–∑–Ω–∞—á–µ–Ω: ${assignment.assignedAt ? new Date(assignment.assignedAt).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                                    </div>
                                </div>
                                <button onclick="removeAgentFromForm('${assignment.agentId}', '${formName}')" 
                                        style="padding: 6px 12px; background: rgba(231, 76, 60, 0.1); 
                                               border: 1px solid #e74c3c; color: #e74c3c; border-radius: 5px; 
                                               cursor: pointer; font-size: 12px;">
                                    –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        } else {
            html += `
                <div style="text-align: center; padding: 30px; background: rgba(0,0,0,0.2); border-radius: 8px; color: #95a5a6;">
                    <p>–ù–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</p>
                    <p style="font-size: 13px; margin-top: 10px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∞–≥–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ</p>
                </div>
            `;
        }
        
        html += `</div>`;
        
        // –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
        html += `
            <div>
                <h4 style="margin-bottom: 15px; color: white; display: flex; align-items: center; gap: 10px;">
                    <span>üë§ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã</span>
                    <span style="background: #2ecc71; color: white; padding: 3px 10px; border-radius: 12px; font-size: 12px;">
                        ${result.availableAgents.length}
                    </span>
                </h4>
        `;
        
        if (result.availableAgents.length > 0) {
            const availableAgents = result.availableAgents.filter(agent => !agent.isAssigned);
            
            if (availableAgents.length > 0) {
                html += `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        ${availableAgents.map(agent => `
                            <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px;">
                                <div style="margin-bottom: 10px;">
                                    <strong style="color: white;">${agent.username}</strong>
                                    <div style="font-size: 12px; color: #95a5a6; margin-top: 5px;">
                                        <span style="background: ${getRoleColor(agent.role)}; padding: 2px 8px; border-radius: 10px; color: white;">
                                            ${getRoleName(agent.role)}
                                        </span>
                                    </div>
                                    ${agent.email ? `
                                        <div style="font-size: 11px; color: #95a5a6; margin-top: 5px;">
                                            üìß ${agent.email}
                                        </div>
                                    ` : ''}
                                </div>
                                <button onclick="assignAgentToForm('${agent.username}', '${formName}', '${formAPI}')" 
                                        style="width: 100%; padding: 8px; background: rgba(46, 204, 113, 0.1); 
                                               border: 1px solid #2ecc71; color: #2ecc71; border-radius: 5px; 
                                               cursor: pointer; font-size: 12px;">
                                    ‚ûï –ù–∞–∑–Ω–∞—á–∏—Ç—å
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                html += `
                    <div style="text-align: center; padding: 30px; background: rgba(0,0,0,0.2); border-radius: 8px; color: #95a5a6;">
                        <p>–í—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∞–≥–µ–Ω—Ç—ã —É–∂–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</p>
                        <p style="font-size: 13px; margin-top: 10px;">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–¥–º–∏–Ω—ã"</p>
                    </div>
                `;
            }
        } else {
            html += `
                <div style="text-align: center; padding: 30px; background: rgba(0,0,0,0.2); border-radius: 8px; color: #95a5a6;">
                    <p>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</p>
                    <p style="font-size: 13px; margin-top: 10px;">–°–æ–∑–¥–∞–π—Ç–µ –∞–≥–µ–Ω—Ç–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ê–¥–º–∏–Ω—ã"</p>
                </div>
            `;
        }
        
        html += `</div>`;
        
        container.innerHTML = html;
        
    } catch (error) {
        const container = document.getElementById('agentsManagementContent');
        container.innerHTML = `
            <div style="text-align: center; padding: 30px; color: #e74c3c;">
                <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</p>
                <button class="btn" onclick="loadFormAgentsData('${formName}', '${formAPI}')" style="margin-top: 15px;">
                    üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                </button>
            </div>
        `;
    }
}

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ê–ì–ï–ù–¢–ê–ú–ò ==========
async function assignAgentToForm(agentId, formName, formAPI) {
    try {
        if (!confirm(`–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ "${agentId}" –Ω–∞ —Ñ–æ—Ä–º—É "${formName}"?`)) {
            return;
        }
        
        const token = localStorage.getItem('admin_token');
        const url = `${API_URL}?action=assign_agent_to_form&token=${token}&agent_id=${encodeURIComponent(agentId)}&form_name=${encodeURIComponent(formName)}&form_api=${encodeURIComponent(formAPI)}&access_level=full`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ –ê–≥–µ–Ω—Ç "${agentId}" –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Ñ–æ—Ä–º—É!`);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await loadFormAgentsData(formName, formAPI);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
}

async function removeAgentFromForm(agentId, formName) {
    try {
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–≥–µ–Ω—Ç–∞ "${agentId}" —Å —Ñ–æ—Ä–º—ã "${formName}"?`)) {
            return;
        }
        
        const token = localStorage.getItem('admin_token');
        const url = `${API_URL}?action=remove_agent_from_form&token=${token}&agent_id=${encodeURIComponent(agentId)}&form_name=${encodeURIComponent(formName)}`;
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            alert(`‚úÖ –ê–≥–µ–Ω—Ç "${agentId}" —É–¥–∞–ª–µ–Ω —Å —Ñ–æ—Ä–º—ã!`);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            const form = await getFormInfo(formName);
            if (form) {
                await loadFormAgentsData(formName, form.formAPI);
            }
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ñ–æ—Ä–º–µ
async function getFormInfo(formName) {
    try {
        const token = localStorage.getItem('admin_token');
        const response = await fetch(`${API_URL}?action=get_all_forms&token=${token}`);
        const result = await response.json();
        
        if (result.success && result.forms) {
            return result.forms.find(f => f.formName === formName);
        }
        return null;
    } catch (error) {
        console.error('Error getting form info:', error);
        return null;
    }
}

        // ========== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ü–ê–†–û–õ–Ø ==========
        function generatePassword() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
            let password = '';
            
            // –ú–∏–Ω–∏–º—É–º 12 —Å–∏–º–≤–æ–ª–æ–≤
            for (let i = 0; i < 12; i++) {
                password += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            document.getElementById('newAdminPassword').value = password;
            document.getElementById('newAdminPassword').type = 'text';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∏–ª—É –ø–∞—Ä–æ–ª—è
            checkPasswordStrength(password);
            
            // –ß–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥ —Å–∫—Ä—ã–≤–∞–µ–º –ø–∞—Ä–æ–ª—å
            setTimeout(() => {
                document.getElementById('newAdminPassword').type = 'password';
            }, 5000);
        }
        
        function checkPasswordStrength(password) {
            const strengthDiv = document.getElementById('passwordStrength');
            let strength = 0;
            let message = '';
            let color = '#e74c3c';
            
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            switch(strength) {
                case 4:
                    message = '–û—Ç–ª–∏—á–Ω—ã–π –ø–∞—Ä–æ–ª—å ‚úì';
                    color = '#2ecc71';
                    break;
                case 3:
                    message = '–•–æ—Ä–æ—à–∏–π –ø–∞—Ä–æ–ª—å ‚úì';
                    color = '#2ecc71';
                    break;
                case 2:
                    message = '–°—Ä–µ–¥–Ω–∏–π –ø–∞—Ä–æ–ª—å';
                    color = '#e67e22';
                    break;
                default:
                    message = '–°–ª–∞–±—ã–π –ø–∞—Ä–æ–ª—å';
                    color = '#e74c3c';
            }
            
            strengthDiv.innerHTML = `<span style="color: ${color}">${message}</span>`;
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('newAdminRole');
            const descriptionSpan = document.getElementById('selectedRoleDescription');
            
            if (roleSelect && descriptionSpan) {
                roleSelect.addEventListener('change', function() {
                    const descriptions = {
                        'viewer': '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏',
                        'manager': '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏ –∏ –∫–æ—à–µ–ª—å–∫–∞–º–∏',
                        'admin': '–ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º'
                    };
                    descriptionSpan.textContent = descriptions[this.value] || '';
                });
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
                descriptionSpan.textContent = '–¢–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏';
            }
        });
        
        // ========== –°–û–ó–î–ê–ù–ò–ï –ê–î–ú–ò–ù–ê ==========
        async function createNewAdmin() {
            try {
                const username = document.getElementById('newAdminUsername').value.trim();
                const password = document.getElementById('newAdminPassword').value.trim();
                const email = document.getElementById('newAdminEmail').value.trim();
                const role = document.getElementById('newAdminRole').value;
                
                // –í–∞–ª–∏–¥–∞—Ü–∏—è
                if (!username || !password) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å');
                    return;
                }
                
                if (username.length < 3) {
                    alert('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                
                if (password.length < 8) {
                    alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                
                if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                    alert('–õ–æ–≥–∏–Ω –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ');
                    return;
                }
                
                const button = document.getElementById('createAdminBtn');
                const originalText = button.innerHTML;
                button.innerHTML = '<div class="loader-small" style="display: inline-block; margin-right: 8px;"></div>–°–æ–∑–¥–∞–Ω–∏–µ...';
                button.disabled = true;
                
                const token = localStorage.getItem('admin_token');
                const url = `${API_URL}?action=create_admin&token=${token}&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&email=${encodeURIComponent(email)}&role=${role}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (result.success) {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
                    document.getElementById('newAdminUsername').value = '';
                    document.getElementById('newAdminPassword').value = '';
                    document.getElementById('newAdminEmail').value = '';
                    document.getElementById('passwordStrength').innerHTML = '';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    button.innerHTML = '<span style="color: white; margin-right: 8px;">‚úì</span> –°–æ–∑–¥–∞–Ω!';
                    button.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
                    setTimeout(() => {
                        loadAdmins(true);
                        button.innerHTML = originalText;
                        button.style.background = '';
                    }, 1500);
                    
                    alert(`‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä "${username}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!\n\n–†–æ–ª—å: ${role}\n–ü–∞—Ä–æ–ª—å: ${password}\n\n‚ö†Ô∏è –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å! –ï–≥–æ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–∑–∂–µ.`);
                    
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                const button = document.getElementById('createAdminBtn');
                if (button) {
                    button.innerHTML = '‚ûï –°–æ–∑–¥–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
                    button.disabled = false;
                }
            }
        }
        
        // ========== –ó–ê–ì–†–£–ó–ö–ê –ê–î–ú–ò–ù–û–í ==========
        async function loadAdmins(forceRefresh = false) {
            try {
                const container = document.getElementById('adminsList');
                const button = document.getElementById('refreshAdminsBtn');
                const originalText = button.innerHTML;
                
                button.innerHTML = '<div class="loader-small" style="display: inline-block; margin-right: 8px;"></div>–ó–∞–≥—Ä—É–∑–∫–∞...';
                button.disabled = true;
                
                container.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loader"></div><p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤...</p></div>';
                
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}?action=get_agents&token=${token}&force=${forceRefresh ? 'true' : 'false'}`);
                const result = await response.json();
                
                button.innerHTML = originalText;
                button.disabled = false;
                
                if (result.success && result.agents && result.agents.length > 0) {
                    let html = `
                        <div style="margin-bottom: 15px; color: #95a5a6; font-size: 14px;">
                            –í—Å–µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤: ${result.agents.length}
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="wallet-table" style="min-width: 800px;">
                                <thead>
                                    <tr>
                                        <th>–õ–æ–≥–∏–Ω</th>
                                        <th>Email</th>
                                        <th>–†–æ–ª—å</th>
                                        <th>–ê–∫—Ç–∏–≤–µ–Ω</th>
                                        <th>–°–æ–∑–¥–∞–Ω</th>
                                        <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    result.agents.forEach(admin => {
                        const createdDate = admin.createdAt ? 
                            new Date(admin.createdAt).toLocaleDateString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                        const lastLogin = admin.lastLogin ? 
                            new Date(admin.lastLogin).toLocaleString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';
                        const isActive = admin.isActive !== false;
                        
                        html += `
                            <tr>
                                <td>
                                    <strong>${admin.username}</strong>
                                    ${admin.username === 'superadmin' ? 
                                        '<div style="font-size: 11px; color: #e74c3c;">üî¥ –°—É–ø–µ—Ä–∞–¥–º–∏–Ω</div>' : ''
                                    }
                                </td>
                                <td>${admin.email || '<span style="color: #95a5a6;">‚Äî</span>'}</td>
                                <td>
                                    <span style="background: ${getRoleColor(admin.role)}; padding: 5px 10px; border-radius: 15px; color: white; font-size: 12px; display: inline-block;">
                                        ${getRoleName(admin.role)}
                                    </span>
                                </td>
                                <td>
                                    <span style="color: ${isActive ? '#2ecc71' : '#e74c3c'}">
                                        ${isActive ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}
                                    </span>
                                </td>
                                <td style="font-size: 13px;">${createdDate}</td>
                                <td style="font-size: 13px;">${lastLogin}</td>
                                <td>
                                    <div style="display: flex; gap: 5px;">
                                        <button class="btn" style="padding: 6px 10px; font-size: 12px;" 
                                                onclick="editAdmin('${admin.username}')"
                                                ${admin.username === 'superadmin' ? 'disabled title="–ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞"' : ''}>
                                            ‚úèÔ∏è
                                        </button>
                                        <button class="btn btn-danger" style="padding: 6px 10px; font-size: 12px;" 
                                                onclick="deleteAdmin('${admin.username}')"
                                                ${admin.username === 'superadmin' ? 'disabled title="–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å—É–ø–µ—Ä–∞–¥–º–∏–Ω–∞"' : ''}>
                                            üóëÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += `</tbody></table></div>`;
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #95a5a6;">
                            <p>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                            <p style="font-size: 14px; margin-top: 10px;">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</p>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('adminsList').innerHTML = `
                    <div style="color: #e74c3c; text-align: center; padding: 20px;">
                        <p><strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:</strong></p>
                        <p>${error.message}</p>
                        <button class="btn" onclick="loadAdmins(true)" style="margin-top: 15px;">
                            üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
                        </button>
                    </div>
                `;
                
                const button = document.getElementById('refreshAdminsBtn');
                if (button) {
                    button.innerHTML = 'üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫';
                    button.disabled = false;
                }
            }
        }
        
        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function getRoleName(role) {
            const names = {
                'superadmin': '–°—É–ø–µ—Ä–∞–¥–º–∏–Ω',
                'admin': '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
                'manager': '–ú–µ–Ω–µ–¥–∂–µ—Ä',
                'viewer': '–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å'
            };
            return names[role] || role;
        }
        
        function getRoleColor(role) {
            switch(role) {
                case 'superadmin': return '#e74c3c';
                case 'admin': return '#3498db';
                case 'manager': return '#2ecc71';
                case 'viewer': return '#95a5a6';
                default: return '#7f8c8d';
            }
        }
        
        async function editAdmin(username) {
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}?action=get_agents&token=${token}`);
                const result = await response.json();
                
                if (!result.success || !result.agents) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞');
                    return;
                }
                
                const admin = result.agents.find(a => a.username === username);
                if (!admin) {
                    alert('–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('editAdminModalTitle').textContent = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ${username}`;
                
                document.getElementById('editAdminModalContent').innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–õ–æ–≥–∏–Ω</label>
                            <input type="text" value="${admin.username}" disabled
                                   style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                          color: #95a5a6; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">Email</label>
                            <input type="email" id="editAdminEmail" value="${admin.email || ''}" placeholder="user@example.com"
                                   style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                          color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;">
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; color: #95a5a6;">–†–æ–ª—å</label>
                            <select id="editAdminRole" 
                                    style="width: 100%; padding: 12px; background: rgba(255,255,255,0.05); 
                                           color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 5px;">
                                <option value="viewer" ${admin.role === 'viewer' ? 'selected' : ''}>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</option>
                                <option value="manager" ${admin.role === 'manager' ? 'selected' : ''}>–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                                <option value="admin" ${admin.role === 'admin' ? 'selected' : ''}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: flex; align-items: center; gap: 10px; font-size: 13px; color: #95a5a6;">
                                <input type="checkbox" id="editAdminActive" ${admin.isActive !== false ? 'checked' : ''}>
                                –ê–∫—Ç–∏–≤–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button onclick="closeEditAdminModal()" 
                                style="flex: 1; padding: 12px; background: rgba(231, 76, 60, 0.1); 
                                       border: 1px solid rgba(231, 76, 60, 0.3); color: #e74c3c; 
                                       border-radius: 8px; cursor: pointer; font-size: 14px;">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </button>
                        <button onclick="saveAdminChanges('${username}')" id="saveAdminBtn"
                                style="flex: 2; padding: 12px; background: linear-gradient(135deg, #2ecc71, #27ae60); 
                                       border: none; color: white; border-radius: 8px; cursor: pointer; 
                                       font-size: 14px; font-weight: bold;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                        </button>
                    </div>
                `;
                
                document.getElementById('editAdminModal').style.display = 'flex';
                
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
            }
        }
        
        async function saveAdminChanges(username) {
            try {
                const email = document.getElementById('editAdminEmail').value.trim();
                const role = document.getElementById('editAdminRole').value;
                const isActive = document.getElementById('editAdminActive').checked;
                
                const button = document.getElementById('saveAdminBtn');
                const originalText = button.innerHTML;
                button.innerHTML = '<div class="loader-small" style="display: inline-block; margin-right: 8px;"></div>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
                button.disabled = true;
                
                const token = localStorage.getItem('admin_token');
                const url = `${API_URL}?action=update_admin&token=${token}&username=${encodeURIComponent(username)}&email=${encodeURIComponent(email)}&role=${role}&is_active=${isActive}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    button.innerHTML = '<span style="color: white; margin-right: 8px;">‚úì</span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!';
                    button.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                    
                    setTimeout(() => {
                        closeEditAdminModal();
                        loadAdmins(true);
                    }, 1000);
                } else {
                    button.innerHTML = originalText;
                    button.disabled = false;
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
                const button = document.getElementById('saveAdminBtn');
                if (button) {
                    button.innerHTML = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
                    button.disabled = false;
                }
            }
        }
        
        function closeEditAdminModal() {
            document.getElementById('editAdminModal').style.display = 'none';
        }
        
        async function deleteAdmin(username) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ "${username}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                return;
            }
            
            try {
                const token = localStorage.getItem('admin_token');
                const url = `${API_URL}?action=delete_admin&token=${token}&username=${encodeURIComponent(username)}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                    loadAdmins(true);
                } else {
                    alert('‚ùå –û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
            }
        }

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function isAgentOnline(lastLogin) {
    if (!lastLogin) return false;
    const lastLoginTime = new Date(lastLogin).getTime();
    const now = Date.now();
    // –°—á–∏—Ç–∞–µ–º –æ–Ω–ª–∞–π–Ω, –µ—Å–ª–∏ –±—ã–ª –≤ —Å–µ—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –º–∏–Ω—É—Ç
    return (now - lastLoginTime) < 30 * 60 * 1000;
}

function editAdmin(username) {
    alert('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥–º–∏–Ω–∞: ' + username + '\n(—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}

function deleteAdmin(username) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ "${username}"?`)) {
        alert('–£–¥–∞–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞: ' + username + '\n(—Ñ—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É)
function getOnlineAgentsCount(total) {
    return Math.floor(total * 0.7); // –ü—Ä–∏–º–µ—Ä: 70% –æ–Ω–ª–∞–π–Ω
}
        
                // ========== –ö–û–®–ï–õ–¨–ö–ò (–æ–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) ==========
           async function loadWallets(forceRefresh = false) {
    try {
        const container = document.getElementById('walletsList');
        container.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—à–µ–ª—å–∫–æ–≤...</p><div class="loader"></div>';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ –∏–∑ –∫—ç—à–∞ –∏–ª–∏ —Ñ–æ—Ä–º
        const wallets = await loadAllWalletsFromForms(forceRefresh);
        const walletsArray = Object.values(wallets);
        
        console.log('–ö–æ—à–µ–ª—å–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è:', walletsArray.length);
        
        if (walletsArray.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ö</p>
                    <button class="btn" onclick="loadWallets(true)" style="margin-top: 10px;">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                </div>
            `;
            return;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∫–æ—à–µ–ª—å–∫–∏ (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –∫–∞–∫ –±—ã–ª, –Ω–æ —Å walletsArray)
        let html = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>–ö–æ—à–µ–ª—å–∫–∏ –∏–∑ —Ñ–æ—Ä–º: ${walletsArray.length}</h3>
                <div>
                    <button class="btn" onclick="loadWallets(true)" title="–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-success" onclick="showAddWalletForm()" style="margin-left: 10px;">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                </div>
            </div>
            <table class="wallet-table">
                <thead>
                    <tr>
                        <th>–¢–∏–ø</th>
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ù–æ–º–µ—Ä</th>
                        <th>–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Ñ–æ—Ä–º–∞—Ö</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        walletsArray.forEach(wallet => {
            const walletTypeColor = getWalletTypeColor(wallet.type);
            
            html += `
                <tr>
                    <td>
                        <span style="background: ${walletTypeColor}; padding: 5px 10px; border-radius: 15px; color: white; font-size: 12px;">
                            ${wallet.type}
                        </span>
                    </td>
                    <td>${wallet.name}</td>
                    <td>
                        <code style="background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; cursor: pointer;" 
                              onclick="copyToClipboard('${wallet.number}')">
                            ${wallet.number}
                        </code>
                    </td>
                    <td>
                        ${wallet.forms.map(formName => 
                            `<span style="background: #3498db; color: white; padding: 3px 8px; border-radius: 10px; margin: 2px; display: inline-block; font-size: 12px;">
                                ${formName}
                            </span>`
                        ).join('')}
                    </td>
                    <td style="color: ${wallet.enabled ? '#2ecc71' : '#e74c3c'}">
                        ${wallet.enabled ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚ùå –û—Ç–∫–ª—é—á–µ–Ω'}
                    </td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 12px;" 
                                onclick="editFormWallet('${wallet.type}', '${wallet.number}')">
                            ‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤:', error);
        container.innerHTML = `
            <p style="color: #e74c3c">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—à–µ–ª—å–∫–æ–≤: ${error.message}</p>
            <button class="btn" onclick="loadWallets(true)">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É</button>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–∏–ø–∞ –∫–æ—à–µ–ª—å–∫–∞
function getWalletTypeColor(type) {
    const colors = {
        'vodafone': '#e4405f',
        'instapay': '#3498db',
        'orange': '#ff9800',
        'etisalat': '#4caf50',
        'we': '#9c27b0'
    };
    return colors[type] || '#7f8c8d';
}

// –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è (–±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ)
function editFormWallet(walletType, walletNumber) {
    alert(`–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞:\n–¢–∏–ø: ${walletType}\n–ù–æ–º–µ—Ä: ${walletNumber}\n\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
}

function showAddWalletForm() {
    alert('–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞ –≤ —Ñ–æ—Ä–º—É\n\n(–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)');
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ü–≤–µ—Ç–∞ —Ç–∏–ø–∞ –∫–æ—à–µ–ª—å–∫–∞
function getWalletTypeColor(type) {
    const colors = {
        'vodafone': '#e4405f',
        'instapay': '#3498db',
        'orange': '#ff9800',
        'etisalat': '#4caf50',
        'we': '#9c27b0'
    };
    return colors[type] || '#7f8c8d';
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ (–∞–∫—Ç–∏–≤–Ω—ã–µ + –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ)
async function showAllWallets() {
    // –ë—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ
    alert('–§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–æ—à–µ–ª—å–∫–æ–≤ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
}
        
        async function toggleWallet(walletId, newStatus) {
            if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${newStatus ? '–≤–∫–ª—é—á–∏—Ç—å' : '–æ—Ç–∫–ª—é—á–∏—Ç—å'} —ç—Ç–æ—Ç –∫–æ—à–µ–ª—ë–∫?`)) return;
            
            try {
                const token = localStorage.getItem('admin_token');
                const response = await fetch(`${API_URL}?action=update_wallet&token=${token}&wallet_id=${walletId}&enabled=${newStatus}`);
                
                if (!response.ok) {
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    alert('–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω!');
                    loadWallets();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        function showAddWalletForm() {
            const container = document.getElementById('walletsList');
            container.innerHTML = `
                <div style="background: var(--card-bg); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ—à–µ–ª—ë–∫</h3>
                    <div style="display: grid; gap: 15px; margin-top: 15px;">
                        <div>
                            <label>–¢–∏–ø –∫–æ—à–µ–ª—å–∫–∞</label>
                            <input type="text" id="newWalletType" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: vodafone" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(255,255,255,0.9); color: #2c3e50;">
                        </div>
                        <div>
                            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="newWalletName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Vodafone Cash" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(255,255,255,0.9); color: #2c3e50;">
                        </div>
                        <div>
                            <label>–ù–æ–º–µ—Ä</label>
                            <input type="text" id="newWalletNumber" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 01012345678" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid var(--border); background: rgba(255,255,255,0.9); color: #2c3e50;">
                        </div>
                        <div>
                            <label>
                                <input type="checkbox" id="newWalletEnabled" checked> –ê–∫—Ç–∏–≤–µ–Ω
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="addNewWallet()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="btn" onclick="loadWallets()">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function addNewWallet() {
            try {
                const type = document.getElementById('newWalletType').value.trim();
                const name = document.getElementById('newWalletName').value.trim();
                const number = document.getElementById('newWalletNumber').value.trim();
                const enabled = document.getElementById('newWalletEnabled').checked;
                
                if (!type || !name || !number) {
                    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    return;
                }
                
                const token = localStorage.getItem('admin_token');
                const url = `${API_URL}?action=add_wallet&token=${token}&type=${encodeURIComponent(type)}&name=${encodeURIComponent(name)}&number=${encodeURIComponent(number)}&enabled=${enabled}`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    alert('–ö–æ—à–µ–ª—ë–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    loadWallets();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ: ' + text);
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }
        
        function switchTab(tabName) {
    // –°–∫—Ä—ã—Ç—å –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é
    document.getElementById(tabName + 'Tab').classList.add('active');
    document.querySelector(`.tab[onclick*="${tabName}"]`).classList.add('active');
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏
    switch(tabName) {
        case 'wallets':
            loadWallets();
            break;
        case 'forms':
            loadForms();
            break;
        case 'agents':
            loadAgents();
            break;
        case 'history':
            loadHistory();
            break;
        case 'admins':
            loadAdmins();
            break;
        case 'dashboard':
            loadDashboard();
            break;
    }
}

        document.getElementById('formsTab').innerHTML = `
    <h2>üåê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞–º–∏</h2>
    <div style="margin-bottom: 20px; display: flex; gap: 10px;">
        <button class="btn" onclick="loadForms()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-success" onclick="showAddFormModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        <button class="btn" onclick="refreshAllFormsData()">üì° –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</button>
    </div>
    <div id="formsList" style="margin-top: 20px;">
        <p>–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ä–º</p>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ—à–µ–ª—å–∫–æ–≤ -->
    <div id="editWalletsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: var(--card-bg); padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalFormTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–æ–≤</h3>
                <button onclick="closeEditWalletsModal()" style="background: none; border: none; color: var(--text); font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div id="modalFormContent">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
`;
        
        async function logout() {
            try {
                const token = localStorage.getItem('admin_token');
                if (token) {
                    await fetch(`${API_URL}?action=logout&token=${token}`).catch(() => {});
                }
            } finally {
                localStorage.clear();
                window.location.href = 'login.html';
            }
        }
    </script>
</body>
</html>
